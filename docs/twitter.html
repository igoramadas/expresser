<!DOCTYPE html>

<html>
<head>
  <title>twitter.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>twitter.coffee</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="expresser.html">
                    expresser.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="app.html">
                    app.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="database.html">
                    database.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="firewall.html">
                    firewall.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="imaging.html">
                    imaging.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="logger.html">
                    logger.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="mail.html">
                    mail.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="settings.html">
                    settings.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="sockets.html">
                    sockets.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="twitter.html">
                    twitter.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="utils.html">
                    utils.coffee
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        <h2>EXPRESSER TWITTER</h2>

        
      
        
        <p>Handles communications with Twitter.
Parameters on <a href="settings.coffee">settings.html</a>: Settings.Twitter</p>

        
          <div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Twitter</span></span>

    lodash = require <span class="string">"lodash"</span>
    logger = require <span class="string">"./logger.coffee"</span>
    moment = require <span class="string">"moment"</span>
    settings = require <span class="string">"./settings.coffee"</span>
    twitter = require <span class="string">"ntwitter"</span></pre></div>
        
      
        
        <p>The twitter handler.</p>

        
          <div class='highlight'><pre>    twit = <span class="literal">null</span></pre></div>
        
      
        
        <p>Will be true only if it validates with the supplied the credentials.</p>

        
          <div class='highlight'><pre>    auth = <span class="literal">false</span></pre></div>
        
      
        
        <h2>INTERNAL FEATURES</h2>

        
      
        
        <p>Helper to authenticate on Twitter, with limited retries.</p>

        
          <div class='highlight'><pre>    <span class="function"><span class="title">authenticate</span></span> = (retry) -&gt;
        retry = <span class="number">0</span> <span class="keyword">if</span> <span class="keyword">not</span> retry?</pre></div>
        
      
        
        <p>Verify if credentials are valid and set the <code>auth</code> variable.</p>

        
          <div class='highlight'><pre>        twit.verifyCredentials (err, data) =&gt;</pre></div>
        
      
        
        <p>If fails, log and set a timeout to try again in a few seconds.</p>

        
          <div class='highlight'><pre>            <span class="keyword">if</span> err?
                logger.warn <span class="string">"Expresser"</span>, <span class="string">"Twitter.init"</span>, <span class="string">"Can't verify credentials."</span>, err
                auth = <span class="literal">false</span>
                setTimeout (() -&gt; authenticate retry + <span class="number">1</span>), settings.twitter.retryInterval * <span class="number">1000</span>
            <span class="keyword">else</span>
                logger.info <span class="string">"Expresser"</span>, <span class="string">"Twitter.init"</span>, <span class="string">"Authorized with ID <span class="subst">#{data.id}</span>."</span>
                auth = <span class="literal">true</span></pre></div>
        
      
        
        <p>Helper to check and log when the module hasn&#39;t authenticated or is not enabled.
This is called before any Twitter interaction.</p>

        
          <div class='highlight'><pre>    <span class="function"><span class="title">checkAuth</span></span> = (title, msg) -&gt;
        <span class="keyword">if</span> <span class="keyword">not</span> settings.twitter.enabled
            logger.warn <span class="string">"Expresser"</span>, title, <span class="string">"The Twitter module is not enabled!"</span>
            <span class="keyword">return</span> <span class="literal">false</span>
        <span class="keyword">if</span> <span class="keyword">not</span> auth
            logger.warn <span class="string">"Expresser"</span>, title, <span class="string">"Not authenticated!"</span>, msg
            <span class="keyword">return</span> <span class="literal">false</span></pre></div>
        
      
        
        <p>Enabled and authenticated, so return true.</p>

        
          <div class='highlight'><pre>        <span class="keyword">return</span> <span class="literal">true</span></pre></div>
        
      
        
        <h2>INIT</h2>

        
      
        
        <p>Init the Twitter handler, but only if the consumer and access keys were
properly set on the <a href="settings.html">settings</a>.</p>

        
          <div class='highlight'><pre>    init: =&gt;
        <span class="keyword">if</span> settings.twitter.enabled

            consumerOk = settings.twitter.consumerKey? <span class="keyword">and</span> settings.twitter.consumerSecret? <span class="keyword">and</span> settings.twitter.consumerSecret <span class="keyword">isnt</span> <span class="string">""</span>
            accessOk = settings.twitter.accessToken? <span class="keyword">and</span> settings.twitter.accessSecret? <span class="keyword">and</span> settings.twitter.accessSecret <span class="keyword">isnt</span> <span class="string">""</span>

            <span class="keyword">if</span> consumerOk <span class="keyword">and</span> accessOk
                keys =
                    consumer_key: settings.twitter.consumerKey,
                    consumer_secret: settings.twitter.consumerSecret,
                    access_token_key: settings.twitter.accessToken,
                    access_token_secret: settings.twitter.accessSecret</pre></div>
        
      
        
        <p>Create the ntwitter object.</p>

        
          <div class='highlight'><pre>                twit = <span class="keyword">new</span> twitter keys</pre></div>
        
      
        
        <p>Authenticate on Twitter.</p>

        
          <div class='highlight'><pre>                authenticate()

            <span class="keyword">else</span> <span class="keyword">if</span> settings.general.debug
                logger.warn <span class="string">"Expresser"</span>, <span class="string">"Twitter.init"</span>, <span class="string">"No credentials were set."</span>, <span class="string">"Twitter module won't work."</span></pre></div>
        
      
        
        <h2>STATUS</h2>

        
      
        
        <p>Post a status to the Twitter timeline. If a callback is passed,
it will get triggered with the corresponding status ID, or null if failed.</p>

        
          <div class='highlight'><pre>    postStatus: (message, callback) =&gt;
        <span class="keyword">if</span> <span class="keyword">not</span> checkAuth <span class="string">"Twitter.postStatus"</span>, <span class="string">"Will NOT post status to Twitter."</span>
            <span class="keyword">return</span></pre></div>
        
      
        
        <p>Update status on Twitter.</p>

        
          <div class='highlight'><pre>        twit.updateStatus message, (err, data) =&gt;
            <span class="keyword">if</span> err?
                logger.error <span class="string">"Expresser"</span>, <span class="string">"Twitter.postStatus"</span>, <span class="string">"Failed: <span class="subst">#{message}</span>"</span>, err
            <span class="keyword">else</span> <span class="keyword">if</span> settings.general.debug
                logger.info <span class="string">"Expresser"</span>, <span class="string">"Twitter.postStatus"</span>, <span class="string">"Posted, ID <span class="subst">#{data.id}</span>: <span class="subst">#{message}</span>"</span>
            callback err, data <span class="keyword">if</span> callback?</pre></div>
        
      
        
        <h2>MESSAGES</h2>

        
      
        
        <p>Send a direct message to the specified user on Twitter. If a <code>callback</code> is
specified, it will get triggered passing the sent message ID, or null if failed.</p>

        
          <div class='highlight'><pre>    sendMessage: (message, user, callback) =&gt;
        <span class="keyword">if</span> <span class="keyword">not</span> checkAuth <span class="string">"Twitter.sendMessage"</span>, <span class="string">"Will NOT send message to <span class="subst">#{user}</span>."</span>
            <span class="keyword">return</span></pre></div>
        
      
        
        <p>Send the message to the user.</p>

        
          <div class='highlight'><pre>        twit.sendDirectMessage {<span class="string">"screen_name"</span>: user, <span class="string">"text"</span>: message}, (err, data) =&gt;
            <span class="keyword">if</span> err?
                logger.error <span class="string">"Expresser"</span>, <span class="string">"Twitter.sendMessage"</span>, <span class="string">"Send to <span class="subst">#{user}</span> FAILED."</span>, message, err
            <span class="keyword">else</span> <span class="keyword">if</span> settings.general.debug
                logger.info <span class="string">"Expresser"</span>, <span class="string">"Twitter.sendMessage"</span>, <span class="string">"Sent to <span class="subst">#{user}</span>."</span>, message
            callback err, data <span class="keyword">if</span> callback?</pre></div>
        
      
        
        <p>Destroy the specified direct message. If a <code>callback</code> is specified, it will
get triggered passing true or false.</p>

        
          <div class='highlight'><pre>    destroyMessage: (id, callback) =&gt;
        <span class="keyword">if</span> <span class="keyword">not</span> checkAuth <span class="string">"Twitter.destroyMessage"</span>, <span class="string">"Will NOT destroy message <span class="subst">#{id}</span>."</span>
            <span class="keyword">return</span></pre></div>
        
      
        
        <p>Make a request to destroy the specified message.</p>

        
          <div class='highlight'><pre>        twit.destroyDirectMessage id, (err, data) =&gt;
            <span class="keyword">if</span> err?
                logger.error <span class="string">"Expresser"</span>, <span class="string">"Twitter.destroyMessage"</span>, <span class="string">"<span class="subst">#{id}</span> FAILED."</span>, err
            <span class="keyword">else</span> <span class="keyword">if</span> settings.general.debug
                logger.info <span class="string">"Expresser"</span>, <span class="string">"Twitter.destroyMessage"</span>, <span class="string">"<span class="subst">#{id}</span> SUCCESS."</span>
            callback err, data <span class="keyword">if</span> callback?</pre></div>
        
      
        
        <p>Returns a list of recent direct messages based on the optional <code>filter</code>, and process them
to generate new countdown models. A callback can be passed and will return an error
object (if any) and the messages result.</p>

        
          <div class='highlight'><pre>    getMessages: (filter, callback) =&gt;
        <span class="keyword">if</span> <span class="keyword">not</span> checkAuth <span class="string">"Twitter.getMessages"</span>, <span class="string">"Will NOT get recent messages."</span>
            <span class="keyword">return</span></pre></div>
        
      
        
        <p>If only one arguments is passed and it&#39;s a function, assume it&#39;s the callback.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> <span class="keyword">not</span> filter?
            filter = {}
        <span class="keyword">else</span> <span class="keyword">if</span> lodash.isFunction filter
            callback = filter</pre></div>
        
      
        
        <p>Make a request to get direct messages.</p>

        
          <div class='highlight'><pre>        twit.getDirectMessages filter, (err, data) =&gt;
            <span class="keyword">if</span> err?
                logger.error <span class="string">"Expresser"</span>, <span class="string">"Twitter.getMessages"</span>, <span class="string">"Could NOT retrieve direct messages."</span>, err
            <span class="keyword">else</span> <span class="keyword">if</span> settings.general.debug
                logger.info <span class="string">"Expresser"</span>, <span class="string">"Twitter.getMessages"</span>, <span class="string">"Retrieved <span class="subst">#{data.length}</span> messages."</span>
            callback err, data <span class="keyword">if</span> callback?</pre></div>
        
      
        
        <h2>Singleton implementation</h2>

        
      
        
        
        
          <div class='highlight'><pre>Twitter.<span class="function"><span class="title">getInstance</span></span> = -&gt;
    <span class="property">@instance</span> = <span class="keyword">new</span> Twitter() <span class="keyword">if</span> <span class="keyword">not</span> <span class="property">@instance</span>?
    <span class="keyword">return</span> <span class="property">@instance</span>

module.exports = exports = Twitter.getInstance()</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
