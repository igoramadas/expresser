<!DOCTYPE html>

<html>
<head>
  <title>s3.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>s3.coffee</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="lib.app.html">
                    app.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="lib.errors.html">
                    errors.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="lib.events.html">
                    events.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="lib.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="lib.logger.html">
                    logger.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="lib.settings.html">
                    settings.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="lib.utils.html">
                    utils.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.aws.dynamodb.html">
                    dynamodb.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.aws.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.aws.s3.html">
                    s3.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.aws.sns.html">
                    sns.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.cron.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.cron.job.html">
                    job.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.gcloud.datastore.html">
                    datastore.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.gcloud.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.gcloud.storage.html">
                    storage.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.logger-file.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.logger-logentries.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.logger-loggly.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.mailer.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.mailer.templates.html">
                    templates.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.metrics.httpserver.html">
                    httpserver.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.metrics.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.metrics.percentile.html">
                    percentile.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.mongodb.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.sockets.index.html">
                    index.coffee
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        <h2 id="aws-s3">AWS S3</h2>

        
      
        
        
        
          <div class='highlight'><pre>aws = <span class="hljs-built_in">require</span> <span class="hljs-string">"aws-sdk"</span>
fs = <span class="hljs-built_in">require</span> <span class="hljs-string">"fs"</span>
path = <span class="hljs-built_in">require</span> <span class="hljs-string">"path"</span>

errors = <span class="hljs-literal">null</span>
lodash = <span class="hljs-literal">null</span>
logger = <span class="hljs-literal">null</span>
settings = <span class="hljs-literal">null</span></pre></div>
        
      
        
        <p>##
Handles communication with AWS S3.</p>
<p>##</p>

        
          <div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">S3</span></span></pre></div>
        
      
        
        <h2 id="init">INIT</h2>

        
      
        
        
        
      
        
        <p>##
Init the AWS S3 module. Should be called automatically by the main AWS module.
@param {AWS} parent The AWS main module.
@private</p>
<p>##</p>

        
          <div class='highlight'><pre>    init: <span class="hljs-function"><span class="hljs-params">(parent)</span> =&gt;</span>
        errors = parent.expresser.errors
        lodash = parent.expresser.libs.lodash
        logger = parent.expresser.logger
        settings = parent.expresser.settings

        <span class="hljs-keyword">delete</span> @init</pre></div>
        
      
        
        <h2 id="methods">METHODS</h2>

        
      
        
        
        
      
        
        <p>##
Download a file from S3 and optionally save to the specified destination.
@param {Object} options Download options.
@param {String} [options.bucket] Name of the S3 bucket to download from.
@param {String} [options.key] Key of the target S3 bucket resource (usually a filename).
@param {String} [options.destination] Optional, full path to the destination where file should be saved.
@param {String} [options.region] The AWS region, if not passed will use default from settings.
@return {Object} The file contents as binary / buffer / string, depending on content type.
@promise</p>
<p>##</p>

        
          <div class='highlight'><pre>    download: <span class="hljs-function"><span class="hljs-params">(options)</span> =&gt;</span>
        logger.debug <span class="hljs-string">"AWS.S3.download"</span>, options

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Promise (resolve, reject) =&gt;</pre></div>
        
      
        
        <p>Accept uppercased parameters as well, like in the AWS SDK.</p>

        
          <div class='highlight'><pre>            options.bucket = options.Bucket <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.bucket?
            options.key = options.Key <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.key?

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.aws.enabled
                <span class="hljs-keyword">return</span> reject logger.notEnabled <span class="hljs-string">"AWS"</span></pre></div>
        
      
        
        <p>A bucket is mandatory.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.bucket? <span class="hljs-keyword">or</span> options.bucket <span class="hljs-keyword">is</span> <span class="hljs-string">""</span>
                err = errors.reject <span class="hljs-string">"A bucket is mandatory"</span>, <span class="hljs-string">"Please provide a valid options.bucket."</span>
                logger.error <span class="hljs-string">"AWS.S3.download"</span>, err
                <span class="hljs-keyword">return</span> reject err</pre></div>
        
      
        
        <p>A key is mandatory.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.key? <span class="hljs-keyword">or</span> options.key <span class="hljs-keyword">is</span> <span class="hljs-string">""</span>
                err = errors.reject <span class="hljs-string">"A key is mandatory"</span>, <span class="hljs-string">"Please provide a valid options.key."</span>
                logger.error <span class="hljs-string">"AWS.S3.download"</span>, err
                <span class="hljs-keyword">return</span> reject err

            <span class="hljs-keyword">try</span>
                s3 = <span class="hljs-keyword">new</span> aws.S3 {region: options.region <span class="hljs-keyword">or</span> settings.aws.s3.region}

                params = {
                    Bucket: options.bucket
                    Key: options.key
                }</pre></div>
        
      
        
        <p>First make sure the file exists in the S3 bucket, then fetch it.</p>

        
          <div class='highlight'><pre>                s3.headObject params, <span class="hljs-function"><span class="hljs-params">(err, meta)</span> -&gt;</span>
                    <span class="hljs-keyword">if</span> err?
                        logger.error <span class="hljs-string">"AWS.S3.download"</span>, <span class="hljs-string">"headObject"</span>, options.bucket, options.key, err</pre></div>
        
      
        
        <p>Hint for the user to login with the “mai” command.</p>

        
          <div class='highlight'><pre>                        <span class="hljs-keyword">if</span> err.statusCode <span class="hljs-keyword">is</span> <span class="hljs-number">401</span> <span class="hljs-keyword">or</span> err.statusCode <span class="hljs-keyword">is</span> <span class="hljs-number">403</span>
                            logger.warn <span class="hljs-string">"AWS.S3.download"</span>, <span class="hljs-string">"Invalid permissions or not authorized to read <span class="hljs-subst">#{options.bucket}</span> <span class="hljs-subst">#{options.key}</span>."</span>

                        <span class="hljs-keyword">return</span> reject err</pre></div>
        
      
        
        <p>Get data from S3 and write it to local disk.</p>

        
          <div class='highlight'><pre>                    s3.getObject params, <span class="hljs-function"><span class="hljs-params">(err, data)</span> -&gt;</span>
                        <span class="hljs-keyword">if</span> err?
                            logger.error <span class="hljs-string">"AWS.S3.download"</span>, <span class="hljs-string">"getObject"</span>, options.bucket, options.key, err
                            <span class="hljs-keyword">return</span> reject err

                        logger.debug <span class="hljs-string">"AWS.S3.download"</span>, <span class="hljs-string">"getObject"</span>, options.key, data.ContentType, <span class="hljs-string">"<span class="hljs-subst">#{data.ContentLength}</span> bytes"</span></pre></div>
        
      
        
        <p>Destination set? If so, write to disk.</p>

        
          <div class='highlight'><pre>                        <span class="hljs-keyword">if</span> options.destination?
                            fs.writeFile options.destination, data.Body, {encoding: settings.general.encoding}, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
                                <span class="hljs-keyword">if</span> err?
                                    err = errors.reject <span class="hljs-string">"cantSaveFile"</span>, err
                                    logger.error <span class="hljs-string">"AWS.S3.download"</span>, <span class="hljs-string">"writeFile"</span>, options.bucket, options.key, err
                                    <span class="hljs-keyword">return</span> reject err
                                <span class="hljs-keyword">else</span>
                                    logger.info <span class="hljs-string">"AWS.S3.download"</span>, <span class="hljs-string">"writeFile"</span>, options.bucket, options.key, data.ContentType, <span class="hljs-string">"<span class="hljs-subst">#{data.ContentLength}</span> bytes"</span>, options.destination
                                    <span class="hljs-keyword">return</span> resolve data.Body</pre></div>
        
      
        
        <p>No destination? Simply return the file contents.</p>

        
          <div class='highlight'><pre>                        <span class="hljs-keyword">else</span>
                            <span class="hljs-keyword">return</span> resolve data.Body
            <span class="hljs-keyword">catch</span> ex
                logger.error <span class="hljs-string">"AWS.S3.download"</span>, options, ex
                reject ex</pre></div>
        
      
        
        <p>##
Upload a file to S3.
@param {Object} options Upload options.
@param {String} [options.bucket] Name of the S3 bucket to upload to.
@param {String} [options.key] Key of the target S3 bucket resource (usually a filename).
@param {Object} [options.body] Contents of the file to be uploaded.
@param {String} [options.contentType] Content type of the file.
@param {String} [options.acl] ACL to be used, default is “public-read”.
@param {String} [options.region] The AWS region, if not passed will use default from settings.
@return {Object} The upload result.
@promise</p>
<p>##</p>

        
          <div class='highlight'><pre>    upload: <span class="hljs-function"><span class="hljs-params">(options)</span> =&gt;</span>
        logger.debug <span class="hljs-string">"AWS.S3.upload"</span>, options

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Promise (resolve, reject) =&gt;</pre></div>
        
      
        
        <p>Accept uppercased parameters as well, like in the AWS SDK.</p>

        
          <div class='highlight'><pre>            options.bucket = options.Bucket <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.bucket?
            options.key = options.Key <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.key?
            options.body = options.Body <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.body?
            options.contentType = options.ContentType <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.contentType?
            options.acl = options.ACL <span class="hljs-keyword">or</span> <span class="hljs-string">"public-read"</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.acl?

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.aws.enabled
                <span class="hljs-keyword">return</span> reject logger.notEnabled <span class="hljs-string">"AWS"</span></pre></div>
        
      
        
        <p>A bucket is mandatory.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.bucket? <span class="hljs-keyword">or</span> options.bucket <span class="hljs-keyword">is</span> <span class="hljs-string">""</span>
                err = errors.reject <span class="hljs-string">"A bucket is mandatory"</span>, <span class="hljs-string">"Please provide a valid options.bucket."</span>
                logger.error <span class="hljs-string">"AWS.S3.upload"</span>, err
                <span class="hljs-keyword">return</span> reject err</pre></div>
        
      
        
        <p>A key is mandatory.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.key? <span class="hljs-keyword">or</span> options.key <span class="hljs-keyword">is</span> <span class="hljs-string">""</span>
                err = errors.reject <span class="hljs-string">"A key is mandatory"</span>, <span class="hljs-string">"Please provide a valid options.key."</span>
                logger.error <span class="hljs-string">"AWS.S3.upload"</span>, err
                <span class="hljs-keyword">return</span> reject err

            <span class="hljs-keyword">try</span>
                s3Bucket = <span class="hljs-keyword">new</span> aws.S3 {region: options.region <span class="hljs-keyword">or</span> settings.aws.s3.region, params: {Bucket: options.bucket}}</pre></div>
        
      
        
        <p>Automagically discover the content type, if not set.</p>

        
          <div class='highlight'><pre>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.contentType?
                    ext = path.extname options.key
                    options.contentType = <span class="hljs-string">"image/jpeg"</span> <span class="hljs-keyword">if</span> ext <span class="hljs-keyword">is</span> <span class="hljs-string">".jpg"</span>
                    options.contentType = <span class="hljs-string">"image/gif"</span> <span class="hljs-keyword">if</span> ext <span class="hljs-keyword">is</span> <span class="hljs-string">".gif"</span>
                    options.contentType = <span class="hljs-string">"image/png"</span> <span class="hljs-keyword">if</span> ext <span class="hljs-keyword">is</span> <span class="hljs-string">".png"</span>
                    options.contentType = <span class="hljs-string">"image/bmp"</span> <span class="hljs-keyword">if</span> ext <span class="hljs-keyword">is</span> <span class="hljs-string">".bmp"</span>
                    options.contentType = <span class="hljs-string">"application/json"</span> <span class="hljs-keyword">if</span> ext <span class="hljs-keyword">is</span> <span class="hljs-string">".json"</span>
                    options.contentType = <span class="hljs-string">"text/css"</span> <span class="hljs-keyword">if</span> ext <span class="hljs-keyword">is</span> <span class="hljs-string">".css"</span>
                    options.contentType = <span class="hljs-string">"text/html"</span> <span class="hljs-keyword">if</span> ext <span class="hljs-keyword">is</span> <span class="hljs-string">".htm"</span> <span class="hljs-keyword">or</span> ext <span class="hljs-keyword">is</span> <span class="hljs-string">".html"</span>

                s3upload = s3Bucket.upload {
                    ACL: options.acl,
                    Body: options.body,
                    Key: options.key,
                    ContentType: options.contentType
                }</pre></div>
        
      
        
        <p>Upload the specified files!</p>

        
          <div class='highlight'><pre>                s3upload.send (err, result) -&gt;
                    <span class="hljs-keyword">if</span> err?
                        err = errors.reject <span class="hljs-string">"cantUploadFile"</span>, err
                        logger.error <span class="hljs-string">"AWS.S3.upload"</span>, options.bucket, options.key, options.contentType, err
                        reject err
                    <span class="hljs-keyword">else</span>
                        logger.info <span class="hljs-string">"AWS.S3.upload"</span>, options.bucket, options.key, options.contentType
                        resolve result
            <span class="hljs-keyword">catch</span> ex
                logger.error <span class="hljs-string">"AWS.S3.upload"</span>, options.bucket, options.key, options.contentType, ex
                reject ex</pre></div>
        
      
        
        <p>##
Delete object(s) from S3.
@param {Object} options Delete options.
@param {String} [options.bucket] Name of the S3 bucket to upload to.
@param {Array|String} [options.keys] Keys of items to be deleted from the bucket.
@param {String} [options.region] The AWS region, if not passed will use default from settings.
@return {Object} The delete result.
@promise</p>
<p>##</p>

        
          <div class='highlight'><pre>    delete: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
        logger.debug <span class="hljs-string">"AWS.S3.delete"</span>, options

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Promise (resolve, reject) =&gt;</pre></div>
        
      
        
        <p>Accept uppercased parameters as well, like in the AWS SDK.</p>

        
          <div class='highlight'><pre>            options.bucket = options.Bucket <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.bucket?
            options.keys = options.Keys <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.keys?</pre></div>
        
      
        
        <p>Accept a single key as well.</p>

        
          <div class='highlight'><pre>            options.keys = [options.key] <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.keys? <span class="hljs-keyword">and</span> options.key?
            options.keys = [options.keys] <span class="hljs-keyword">if</span> lodash.isString options.keys

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.aws.enabled
                <span class="hljs-keyword">return</span> reject logger.notEnabled <span class="hljs-string">"AWS"</span></pre></div>
        
      
        
        <p>A bucket is mandatory.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.bucket? <span class="hljs-keyword">or</span> options.bucket <span class="hljs-keyword">is</span> <span class="hljs-string">""</span>
                err = errors.reject <span class="hljs-string">"A bucket is mandatory"</span>, <span class="hljs-string">"Please provide a valid options.bucket."</span>
                logger.error <span class="hljs-string">"AWS.S3.delete"</span>, err
                <span class="hljs-keyword">return</span> reject err</pre></div>
        
      
        
        <p>Ate least 1 key to be deleted.</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">if</span> options.keys?.length &lt; <span class="hljs-number">1</span>
                err = errors.reject <span class="hljs-string">"At least 1 key must be provided"</span>, <span class="hljs-string">"Make sure options.keys has at least 1 key."</span>
                logger.error <span class="hljs-string">"AWS.S3.delete"</span>, err
                <span class="hljs-keyword">return</span> reject err

            <span class="hljs-keyword">try</span>
                s3Bucket = <span class="hljs-keyword">new</span> aws.S3 {region: options.region <span class="hljs-keyword">or</span> settings.aws.s3.region, params: {Bucket: options.bucket}}

                objects = []
                objects.push {Key: value} <span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> options.keys

                params = {
                    Delete: {
                        Objects: objects
                    }
                }</pre></div>
        
      
        
        <p>Delete the specified files!</p>

        
          <div class='highlight'><pre>                s3Bucket.deleteObjects params, <span class="hljs-function"><span class="hljs-params">(err, result)</span> =&gt;</span>
                    <span class="hljs-keyword">if</span> err?
                        err = errors.reject <span class="hljs-string">"cantDeleteFile"</span>, err
                        logger.error <span class="hljs-string">"AWS.S3.delete"</span>, options.bucket, options.keys, err
                        reject err
                    <span class="hljs-keyword">else</span>
                        logger.info <span class="hljs-string">"AWS.S3.delete"</span>, options.bucket, options.keys
                        resolve result
            <span class="hljs-keyword">catch</span> ex
                logger.error <span class="hljs-string">"AWS.S3.delete"</span>, options.bucket, options.keys, ex
                reject ex</pre></div>
        
      
        
        <h2 id="singleton-implementation">Singleton implementation</h2>

        
      
        
        
        
          <div class='highlight'><pre>S3.getInstance = <span class="hljs-function">-&gt;</span>
    @instance = <span class="hljs-keyword">new</span> S3() <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @instance?
    <span class="hljs-keyword">return</span> @instance

<span class="hljs-built_in">module</span>.exports = S3.getInstance()</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
