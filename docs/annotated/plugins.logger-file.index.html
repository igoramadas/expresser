<!DOCTYPE html>

<html>
<head>
  <title>index.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>index.coffee</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="lib.app.html">
                    app.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="lib.errors.html">
                    errors.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="lib.events.html">
                    events.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="lib.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="lib.logger.html">
                    logger.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="lib.settings.html">
                    settings.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="lib.utils.html">
                    utils.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.aws.dynamodb.html">
                    dynamodb.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.aws.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.aws.s3.html">
                    s3.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.aws.sns.html">
                    sns.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.cron.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.cron.job.html">
                    job.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.gcloud.datastore.html">
                    datastore.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.gcloud.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.gcloud.storage.html">
                    storage.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.logger-file.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.logger-logentries.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.logger-loggly.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.mailer.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.mailer.templates.html">
                    templates.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.metrics.httpserver.html">
                    httpserver.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.metrics.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.metrics.percentile.html">
                    percentile.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.mongodb.index.html">
                    index.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="plugins.sockets.index.html">
                    index.coffee
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        <h2 id="expresser-logger-file">EXPRESSER LOGGER - FILE</h2>

        
      
        
        
        
          <div class='highlight'><pre>fs = <span class="hljs-built_in">require</span> <span class="hljs-string">"fs"</span>
path = <span class="hljs-built_in">require</span> <span class="hljs-string">"path"</span>

errors = <span class="hljs-literal">null</span>
events = <span class="hljs-literal">null</span>
lodash = <span class="hljs-literal">null</span>
logger = <span class="hljs-literal">null</span>
moment = <span class="hljs-literal">null</span>
settings = <span class="hljs-literal">null</span></pre></div>
        
      
        
        <p>##
File logging plugin for Expresser. Supports saving directly to the disk
using one file per log type per day, and includes auto cleaning features.</p>
<p>##</p>

        
          <div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoggerFile</span></span>
    priority: <span class="hljs-number">1</span></pre></div>
        
      
        
        <h2 id="init">INIT</h2>

        
      
        
        
        
      
        
        <p>##
Init the File logging module. If default settings are defined on “settings.logger.file”,
it will auto register itself to the main Logger as “file”. Please note that this init
should be called automatically by the main Expresser <code>init()</code>.
@private</p>
<p>##</p>

        
          <div class='highlight'><pre>    init: <span class="hljs-function">=&gt;</span>
        errors = @expresser.errors
        events = @expresser.events
        lodash = @expresser.libs.lodash
        logger = @expresser.logger
        moment = @expresser.libs.moment
        settings = @expresser.settings

        logger.drivers.file = <span class="hljs-keyword">this</span>

        logger.debug <span class="hljs-string">"LoggerFile.init"</span></pre></div>
        
      
        
        <p>Auto register as “file” if a default path is defined on the settings.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> settings.logger.file.enabled <span class="hljs-keyword">and</span> settings.logger.file.path?
            logger.register <span class="hljs-string">"file"</span>, <span class="hljs-string">"file"</span>, settings.logger.file

        events.emit <span class="hljs-string">"LoggerFile.on.init"</span>
        <span class="hljs-keyword">delete</span> @init</pre></div>
        
      
        
        <p>##
Get the File transport object.
@param {Object} options File logging options.
@param {String} [options.path] Path where log files should be saved, mandatory.
@param {Function} [options.onLogSuccess] Function to execute on successful log calls, optional.
@param {Function} [options.onLogError] Function to execute on failed log calls, optional.
@return {Object} The File logger transport.</p>
<p>##</p>

        
          <div class='highlight'><pre>    getTransport: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
        logger.debug <span class="hljs-string">"LoggerFile.getTransport"</span>, options

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.logger.file.enabled
            <span class="hljs-keyword">return</span> logger.notEnabled <span class="hljs-string">"LoggerFile"</span>

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options?.path? <span class="hljs-keyword">or</span> options.path <span class="hljs-keyword">is</span> <span class="hljs-string">""</span>
            <span class="hljs-keyword">return</span> errors.<span class="hljs-keyword">throw</span> pathRequired, <span class="hljs-string">"Please set a valid options.path."</span>

        options = lodash.defaultsDeep options, settings.logger.file
        options.onLogSuccess = logger.onLogSuccess <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.onLogSuccess?
        options.onLogError = logger.onLogError <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.onLogError?</pre></div>
        
      
        
        <p>Create logs folder if it doesn’t exist.</p>

        
          <div class='highlight'><pre>        folderExists = fs.existsSync options.path</pre></div>
        
      
        
        <p>Make sure the log folder exists.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> folderExists
            fs.mkdirSync options.path
            <span class="hljs-keyword">if</span> settings.general.debug
                <span class="hljs-built_in">console</span>.log <span class="hljs-string">"LoggerFile.getTransport"</span>, <span class="hljs-string">"Created <span class="hljs-subst">#{options.path}</span> folder."</span></pre></div>
        
      
        
        <p>Set local buffer.</p>

        
          <div class='highlight'><pre>        transport = {flushing: <span class="hljs-literal">false</span>, buffer: {}, flush: @flush, clean: @clean}
        transport.onLogSuccess = options.onLogSuccess
        transport.onLogError = options.onLogError
        transport.timerFlush = setInterval transport.flush, options.bufferInterval</pre></div>
        
      
        
        <p>Check the maxAge of local logs and set up auto clean.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> options.maxAge? <span class="hljs-keyword">and</span> options.maxAge &gt; <span class="hljs-number">0</span>
            transport.timerClean = setInterval transport.clean, options.bufferInterval * <span class="hljs-number">20</span>

        <span class="hljs-keyword">return</span> transport</pre></div>
        
      
        
        <h2 id="log-methods">LOG METHODS</h2>

        
      
        
        
        
      
        
        <p>##
Log locally. The path is defined on <code>settings.logger.file.path</code>.
@param {String} logType The log type (info, warn, error, debug, etc).
@param {Array} args Array or string to be logged.
@param {Boolean} avoidConsole If true it will NOT log to the console.</p>
<p>##</p>

        
          <div class='highlight'><pre>    log: <span class="hljs-function"><span class="hljs-params">(logType, args, avoidConsole)</span> -&gt;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> settings.logger.levels.indexOf(logType) &lt; <span class="hljs-number">0</span></pre></div>
        
      
        
        <p>Get message out of the arguments if not a string.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> lodash.isString args
            message = args
        <span class="hljs-keyword">else</span>
            message = logger.getMessage args</pre></div>
        
      
        
        <p>Set log props and send to buffer.</p>

        
          <div class='highlight'><pre>        now = moment()
        message = now.format(<span class="hljs-string">"HH:mm:ss.SSS"</span>) + <span class="hljs-string">" - "</span> + message

        @buffer[logType] = [] <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @buffer[logType]?
        @buffer[logType].push message</pre></div>
        
      
        
        <p>Log to the console depending on <code>console</code> setting.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> settings.logger.<span class="hljs-built_in">console</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> avoidConsole
            logger.<span class="hljs-built_in">console</span> logType, args</pre></div>
        
      
        
        <h2 id="persistence">PERSISTENCE</h2>

        
      
        
        
        
      
        
        <p>##
Flush all local buffered log messages to disk. This is automatically called
by the <code>bufferDispatcher</code> timer but you can also trigger it manually.</p>
<p>##</p>

        
          <div class='highlight'><pre>    flush: <span class="hljs-function">-&gt;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> @flushing</pre></div>
        
      
        
        <p>Set flushing and get current date.</p>

        
          <div class='highlight'><pre>        @flushing = <span class="hljs-literal">true</span>
        now = moment()
        date = now.format settings.logger.file.dateFormat</pre></div>
        
      
        
        <p>Flush all buffered logs to disk. Please note that messages from the last seconds of the previous day
can be saved to the current day depending on how long it takes for the bufferDispatcher to run.
Default is every 10 seconds, so messages from 23:59:50 onwards could be saved on the next day.</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">try</span>
            <span class="hljs-keyword">for</span> key, logs <span class="hljs-keyword">of</span> @buffer
                <span class="hljs-keyword">if</span> logs.length &gt; <span class="hljs-number">0</span>
                    writeData = logs.join <span class="hljs-string">"\n"</span>
                    filePath = path.join settings.logger.file.path, <span class="hljs-string">"<span class="hljs-subst">#{date}</span>.<span class="hljs-subst">#{key}</span>.log"</span>
                    successMsg = <span class="hljs-string">"<span class="hljs-subst">#{logs.length}</span> records logged to disk."</span></pre></div>
        
      
        
        <p>Reset this local buffer.</p>

        
          <div class='highlight'><pre>                    @buffer[key] = []</pre></div>
        
      
        
        <p>Only use <code>appendFile</code> on new versions of Node.</p>

        
          <div class='highlight'><pre>                    <span class="hljs-keyword">if</span> fs.appendFile?
                        fs.appendFile filePath, <span class="hljs-string">"\n"</span> + writeData, <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
                            @flushing = <span class="hljs-literal">false</span>

                            <span class="hljs-keyword">if</span> err?
                                <span class="hljs-built_in">console</span>.error <span class="hljs-string">"LoggerFile.flush"</span>, err
                                @onLogError? err
                            <span class="hljs-keyword">else</span>
                                @onLogSuccess? successMsg

                            events.emit <span class="hljs-string">"LoggerFile.on.flush"</span>, <span class="hljs-keyword">this</span>
        <span class="hljs-keyword">catch</span> ex
            <span class="hljs-built_in">console</span>.error <span class="hljs-string">"LoggerFile.flush"</span>, ex</pre></div>
        
      
        
        <p>##
Delete old log files from disk.
@param {Number} maxAge Max age of logs, in days, default is defined on settings.</p>
<p>##</p>

        
          <div class='highlight'><pre>    clean: <span class="hljs-function"><span class="hljs-params">(maxAge)</span> -&gt;</span>
        maxAge = settings.logger.file.maxAge <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> maxAge?
        maxDate = moment().subtract maxAge, <span class="hljs-string">"d"</span>

        <span class="hljs-keyword">try</span>
            fs.readdir settings.logger.file.path, <span class="hljs-function"><span class="hljs-params">(err, files)</span> =&gt;</span>
                <span class="hljs-keyword">if</span> err?
                    <span class="hljs-built_in">console</span>.error <span class="hljs-string">"LoggerFile.clean"</span>, err
                <span class="hljs-keyword">else</span>
                    <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files
                        date = moment f.split(<span class="hljs-string">"."</span>)[<span class="hljs-number">0</span>], settings.logger.file.dateFormat
                        <span class="hljs-keyword">if</span> date.isSameOrBefore maxDate
                            fs.unlinkSync path.join(settings.logger.file.path, f)

                    events.emit <span class="hljs-string">"LoggerFile.on.clean"</span>, <span class="hljs-keyword">this</span>, maxAge
        <span class="hljs-keyword">catch</span> ex
            <span class="hljs-built_in">console</span>.error <span class="hljs-string">"LoggerFile.clean"</span>, ex</pre></div>
        
      
        
        <h2 id="singleton-implementation">Singleton implementation</h2>

        
      
        
        
        
          <div class='highlight'><pre>LoggerFile.getInstance = <span class="hljs-function">-&gt;</span>
    @instance = <span class="hljs-keyword">new</span> LoggerFile() <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @instance?
    <span class="hljs-keyword">return</span> @instance

<span class="hljs-built_in">module</span>.exports = exports = LoggerFile.getInstance()</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
