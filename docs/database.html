<!DOCTYPE html>

<html>
<head>
  <title>database.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>database.coffee</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="expresser.html">
                    expresser.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="app.html">
                    app.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="database.html">
                    database.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="downloader.html">
                    downloader.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="firewall.html">
                    firewall.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="imaging.html">
                    imaging.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="logger.html">
                    logger.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="mail.html">
                    mail.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="settings.html">
                    settings.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="sockets.html">
                    sockets.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="twitter.html">
                    twitter.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="utils.html">
                    utils.coffee
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        <h2>EXPRESSER DATABASE</h2>

        
      
        
        <p>Handle the MongoDB database interactions on the app.
Parameters on <a href="settings.coffee">settings.html</a>: Settings.Database</p>

        
          <div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Database</span></span>

    lodash = require <span class="string">"lodash"</span>
    logger = require <span class="string">"./logger.coffee"</span>
    settings = require <span class="string">"./settings.coffee"</span>
    mongo = require <span class="string">"mongoskin"</span></pre></div>
        
      
        
        <p>Database object, will be set during <code>init</code>.</p>

        
          <div class='highlight'><pre>    db: <span class="literal">null</span></pre></div>
        
      
        
        <p>Callback triggered when a connection is validated successfully.</p>

        
          <div class='highlight'><pre>    onConnectionValidated: <span class="literal">null</span></pre></div>
        
      
        
        <p>When using the failover/secondary databse, <code>failover</code> will be set to true.</p>

        
          <div class='highlight'><pre>    failover: <span class="literal">false</span></pre></div>
        
      
        
        <h2>INTERNAL FEATURES</h2>

        
      
        
        <p>Helper method to check the DB connection. If connection fails multiple times in a row,
switch to the failover DB (specified on the <code>Database.connString2</code> setting).
You can customize these values on the <code>Database</code> <a href="settings.html">settings</a>.</p>

        
          <div class='highlight'><pre>    validateConnection: (retry) =&gt;
        retry = <span class="number">0</span> <span class="keyword">if</span> <span class="keyword">not</span> retry?</pre></div>
        
      
        
        <p>If connection has failed repeatedly for more than 3 times the <code>maxRetries</code> value then
stop trying and log an error.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> retry &gt; settings.database.maxRetries * <span class="number">3</span>
            logger.error <span class="string">"Expresser"</span>, <span class="string">"Database.validateConnection"</span>, <span class="string">"Connection failed <span class="subst">#{retry}</span> times."</span>, <span class="string">"Abort!"</span>
            <span class="keyword">return</span></pre></div>
        
      
        
        <p>First try, use main database.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> retry &lt; <span class="number">1</span>
            <span class="property">@db</span> = mongo.db settings.database.connString, settings.database.options
            <span class="property">@failover</span> = <span class="literal">false</span></pre></div>
        
      
        
        <p>Reached max retries? Try connecting to the failover database, if there&#39;s one specified.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> retry <span class="keyword">is</span> settings.database.maxRetries
            <span class="keyword">if</span> settings.database.connString2? <span class="keyword">and</span> settings.database.connString2 <span class="keyword">isnt</span> <span class="string">""</span>
                <span class="property">@failover</span> = <span class="literal">true</span>
                <span class="property">@db</span> = mongo.db settings.database.connString2, settings.database.options
                logger.info <span class="string">"Expresser"</span>, <span class="string">"Database.validateConnection"</span>, <span class="string">"Connection failed <span class="subst">#{retry}</span> times."</span>, <span class="string">"Switched to failover DB."</span>
            <span class="keyword">else</span>
                logger.error <span class="string">"Expresser"</span>, <span class="string">"Database.validateConnection"</span>, <span class="string">"Connection failed <span class="subst">#{retry}</span> times."</span>, <span class="string">"No failover DB set, keep trying."</span></pre></div>
        
      
        
        <p>Try to connect to the current database. If it fails, try again in a few seconds.</p>

        
          <div class='highlight'><pre>        <span class="property">@db</span>.open (err, result) =&gt;

            <span class="keyword">if</span> err?
                <span class="keyword">if</span> settings.general.debug
                    logger.warn <span class="string">"Expresser"</span>, <span class="string">"Database.validateConnection"</span>, <span class="string">"Failed to connect."</span>, <span class="string">"Retry <span class="subst">#{retry}</span>."</span>
                setTimeout (() =&gt; <span class="property">@validateConnection</span> retry + <span class="number">1</span>), settings.database.retryInterval

            <span class="keyword">else</span>
                <span class="property">@onConnectionValidated</span> result <span class="keyword">if</span> <span class="property">@onConnectionValidated</span>?</pre></div>
        
      
        
        <p>If using the failover database, register a timeout to try
to connect to the main database again.</p>

        
          <div class='highlight'><pre>                setTimeout <span class="property">@validateConnection</span>, settings.database.failoverTimeout * <span class="number">1000</span></pre></div>
        
      
        
        <p>Debug if necessary.</p>

        
          <div class='highlight'><pre>                <span class="keyword">if</span> settings.general.debug
                    <span class="keyword">if</span> <span class="property">@failover</span>
                        logger.info <span class="string">"Expresser"</span>, <span class="string">"Database.validateConnection"</span>, <span class="string">"Connected to failover DB."</span>, <span class="string">"Will try main DB again in <span class="subst">#{settings.database.failoverTimeout}</span> settings."</span>
                    <span class="keyword">else</span>
                        logger.info <span class="string">"Expresser"</span>, <span class="string">"Database.validateConnection"</span>, <span class="string">"Connected to main DB."</span></pre></div>
        
      
        
        <h2>INIT</h2>

        
      
        
        <p>Init the databse by testing the connection.</p>

        
          <div class='highlight'><pre>    init: =&gt;
        <span class="keyword">if</span> settings.database.connString? <span class="keyword">and</span> settings.database.connString <span class="keyword">isnt</span> <span class="string">""</span>
            <span class="property">@validateConnection</span>()
        <span class="keyword">else</span> <span class="keyword">if</span> settings.general.debug
            logger.warn <span class="string">"Expresser"</span>, <span class="string">"Database.init"</span>, <span class="string">"No connection string set."</span>, <span class="string">"Database module won't work."</span></pre></div>
        
      
        
        <h2>LOW LEVEL IMPLEMENTATION</h2>

        
      
        
        <p>Get data from the database. A <code>collection</code> and <code>callback</code> must be specified. The <code>filter</code> is optional.
Please note that if filter has an _id or id field, or if it&#39;s a plain string or number, it will be used
to return documents by ID. Otherwise it&#39;s used as keys-values object for filtering.</p>

        
          <div class='highlight'><pre>    get: (collection, filter, callback) =&gt;
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="property">@db</span>?
            logger.warn <span class="string">"Expresser"</span>, <span class="string">"Database.get"</span>, <span class="string">"The db is null / was not initialized. Abort!"</span>
            <span class="keyword">return</span></pre></div>
        
      
        
        <p>Check if only collection and callback were passed.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> <span class="keyword">not</span> callback <span class="keyword">and</span> lodash.isFunction filter
            callback = filter</pre></div>
        
      
        
        <p>Callback is mandatory!</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> <span class="keyword">not</span> callback?
            logger.warn <span class="string">"Expresser"</span>, <span class="string">"Database.get"</span>, <span class="string">"No callback specified. Abort!"</span>, collection, options
            <span class="keyword">return</span></pre></div>
        
      
        
        <p>Create the DB callback helper.</p>

        
          <div class='highlight'><pre>        <span class="function"><span class="title">dbCallback</span></span> = (err, result) =&gt;
            <span class="keyword">if</span> callback?
                result = <span class="property">@normalizeId</span>(result) <span class="keyword">if</span> settings.database.normalizeId
                callback err, result</pre></div>
        
      
        
        <p>Set collection object.</p>

        
          <div class='highlight'><pre>        dbCollection = <span class="property">@db</span>.collection collection</pre></div>
        
      
        
        <p>Parse ID depending on <code>filter</code>.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> filter?
            <span class="keyword">if</span> filter._id?
                id = filter._id
            <span class="keyword">else</span> <span class="keyword">if</span> filter.id? <span class="keyword">and</span> settings.database.normalizeId
                id = filter.id
            <span class="keyword">else</span>
                t = <span class="keyword">typeof</span> filter
                id = filter <span class="keyword">if</span> t <span class="keyword">is</span> <span class="string">"string"</span> <span class="keyword">or</span> t <span class="keyword">is</span> <span class="string">"integer"</span></pre></div>
        
      
        
        <p>Find documents depending on the parsed <code>filter</code>.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> id?
            dbCollection.findById id, dbCallback
        <span class="keyword">else</span> <span class="keyword">if</span> options?
             dbCollection.find(filter).toArray dbCallback
        <span class="keyword">else</span>
            dbCollection.find().toArray dbCallback</pre></div>
        
      
        
        <p>Log if debug is true.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> settings.general.debug
            <span class="keyword">if</span> filter?
                logger.info <span class="string">"Expresser"</span>, <span class="string">"Database.get"</span>, collection, filter
            <span class="keyword">else</span>
                logger.info <span class="string">"Expresser"</span>, <span class="string">"Database.get"</span>, collection, <span class="string">"No filter."</span></pre></div>
        
      
        
        <p>Insert or update an object on the database.</p>

        
          <div class='highlight'><pre>    set: (collection, obj, options, callback) =&gt;
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="property">@db</span>?
            logger.warn <span class="string">"Expresser"</span>, <span class="string">"Database.set"</span>, <span class="string">"The db is null / was not initialized. Abort!"</span>
            <span class="keyword">return</span></pre></div>
        
      
        
        <p>Obj is mandatory!</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> <span class="keyword">not</span> obj?
            msg = <span class="string">"The obj argument is null or empty."</span>
            callback msg, <span class="literal">null</span>
            logger.warn <span class="string">"Expresser"</span>, <span class="string">"Database.set"</span>, msg
            <span class="keyword">return</span></pre></div>
        
      
        
        <p>Check if callback was passed as options.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> <span class="keyword">not</span> callback? <span class="keyword">and</span> lodash.isFunction options
            callback = options</pre></div>
        
      
        
        <p>Create the DB callback helper.</p>

        
          <div class='highlight'><pre>        <span class="function"><span class="title">dbCallback</span></span> = (err, result) =&gt;
            <span class="keyword">if</span> callback?
                result = <span class="property">@normalizeId</span>(result) <span class="keyword">if</span> settings.database.normalizeId
                callback err, result</pre></div>
        
      
        
        <p>Set collection object.</p>

        
          <div class='highlight'><pre>        dbCollection = <span class="property">@db</span>.collection collection</pre></div>
        
      
        
        <p>Make sure the ID is converted to ObjectID.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> obj._id?
            id = mongo.ObjectID.createFromHexString obj._id.toString()
        <span class="keyword">else</span> <span class="keyword">if</span> obj.id? <span class="keyword">and</span> settings.database.normalizeId
            id = mongo.ObjectID.createFromHexString obj.id.toString()</pre></div>
        
      
        
        <p>If options patch is set, replace specified document properties only instead of replacing the whole document.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> options?.patch
            dbCollection.findAndModify {<span class="string">"_id"</span>: id}, {<span class="string">"sort"</span>: <span class="string">"_id"</span>}, {$set: obj}, {<span class="string">"new"</span>: <span class="literal">true</span>}, dbCallback
        <span class="keyword">else</span>
            dbCollection.findAndModify {<span class="string">"_id"</span>: id}, {<span class="string">"sort"</span>: <span class="string">"_id"</span>}, obj, {<span class="string">"new"</span>: <span class="literal">true</span>, <span class="string">"upsert"</span>: <span class="literal">true</span>}, dbCallback</pre></div>
        
      
        
        <p>Log if debug is true.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> settings.general.debug
            <span class="keyword">if</span> id?
                logger.info <span class="string">"Expresser"</span>, <span class="string">"Database.set"</span>, collection, <span class="string">"ID: <span class="subst">#{id}</span>"</span>
            <span class="keyword">else</span>
                logger.info <span class="string">"Expresser"</span>, <span class="string">"Database.set"</span>, collection, <span class="string">"New document."</span></pre></div>
        
      
        
        <p>Delete an object from the database. The <code>obj</code> argument can be either the object
itself, or its integer/string ID.</p>

        
          <div class='highlight'><pre>    del: (collection, filter, callback) =&gt;
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="property">@db</span>?
            logger.warn <span class="string">"Expresser"</span>, <span class="string">"Database.del"</span>, <span class="string">"The db is null / was not initialized. Abort!"</span>
            <span class="keyword">return</span>

        <span class="keyword">if</span> <span class="keyword">not</span> filter?
            msg = <span class="string">"The filter argument is null or empty."</span>
            callback msg, <span class="literal">null</span>
            logger.warn <span class="string">"Expresser"</span>, <span class="string">"Database.del"</span>, msg
            <span class="keyword">return</span></pre></div>
        
      
        
        <p>Check it the <code>obj</code> is the model itself, or only the ID string / number.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> filter._id?
            id = filter._id
        <span class="keyword">else</span> <span class="keyword">if</span> filter.id <span class="keyword">and</span> settings.database.normalizeId
            id = filter.id
        <span class="keyword">else</span>
            t = <span class="keyword">typeof</span> filter
            id = filter <span class="keyword">if</span> t <span class="keyword">is</span> <span class="string">"string"</span> <span class="keyword">or</span> t <span class="keyword">is</span> <span class="string">"integer"</span></pre></div>
        
      
        
        <p>Create the DB callback helper.</p>

        
          <div class='highlight'><pre>        <span class="function"><span class="title">dbCallback</span></span> = (err, result) =&gt;
            <span class="keyword">if</span> callback?
                result = <span class="property">@normalizeId</span>(result) <span class="keyword">if</span> settings.database.normalizeId
                callback err, result</pre></div>
        
      
        
        <p>Set collection object and remove specified document from the database.</p>

        
          <div class='highlight'><pre>        dbCollection = <span class="property">@db</span>.collection collection</pre></div>
        
      
        
        <p>Remove document by ID or filter.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> id? <span class="keyword">and</span> id <span class="keyword">isnt</span> <span class="string">""</span>
            dbCollection.removeById id, dbCallback
        <span class="keyword">else</span>
            dbCollection.remove filter, dbCallback</pre></div>
        
      
        
        <p>Log if debug is true.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> settings.general.debug
            logger.warn <span class="string">"Expresser"</span>, <span class="string">"Database.del"</span>, collection, filter</pre></div>
        
      
        
        <p>Count data from the database. A <code>collection</code> must be specified.
If no <code>filter</code> is passed (null or undefined) then count all documents.
The <code>callback</code> is mandatory.</p>

        
          <div class='highlight'><pre>    count: (collection, filter, callback) =&gt;
        <span class="keyword">if</span> <span class="keyword">not</span> callback?
            logger.warn <span class="string">"Expresser"</span>, <span class="string">"Database.count"</span>, <span class="string">"No callback specified. Abort!"</span>, collection, options
            <span class="keyword">return</span></pre></div>
        
      
        
        <p>Check if callback was passed as options.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> <span class="keyword">not</span> callback? <span class="keyword">and</span> lodash.isFunction filter
            callback = filter
            filter = {}</pre></div>
        
      
        
        <p>Create the DB callback helper.</p>

        
          <div class='highlight'><pre>        <span class="function"><span class="title">dbCallback</span></span> = (err, result) =&gt;
            <span class="keyword">if</span> callback?
                callback err, result
                <span class="keyword">if</span> settings.general.debug
                    logger.info <span class="string">"Expresser"</span>, <span class="string">"Database.count"</span>, collection, filter, <span class="string">"Result <span class="subst">#{result}</span>"</span></pre></div>
        
      
        
        <p>MongoDB has a built-in count so use it.</p>

        
          <div class='highlight'><pre>        dbCollection = <span class="property">@db</span>.collection collection
        dbCollection.count filter, dbCallback</pre></div>
        
      
        
        <h2>HELPER METHODS</h2>

        
      
        
        <p>Helper to transform MongoDB document &quot;_id&quot; to &quot;id&quot;.</p>

        
          <div class='highlight'><pre>    normalizeId: (result) =&gt;
        <span class="keyword">return</span> <span class="keyword">if</span> <span class="keyword">not</span> result?

        isArray = lodash.isArray result <span class="keyword">or</span> lodash.isArguments result</pre></div>
        
      
        
        <p>Check if result is a collection / array or a single document.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> isArray
            <span class="keyword">for</span> obj <span class="keyword">in</span> result
                obj[<span class="string">"id"</span>] = obj[<span class="string">"_id"</span>].toString()
                <span class="keyword">delete</span> obj[<span class="string">"_id"</span>]
        <span class="keyword">else</span>
            result[<span class="string">"id"</span>] = result[<span class="string">"_id"</span>].toString()
            <span class="keyword">delete</span> result[<span class="string">"_id"</span>]

        <span class="keyword">return</span> result</pre></div>
        
      
        
        <h2>Singleton implementation.</h2>

        
      
        
        
        
          <div class='highlight'><pre>Database.<span class="function"><span class="title">getInstance</span></span> = -&gt;
    <span class="property">@instance</span> = <span class="keyword">new</span> Database() <span class="keyword">if</span> <span class="keyword">not</span> <span class="property">@instance</span>?
    <span class="keyword">return</span> <span class="property">@instance</span>

module.exports = exports = Database.getInstance()</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
