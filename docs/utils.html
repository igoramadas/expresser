<!DOCTYPE html>

<html>
<head>
  <title>utils.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>utils.coffee</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="expresser.html">
                    expresser.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="app.html">
                    app.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="database.html">
                    database.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="firewall.html">
                    firewall.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="imaging.html">
                    imaging.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="logger.html">
                    logger.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="mail.html">
                    mail.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="settings.html">
                    settings.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="sockets.html">
                    sockets.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="twitter.html">
                    twitter.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="utils.html">
                    utils.coffee
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        <h2>EXPRESSER UTILS</h2>

        
      
        
        <p>General network, IO, client and server utilities.</p>

        
          <div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Utils</span></span>

    fs = require <span class="string">"fs"</span>
    moment = require <span class="string">"moment"</span>
    os = require <span class="string">"os"</span>
    path = require <span class="string">"path"</span>
    settings = require <span class="string">"./settings.coffee"</span></pre></div>
        
      
        
        <h2>SETTINGS UTILS</h2>

        
      
        
        <p>Helper to load values from the specified settings.json file. If no <code>filename</code> is passed,
it will try loading a <code>settings.json</code> file from the local folder, then the root folder.</p>

        
          <div class='highlight'><pre>    loadSettingsFromJson: (filename) =&gt;
        <span class="keyword">if</span> <span class="keyword">not</span> filename? <span class="keyword">or</span> filename <span class="keyword">is</span> <span class="string">""</span>
            filename =  path.dirname(require.main.filename) + <span class="string">"/settings.json"</span>
            loadDefault = <span class="literal">true</span>
        <span class="keyword">else</span>
            loadDefault = <span class="literal">false</span></pre></div>
        
      
        
        <p>Check if file exists.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> fs.existsSync?
            hasJson = fs.existsSync filename
        <span class="keyword">else</span>
            hasJson = path.existsSync filename</pre></div>
        
      
        
        <p>If <code>settings.json</code> does not exist on root, try on local path.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> <span class="keyword">not</span> hasJson <span class="keyword">and</span> loadDefault
            filename = __dirname + <span class="string">"/settings.json"</span>

            <span class="keyword">if</span> fs.existsSync?
                hasJson = fs.existsSync filename
            <span class="keyword">else</span>
                hasJson = path.existsSync filename</pre></div>
        
      
        
        <p>Has json? Load it.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> hasJson
            settingsJson = fs.readFileSync filename, {encoding: <span class="string">"utf8"</span>}
            settingsJson = <span class="property">@minifyJson</span> settingsJson
            settingsJson = JSON.parse settingsJson</pre></div>
        
      
        
        <p>Helper function to overwrite settings.</p>

        
          <div class='highlight'><pre>            <span class="function"><span class="title">xtend</span></span> = (source, target) -&gt;
                <span class="keyword">for</span> prop, value <span class="keyword">of</span> source
                    <span class="keyword">if</span> value?.constructor <span class="keyword">is</span> Object
                        target[prop] = {} <span class="keyword">if</span> <span class="keyword">not</span> target[prop]?
                        xtend source[prop], target[prop]
                    <span class="keyword">else</span>
                        target[prop] = source[prop]

            xtend settingsJson, settings</pre></div>
        
      
        
        <p>Update settings based on Cloud Environmental variables.</p>

        
          <div class='highlight'><pre>    updateSettingsFromPaaS: =&gt;
        env = process.env</pre></div>
        
      
        
        <p>Temporary variables with current values.</p>

        
          <div class='highlight'><pre>        currentSmtpHost = settings.mail.smtp.host?.toLowerCase()</pre></div>
        
      
        
        <p>Check for web (IP and port) variables.</p>

        
          <div class='highlight'><pre>        ip = env.OPENSHIFT_NODEJS_IP <span class="keyword">or</span> env.OPENSHIFT_INTERNAL_IP <span class="keyword">or</span> env.IP
        port = env.OPENSHIFT_NODEJS_PORT <span class="keyword">or</span> env.OPENSHIFT_INTERNAL_PORT <span class="keyword">or</span> env.VCAP_APP_PORT <span class="keyword">or</span> env.PORT
        settings.app.ip = ip <span class="keyword">if</span> ip? <span class="keyword">and</span> ip <span class="keyword">isnt</span> <span class="string">""</span>
        settings.app.port = port <span class="keyword">if</span> port? <span class="keyword">and</span> port <span class="keyword">isnt</span> <span class="string">""</span></pre></div>
        
      
        
        <p>Check for MongoDB on AppFog variables.</p>

        
          <div class='highlight'><pre>        vcap = env.VCAP_SERVICES
        vcap = JSON.parse vcap <span class="keyword">if</span> vcap?
        <span class="keyword">if</span> vcap? <span class="keyword">and</span> vcap <span class="keyword">isnt</span> <span class="string">""</span>
            mongo = vcap[<span class="string">"mongodb-1.8"</span>]
            mongo = mongo[<span class="number">0</span>][<span class="string">"credentials"</span>] <span class="keyword">if</span> mongo?
            <span class="keyword">if</span> mongo?
                settings.database.connString = <span class="string">"mongodb://<span class="subst">#{mongo.hostname}</span>:<span class="subst">#{mongo.port}</span>/<span class="subst">#{mongo.db}</span>"</span></pre></div>
        
      
        
        <p>Check for MongoLab variables.</p>

        
          <div class='highlight'><pre>        mongoLab = env.MONGOLAB_URI
        settings.database.connString = mongoLab <span class="keyword">if</span> mongoLab? <span class="keyword">and</span> mongoLab <span class="keyword">isnt</span> <span class="string">""</span></pre></div>
        
      
        
        <p>Check for MongoHQ variables.</p>

        
          <div class='highlight'><pre>        mongoHq = env.MONGOHQ_URL
        settings.database.connString = mongoHq <span class="keyword">if</span> mongoHq? <span class="keyword">and</span> mongoHq <span class="keyword">isnt</span> <span class="string">""</span></pre></div>
        
      
        
        <p>Check for Logentries and Loggly variables.</p>

        
          <div class='highlight'><pre>        logentriesToken = env.LOGENTRIES_TOKEN
        logglyToken = env.LOGGLY_TOKEN
        logglySubdomain = env.LOGGLY_SUBDOMAIN
        settings.logger.Logentries.token = logentriesToken <span class="keyword">if</span> logentriesToken? <span class="keyword">and</span> logentriesToken <span class="keyword">isnt</span> <span class="string">""</span>
        settings.logger.Loggly.token = logglyToken <span class="keyword">if</span> logglyToken? <span class="keyword">and</span> logglyToken <span class="keyword">isnt</span> <span class="string">""</span>
        settings.logger.Loggly.subdomain = logglySubdomain <span class="keyword">if</span> logglySubdomain? <span class="keyword">and</span> logglySubdomain <span class="keyword">isnt</span> <span class="string">""</span></pre></div>
        
      
        
        <p>Check for SendGrid (email) variables.</p>

        
          <div class='highlight'><pre>        smtpUser = env.SENDGRID_USERNAME
        smtpPassword = env.SENDGRID_PASSWORD
        <span class="keyword">if</span> currentSmtpHost?.indexOf(<span class="string">"sendgrid"</span>) &gt; <span class="number">0</span>
            settings.mail.smtp.user = smtpUser <span class="keyword">if</span> smtpUser? <span class="keyword">and</span> smtpUser <span class="keyword">isnt</span> <span class="string">""</span>
            settings.mail.smtp.password = smtpPassword <span class="keyword">if</span> smtpPassword? <span class="keyword">and</span> smtpPassword <span class="keyword">isnt</span> <span class="string">""</span></pre></div>
        
      
        
        <p>Check for Mandrill (email) variables.</p>

        
          <div class='highlight'><pre>        smtpUser = env.MANDRILL_USERNAME
        smtpPassword = env.MANDRILL_APIKEY
        <span class="keyword">if</span> currentSmtpHost?.indexOf(<span class="string">"mandrill"</span>) &gt; <span class="number">0</span>
            settings.mail.smtp.user = smtpUser <span class="keyword">if</span> smtpUser? <span class="keyword">and</span> smtpUser <span class="keyword">isnt</span> <span class="string">""</span>
            settings.mail.smtp.password = smtpPassword <span class="keyword">if</span> smtpPassword? <span class="keyword">and</span> smtpPassword <span class="keyword">isnt</span> <span class="string">""</span></pre></div>
        
      
        
        <p>Check for Mailgun (email) variables.</p>

        
          <div class='highlight'><pre>        smtpHost = env.MAILGUN_SMTP_SERVER
        smtpPort = env.MAILGUN_SMTP_PORT
        smtpUser = env.MAILGUN_SMTP_LOGIN
        smtpPassword = env.MAILGUN_SMTP_PASSWORD
        settings.mail.smtp.host = smtpHost <span class="keyword">if</span> smtpHost? <span class="keyword">and</span> smtpHost <span class="keyword">isnt</span> <span class="string">""</span>
        settings.mail.smtp.port = smtpPort <span class="keyword">if</span> smtpPort? <span class="keyword">and</span> smtpPort <span class="keyword">isnt</span> <span class="string">""</span>
        settings.mail.smtp.user = smtpUser <span class="keyword">if</span> smtpUser? <span class="keyword">and</span> smtpUser <span class="keyword">isnt</span> <span class="string">""</span>
        settings.mail.smtp.password = smtpPassword <span class="keyword">if</span> smtpPassword? <span class="keyword">and</span> smtpPassword <span class="keyword">isnt</span> <span class="string">""</span></pre></div>
        
      
        
        <h2>SERVER INFO UTILS</h2>

        
      
        
        <p>Return the first valid server IPv4 address.</p>

        
          <div class='highlight'><pre>    getServerIP: -&gt;
        ifaces = os.networkInterfaces()
        result = <span class="string">""</span></pre></div>
        
      
        
        <p>Parse network interfaces and try getting the server IPv4 address.</p>

        
          <div class='highlight'><pre>        <span class="keyword">for</span> i <span class="keyword">of</span> ifaces
            ifaces[i].forEach (details) -&gt;
                <span class="keyword">if</span> details.family <span class="keyword">is</span> <span class="string">"IPv4"</span> <span class="keyword">and</span> <span class="keyword">not</span> details.internal
                    result = details.address

        <span class="keyword">return</span> result</pre></div>
        
      
        
        <p>Return an object with general information about the server.</p>

        
          <div class='highlight'><pre>    getServerInfo: =&gt;
        result = {}</pre></div>
        
      
        
        <p>Parse server info.</p>

        
          <div class='highlight'><pre>        pid = process.pid + <span class="string">" "</span> + process.title
        platform = process.platform + <span class="string">" "</span> + process.arch + <span class="string">", v"</span> + process.version
        memUsage = process.memoryUsage()
        memUsage = Math.round(memUsage.headUsed / <span class="number">1000</span>) + <span class="string">" / "</span> + Math.round(memUsage.heapTotal / <span class="number">1000</span>) + <span class="string">" MB"</span>
        uptime = moment.duration(process.uptime, <span class="string">"s"</span>).humanize()</pre></div>
        
      
        
        <p>Save parsed info to the result object.</p>

        
          <div class='highlight'><pre>        result.pid = pid
        result.platform = platform
        result.memoryUsage = memUsage
        result.uptime = uptime
        result.ip = <span class="property">@getServerIP</span>()

        <span class="keyword">return</span> result</pre></div>
        
      
        
        <h2>CLIENT INFO UTILS</h2>

        
      
        
        <p>Get the client / browser IP, even when behind proxies. Works for http and socket requests.</p>

        
          <div class='highlight'><pre>    getClientIP: (reqOrSocket) -&gt;
        <span class="keyword">if</span> <span class="keyword">not</span> reqOrSocket?
            <span class="keyword">return</span> <span class="literal">null</span></pre></div>
        
      
        
        <p>Try getting the xforwarded header first.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> reqOrSocket.header?
            xfor = reqOrSocket.header <span class="string">"X-Forwarded-For"</span>
            <span class="keyword">if</span> xfor? <span class="keyword">and</span> xfor <span class="keyword">isnt</span> <span class="string">""</span>
                <span class="keyword">return</span> xfor.split(<span class="string">","</span>)[<span class="number">0</span>]</pre></div>
        
      
        
        <p>Get remote address.</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> reqOrSocket.connection?
            <span class="keyword">return</span> reqOrSocket.connection.remoteAddress
        <span class="keyword">else</span>
            <span class="keyword">return</span> reqOrSocket.remoteAddress</pre></div>
        
      
        
        <p>Get the client&#39;s device identifier string based on the user agent.</p>

        
          <div class='highlight'><pre>    getClientDevice: (req) -&gt;
        ua = req.headers[<span class="string">"user-agent"</span>]</pre></div>
        
      
        
        <p>Find mobile devices.</p>

        
          <div class='highlight'><pre>        <span class="keyword">return</span> <span class="string">"mobile-wp-8"</span> <span class="keyword">if</span> ua.indexOf(<span class="string">"Windows Phone 8"</span>) &gt; <span class="number">0</span>
        <span class="keyword">return</span> <span class="string">"mobile-wp-7"</span> <span class="keyword">if</span> ua.indexOf(<span class="string">"Windows Phone 7"</span>) &gt; <span class="number">0</span>
        <span class="keyword">return</span> <span class="string">"mobile-wp"</span> <span class="keyword">if</span> ua.indexOf(<span class="string">"Windows Phone"</span>) &gt; <span class="number">0</span>
        <span class="keyword">return</span> <span class="string">"mobile-iphone-5"</span> <span class="keyword">if</span> ua.indexOf(<span class="string">"iPhone5"</span>) &gt; <span class="number">0</span>
        <span class="keyword">return</span> <span class="string">"mobile-iphone-4"</span> <span class="keyword">if</span> ua.indexOf(<span class="string">"iPhone4"</span>) &gt; <span class="number">0</span>
        <span class="keyword">return</span> <span class="string">"mobile-iphone"</span> <span class="keyword">if</span> ua.indexOf(<span class="string">"iPhone"</span>) &gt; <span class="number">0</span>
        <span class="keyword">return</span> <span class="string">"mobile-android-5"</span> <span class="keyword">if</span> ua.indexOf(<span class="string">"Android 5"</span>) &gt; <span class="number">0</span>
        <span class="keyword">return</span> <span class="string">"mobile-android-4"</span> <span class="keyword">if</span> ua.indexOf(<span class="string">"Android 4"</span>) &gt; <span class="number">0</span>
        <span class="keyword">return</span> <span class="string">"mobile-android"</span> <span class="keyword">if</span> ua.indexOf(<span class="string">"Android"</span>) &gt; <span class="number">0</span></pre></div>
        
      
        
        <p>Find desktop browsers.</p>

        
          <div class='highlight'><pre>        <span class="keyword">return</span> <span class="string">"desktop-chrome"</span> <span class="keyword">if</span> ua.indexOf(<span class="string">"Chrome/"</span>) &gt; <span class="number">0</span>
        <span class="keyword">return</span> <span class="string">"desktop-firefox"</span> <span class="keyword">if</span> ua.indexOf(<span class="string">"Firefox/"</span>) &gt; <span class="number">0</span>
        <span class="keyword">return</span> <span class="string">"desktop-safari"</span> <span class="keyword">if</span> ua.indexOf(<span class="string">"Safari/"</span>) &gt; <span class="number">0</span>
        <span class="keyword">return</span> <span class="string">"desktop-opera"</span> <span class="keyword">if</span> ua.indexOf(<span class="string">"Opera/"</span>) &gt; <span class="number">0</span>
        <span class="keyword">return</span> <span class="string">"desktop-ie-11"</span> <span class="keyword">if</span> ua.indexOf(<span class="string">"MSIE 11"</span>) &gt; <span class="number">0</span>
        <span class="keyword">return</span> <span class="string">"desktop-ie-10"</span> <span class="keyword">if</span> ua.indexOf(<span class="string">"MSIE 10"</span>) &gt; <span class="number">0</span>
        <span class="keyword">return</span> <span class="string">"desktop-ie-9"</span> <span class="keyword">if</span> ua.indexOf(<span class="string">"MSIE 9"</span>) &gt; <span class="number">0</span>
        <span class="keyword">return</span> <span class="string">"desktop-ie"</span> <span class="keyword">if</span> ua.indexOf(<span class="string">"MSIE"</span>) &gt; <span class="number">0</span></pre></div>
        
      
        
        <p>Return default desktop value if no specific devices were found on user agent.</p>

        
          <div class='highlight'><pre>        <span class="keyword">return</span> <span class="string">"desktop"</span></pre></div>
        
      
        
        <h2>DATA UTILS</h2>

        
      
        
        <p>Minify the passed JSON value by removing comments, unecessary white spaces etc.</p>

        
          <div class='highlight'><pre>    minifyJson: (source) -&gt;
        source = JSON.stringify source <span class="keyword">if</span> <span class="keyword">typeof</span> source <span class="keyword">is</span> <span class="string">"object"</span>
        index = <span class="number">0</span>
        length = source.length
        result = <span class="string">""</span>
        symbol = <span class="literal">undefined</span>
        position = <span class="literal">undefined</span></pre></div>
        
      
        
        <p>Main iterator.</p>

        
          <div class='highlight'><pre>        <span class="keyword">while</span> index &lt; length

            symbol = source.charAt(index)
            <span class="keyword">switch</span> symbol</pre></div>
        
      
        
        <p>Ignore whitespace tokens. According to ES 5.1 section 15.12.1.1,
whitespace tokens include tabs, carriage returns, line feeds, and
space characters.</p>

        
          <div class='highlight'><pre>                <span class="keyword">when</span> <span class="string">"\t"</span>, <span class="string">"\r"</span>
                , <span class="string">"\n"</span>
                , <span class="string">" "</span>
                    index += <span class="number">1</span></pre></div>
        
      
        
        <p>Ignore line and block comments.</p>

        
          <div class='highlight'><pre>                <span class="keyword">when</span> <span class="string">"/"</span>
                    symbol = source.charAt(index += <span class="number">1</span>)
                    <span class="keyword">switch</span> symbol</pre></div>
        
      
        
        <p>Line comments.</p>

        
          <div class='highlight'><pre>                        <span class="keyword">when</span> <span class="string">"/"</span>
                            position = source.indexOf(<span class="string">"\n"</span>, index)</pre></div>
        
      
        
        <p>Check for CR-style line endings.</p>

        
          <div class='highlight'><pre>                            position = source.indexOf(<span class="string">"\r"</span>, index)  <span class="keyword">if</span> position &lt; <span class="number">0</span>
                            index = (<span class="keyword">if</span> position &gt; -<span class="number">1</span> <span class="keyword">then</span> position <span class="keyword">else</span> length)</pre></div>
        
      
        
        <p>Block comments.</p>

        
          <div class='highlight'><pre>                        <span class="keyword">when</span> <span class="string">"*"</span>
                            position = source.indexOf(<span class="string">"*/"</span>, index)
                            <span class="keyword">if</span> position &gt; -<span class="number">1</span></pre></div>
        
      
        
        <p>Advance the scanner&#39;s position past the end of the comment.</p>

        
          <div class='highlight'><pre>                                index = position += <span class="number">2</span>
                                <span class="keyword">break</span>
                            <span class="keyword">throw</span> SyntaxError(<span class="string">"Unterminated block comment."</span>)
                        <span class="keyword">else</span>
                            <span class="keyword">throw</span> SyntaxError(<span class="string">"Invalid comment."</span>)</pre></div>
        
      
        
        <p>Parse strings separately to ensure that any whitespace characters and
JavaScript-style comments within them are preserved.</p>

        
          <div class='highlight'><pre>                <span class="keyword">when</span> <span class="string">"\""</span>
                    position = index
                    <span class="keyword">while</span> index &lt; length
                        symbol = source.charAt(index += <span class="number">1</span>)
                        <span class="keyword">if</span> symbol <span class="keyword">is</span> <span class="string">"\\"</span></pre></div>
        
      
        
        <p>Skip past escaped characters.</p>

        
          <div class='highlight'><pre>                            index += <span class="number">1</span>
                        <span class="keyword">else</span> <span class="keyword">break</span>  <span class="keyword">if</span> symbol <span class="keyword">is</span> <span class="string">"\""</span>
                    <span class="keyword">if</span> source.charAt(index) <span class="keyword">is</span> <span class="string">"\""</span>
                        result += source.slice(position, index += <span class="number">1</span>)
                        <span class="keyword">break</span>
                    <span class="keyword">throw</span> SyntaxError(<span class="string">"Unterminated string."</span>)</pre></div>
        
      
        
        <p>Preserve all other characters.</p>

        
          <div class='highlight'><pre>                <span class="keyword">else</span>
                    result += symbol
                    index += <span class="number">1</span>
        <span class="keyword">return</span> result</pre></div>
        
      
        
        <h2>Singleton implementation</h2>

        
      
        
        
        
          <div class='highlight'><pre>Utils.<span class="function"><span class="title">getInstance</span></span> = -&gt;
    <span class="property">@instance</span> = <span class="keyword">new</span> Utils() <span class="keyword">if</span> <span class="keyword">not</span> <span class="property">@instance</span>?
    <span class="keyword">return</span> <span class="property">@instance</span>

module.exports = exports = Utils.getInstance()</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
