<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Expresser - mailer/index.coffee</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-9331973-3"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-9331973-3');
</script><script>if (location.protocol.match(/^http/) && location.pathname.match('\.html') === null && location.pathname.slice(-1) !== '/') {
  location.href = location.href + '/';
}</script><link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script><script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]--><link href="../google-code-prettify/prettify.css" rel="stylesheet" type="text/css"><link href="../style.css" rel="stylesheet" type="text/css"></head><body data-spy="scroll" data-target=".sidebar"><nav class="navbar navbar-default navbar-fixed-top" role="navigation"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#top-navigation-collapse"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="top-navigation-collapse"><ul class="nav navbar-nav"><li><a href="../index.html">Home</a></li><li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Guides <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../guides/App.html">App</a></li><li><a href="../guides/Errors.html">Errors</a></li><li><a href="../guides/Events.html">Events</a></li><li><a href="../guides/Logger.html">Logger</a></li><li><a href="../guides/Settings.html">Settings</a></li><li><a href="../guides/Utils.html">Utils</a></li></ul></li><li><a href="../classes/index.html">Classes</a></li><li class="dropdown active"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Files - mailer/index.coffee <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../files/app.coffee.html">app.coffee</a></li><li><a href="../files/errors.coffee.html">errors.coffee</a></li><li><a href="../files/events.coffee.html">events.coffee</a></li><li><a href="../files/index.coffee.html">index.coffee</a></li><li><a href="../files/logger.coffee.html">logger.coffee</a></li><li><a href="../files/settings.coffee.html">settings.coffee</a></li><li><a href="../files/utils.coffee.html">utils.coffee</a></li><li><a href="../files/aws.dynamodb.coffee.html">aws/dynamodb.coffee</a></li><li><a href="../files/aws.index.coffee.html">aws/index.coffee</a></li><li><a href="../files/aws.s3.coffee.html">aws/s3.coffee</a></li><li><a href="../files/aws.sns.coffee.html">aws/sns.coffee</a></li><li><a href="../files/cron.index.coffee.html">cron/index.coffee</a></li><li><a href="../files/cron.job.coffee.html">cron/job.coffee</a></li><li><a href="../files/gcloud.datastore.coffee.html">gcloud/datastore.coffee</a></li><li><a href="../files/gcloud.index.coffee.html">gcloud/index.coffee</a></li><li><a href="../files/gcloud.storage.coffee.html">gcloud/storage.coffee</a></li><li><a href="../files/logger-file.index.coffee.html">logger-file/index.coffee</a></li><li><a href="../files/logger-logentries.index.coffee.html">logger-logentries/index.coffee</a></li><li><a href="../files/logger-loggly.index.coffee.html">logger-loggly/index.coffee</a></li><li><a href="../files/mailer.index.coffee.html">mailer/index.coffee</a></li><li><a href="../files/mailer.templates.coffee.html">mailer/templates.coffee</a></li><li><a href="../files/metrics.httpserver.coffee.html">metrics/httpserver.coffee</a></li><li><a href="../files/metrics.index.coffee.html">metrics/index.coffee</a></li><li><a href="../files/metrics.percentile.coffee.html">metrics/percentile.coffee</a></li><li><a href="../files/mongodb.index.coffee.html">mongodb/index.coffee</a></li><li><a href="../files/sockets.index.coffee.html">sockets/index.coffee</a></li><li><a href="../files/utils.browser.coffee.html">utils/browser.coffee</a></li><li><a href="../files/utils.data.coffee.html">utils/data.coffee</a></li><li><a href="../files/utils.io.coffee.html">utils/io.coffee</a></li><li><a href="../files/utils.network.coffee.html">utils/network.coffee</a></li><li><a href="../files/utils.system.coffee.html">utils/system.coffee</a></li></ul></li></ul><div class="options"><label class="checkbox"><input id="options-private" type="checkbox"> Private</label></div></div></div></nav><div class="container-fluid content"><div class="row"><div class="hidden-xs sidebar col-sm-3" data-spy="affix"><div class="cormo-sidenav"><div class="panel panel-default"><div class="panel-collapse collapse in" id="undefined_body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/app.coffee.html">app.coffee</a></li><li><a href="../files/errors.coffee.html">errors.coffee</a></li><li><a href="../files/events.coffee.html">events.coffee</a></li><li><a href="../files/index.coffee.html">index.coffee</a></li><li><a href="../files/logger.coffee.html">logger.coffee</a></li><li><a href="../files/settings.coffee.html">settings.coffee</a></li><li><a href="../files/utils.coffee.html">utils.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#aws__body">aws/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="aws__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/aws.dynamodb.coffee.html">dynamodb.coffee</a></li><li><a href="../files/aws.index.coffee.html">index.coffee</a></li><li><a href="../files/aws.s3.coffee.html">s3.coffee</a></li><li><a href="../files/aws.sns.coffee.html">sns.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#cron__body">cron/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="cron__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/cron.index.coffee.html">index.coffee</a></li><li><a href="../files/cron.job.coffee.html">job.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#gcloud__body">gcloud/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="gcloud__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/gcloud.datastore.coffee.html">datastore.coffee</a></li><li><a href="../files/gcloud.index.coffee.html">index.coffee</a></li><li><a href="../files/gcloud.storage.coffee.html">storage.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-file__body">logger-file/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-file__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-file.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-logentries__body">logger-logentries/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-logentries__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-logentries.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-loggly__body">logger-loggly/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-loggly__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-loggly.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#mailer__body">mailer/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="mailer__body"><ul class="nav nav-pills nav-stacked"><li class="active"><a href="../files/mailer.index.coffee.html">index.coffee</a></li><li><a href="../files/mailer.templates.coffee.html">templates.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#metrics__body">metrics/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="metrics__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/metrics.httpserver.coffee.html">httpserver.coffee</a></li><li><a href="../files/metrics.index.coffee.html">index.coffee</a></li><li><a href="../files/metrics.percentile.coffee.html">percentile.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#mongodb__body">mongodb/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="mongodb__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/mongodb.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#sockets__body">sockets/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="sockets__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/sockets.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#utils__body">utils/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="utils__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/utils.browser.coffee.html">browser.coffee</a></li><li><a href="../files/utils.data.coffee.html">data.coffee</a></li><li><a href="../files/utils.io.coffee.html">io.coffee</a></li><li><a href="../files/utils.network.coffee.html">network.coffee</a></li><li><a href="../files/utils.system.coffee.html">system.coffee</a></li></ul></div></div></div></div><div class="col-sm-9 col-sm-offset-3"><section><h1>mailer/index.coffee</h1></section><pre class="prettyprint"># EXPRESSER MAILER
# --------------------------------------------------------------------------
fs = require &quot;fs&quot;
nodemailer = require &quot;nodemailer&quot;

events = null
lodash = null
logger = null
settings = null

###
# Sends and manages emails, with template and tags replacement support.
# When parsing templates, the tags should be wrapped with normal brackets {}.
# Example: {contents}
# The base message template (which is loaded with every single sent message)
# must be saved as base.html, under the /assets/email folder (or whatever
# folder / base file name you have set on the settings).
###
class Mailer
    priority: 2

    ##
    # Templates manager.
    # @property
    # @type EmailTemplates
    templates: require &quot;./templates.coffee&quot;

    ##
    # The SMTP transport object.
    # @property
    smtp: null

    # INIT
    # --------------------------------------------------------------------------

    ###
    # Init the Mailer module and create the SMTP objects.
    ###
    init: =&gt;
        events = @expresser.events
        lodash = @expresser.libs.lodash
        logger = @expresser.logger
        settings = @expresser.settings

        logger.debug &quot;Mailer.init&quot;

        # Init the templates helper.
        @templates.init this

        # Define default primary SMTP.
        if settings.mailer.smtp.service? and settings.mailer.smtp.service isnt &quot;&quot;
            @setSmtp settings.mailer.smtp, false
        else if settings.mailer.smtp.host? and settings.mailer.smtp.host isnt &quot;&quot; and settings.mailer.smtp.port &gt; 0
            @setSmtp settings.mailer.smtp, false

        events.emit &quot;Mailer.on.init&quot;
        delete @init

    # OUTBOUND
    # --------------------------------------------------------------------------

    ###
    # Sends an email to the specified address.
    # @param {String} options The email message options
    # @param {String} [options.body] The email body in text or HTML.
    # @param {String} [options.subject] The email subject.
    # @param {String} [options.to] The &quot;to&quot; address.
    # @param {String} [options.from] The &quot;from&quot; address, optional, if blank use default from settings.
    # @param {String} [options.template] The template file to be loaded, optional.
    # @param {Boolean} doNotSend If true, the actual email will not be sent out. Used for testing.
    ###
    send: (options) =&gt;
        logger.debug &quot;Mailer.send&quot;, options

        return new Promise (resolve, reject) =&gt;
            if not settings.mailer.enabled
                return reject logger.notEnabled &quot;Mailer&quot;

            smtp = options.smtp or @smtp

            # Check if SMTP server is set.
            if not smtp?
                err = new Error &quot;Default SMTP transports were not initiated and nothing was passed on options.smtp.&quot;
                logger.error &quot;Mailer.send&quot;, err, options
                reject err

            # Make sure &quot;to&quot; address is valid.
            if not options.to? or options.to is false or options.to is &quot;&quot;
                err = new Error &quot;Option 'to' is mandatory and cannot be empty.&quot;
                logger.error &quot;Mailer.send&quot;, err, options
                reject err

            # Set from to default address if no `to` was set.
            options.from = &quot;#{settings.app.title} &lt;#{settings.mailer.from}&gt;&quot; if not options.from?

            # Set HTML to body, if passed.
            html = if options.body? then options.body.toString() else &quot;&quot;

            # If to is an array, make it a string separated by commas.
            if lodash.isArray options.to
                options.to = options.to.join &quot;, &quot;

            # Get the name of recipient based on the `to` option.
            if options.to.indexOf(&quot;&lt;&quot;) &lt; 3
                toName = options.to
            else
                toName = options.to.substring 0, options.to.indexOf(&quot;&lt;&quot;) - 1

            # Load template if a `template` was passed.
            if options.template? and options.template isnt &quot;&quot;
                template = @templates.get options.template
                html = @templates.parse template, {contents: html}

                # Parse template keywords if a `keywords` was passed.
                if lodash.isObject options.keywords
                    html = @templates.parse html, options.keywords

            # Parse final template and set it on the `options`.
            html = @templates.parse html, {to: toName, appTitle: settings.app.title, appUrl: settings.app.url}
            options.html = html

            # Check if `doNotSend` flag is set, and if so, do not send anything.
            if options.doNotSend or settings.mailer.doNotSend
                logger.warn &quot;Mailer.smtpSend&quot;, &quot;Abort! doNotSend = true&quot;, options.to, options.subject
                return resolve {doNotSend: true}

            # Send using the main SMTP. If failed and a secondary is also set, try using the secondary.
            try
                smtp.sendMail options, (err, result) -&gt;
                    if err?
                        logger.error &quot;Mailer.send&quot;, smtp.host, &quot;to #{options.to}&quot;, &quot;from #{options.from}&quot;, err
                        reject err
                    else
                        logger.info &quot;Mailer.send&quot;, smtp.host, &quot;to #{options.to}&quot;, &quot;from #{options.from}&quot;, options.subject
                        resolve result
            catch ex
                logger.error &quot;Mailer.send&quot;, smtp.host, &quot;to #{options.to}&quot;, &quot;from #{options.from}&quot;, ex
                reject err

    # SMTP HELPER METHODS
    # --------------------------------------------------------------------------

    ###
    # Helper to create a SMTP object.
    # @param {Object} options Options like service, host and port, username, password etc.
    # @return {Object} A Nodemailer SMTP transport object, or null if a problem was found.
    ###
    createSmtp: (options) -&gt;
        logger.debug &quot;Mailer.createSmtp&quot;, options

        if not settings.mailer.enabled
            return logger.notEnabled &quot;Mailer&quot;

        options.debug = settings.general.debug if not options.debug?
        options.secureConnection = options.secure if not options.secureConnection?
        dkim = options.dkim or settings.mailer.dkim

        # Make sure auth is properly set.
        if not options.auth? and options.user? and options.password?
            options.auth = {user: options.user, pass: options.password}
            delete options[&quot;user&quot;]
            delete options[&quot;password&quot;]

        # Set the correct SMTP details based on the options.
        result = nodemailer.createTransport options

        # Sign using DKIM?
        if dkim.domainName? and dkim.privateKey?
            result.useDKIM dkim

        return result

    ###
    # Use the specified options and create a new SMTP server.
    # If no options are set, use default from settings.
    # @param {Object} options Options to be passed to SMTP creator.
    ###
    setSmtp: (options) -&gt;
        options = settings.mailer.smtp if not options?
        @smtp = @createSmtp options

# Singleton implementation
# --------------------------------------------------------------------------
Mailer.getInstance = -&gt;
    @instance = new Mailer() if not @instance?
    return @instance

module.exports = exports = Mailer.getInstance()</pre></div></div></div><script src="https://code.jquery.com/jquery-3.2.1.min.js"></script><script src="../bootstrap/js/bootstrap.min.js"></script><script src="../google-code-prettify/prettify.js"></script><script src="../script.js"></script><script src="../group-examples.js"></script><a href="https://github.com/igoramadas/expresser"><img class="github-ribbon" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub"></a></body></html>