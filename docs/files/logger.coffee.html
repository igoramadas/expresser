<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Expresser - logger.coffee</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-9331973-3"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-9331973-3');
</script><script>if (location.protocol.match(/^http/) && location.pathname.match('\.html') === null && location.pathname.slice(-1) !== '/') {
  location.href = location.href + '/';
}</script><link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script><script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]--><link href="../google-code-prettify/prettify.css" rel="stylesheet" type="text/css"><link href="../style.css" rel="stylesheet" type="text/css"></head><body data-spy="scroll" data-target=".sidebar"><nav class="navbar navbar-default navbar-fixed-top" role="navigation"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#top-navigation-collapse"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="top-navigation-collapse"><ul class="nav navbar-nav"><li><a href="../index.html">Home</a></li><li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Guides <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../guides/App.html">App</a></li><li><a href="../guides/Errors.html">Errors</a></li><li><a href="../guides/Events.html">Events</a></li><li><a href="../guides/Logger.html">Logger</a></li><li><a href="../guides/Settings.html">Settings</a></li><li><a href="../guides/Utils.html">Utils</a></li></ul></li><li><a href="../classes/index.html">Classes</a></li><li class="dropdown active"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Files - logger.coffee <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../files/app.coffee.html">app.coffee</a></li><li><a href="../files/errors.coffee.html">errors.coffee</a></li><li><a href="../files/events.coffee.html">events.coffee</a></li><li><a href="../files/index.coffee.html">index.coffee</a></li><li><a href="../files/logger.coffee.html">logger.coffee</a></li><li><a href="../files/settings.coffee.html">settings.coffee</a></li><li><a href="../files/utils.coffee.html">utils.coffee</a></li><li><a href="../files/aws.dynamodb.coffee.html">aws/dynamodb.coffee</a></li><li><a href="../files/aws.index.coffee.html">aws/index.coffee</a></li><li><a href="../files/aws.s3.coffee.html">aws/s3.coffee</a></li><li><a href="../files/aws.sns.coffee.html">aws/sns.coffee</a></li><li><a href="../files/cron.index.coffee.html">cron/index.coffee</a></li><li><a href="../files/cron.job.coffee.html">cron/job.coffee</a></li><li><a href="../files/gcloud.datastore.coffee.html">gcloud/datastore.coffee</a></li><li><a href="../files/gcloud.index.coffee.html">gcloud/index.coffee</a></li><li><a href="../files/gcloud.storage.coffee.html">gcloud/storage.coffee</a></li><li><a href="../files/logger-file.index.coffee.html">logger-file/index.coffee</a></li><li><a href="../files/logger-logentries.index.coffee.html">logger-logentries/index.coffee</a></li><li><a href="../files/logger-loggly.index.coffee.html">logger-loggly/index.coffee</a></li><li><a href="../files/mailer.index.coffee.html">mailer/index.coffee</a></li><li><a href="../files/mailer.templates.coffee.html">mailer/templates.coffee</a></li><li><a href="../files/metrics.httpserver.coffee.html">metrics/httpserver.coffee</a></li><li><a href="../files/metrics.index.coffee.html">metrics/index.coffee</a></li><li><a href="../files/metrics.percentile.coffee.html">metrics/percentile.coffee</a></li><li><a href="../files/mongodb.index.coffee.html">mongodb/index.coffee</a></li><li><a href="../files/sockets.index.coffee.html">sockets/index.coffee</a></li><li><a href="../files/swagger.index.coffee.html">swagger/index.coffee</a></li><li><a href="../files/utils.browser.coffee.html">utils/browser.coffee</a></li><li><a href="../files/utils.data.coffee.html">utils/data.coffee</a></li><li><a href="../files/utils.io.coffee.html">utils/io.coffee</a></li><li><a href="../files/utils.network.coffee.html">utils/network.coffee</a></li><li><a href="../files/utils.system.coffee.html">utils/system.coffee</a></li></ul></li></ul><div class="options"><label class="checkbox"><input id="options-private" type="checkbox"> Private</label></div></div></div></nav><div class="container-fluid content"><div class="row"><div class="hidden-xs sidebar col-sm-3" data-spy="affix"><div class="cormo-sidenav"><div class="panel panel-default"><div class="panel-collapse collapse in" id="undefined_body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/app.coffee.html">app.coffee</a></li><li><a href="../files/errors.coffee.html">errors.coffee</a></li><li><a href="../files/events.coffee.html">events.coffee</a></li><li><a href="../files/index.coffee.html">index.coffee</a></li><li class="active"><a href="../files/logger.coffee.html">logger.coffee</a></li><li><a href="../files/settings.coffee.html">settings.coffee</a></li><li><a href="../files/utils.coffee.html">utils.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#aws__body">aws/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="aws__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/aws.dynamodb.coffee.html">dynamodb.coffee</a></li><li><a href="../files/aws.index.coffee.html">index.coffee</a></li><li><a href="../files/aws.s3.coffee.html">s3.coffee</a></li><li><a href="../files/aws.sns.coffee.html">sns.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#cron__body">cron/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="cron__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/cron.index.coffee.html">index.coffee</a></li><li><a href="../files/cron.job.coffee.html">job.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#gcloud__body">gcloud/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="gcloud__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/gcloud.datastore.coffee.html">datastore.coffee</a></li><li><a href="../files/gcloud.index.coffee.html">index.coffee</a></li><li><a href="../files/gcloud.storage.coffee.html">storage.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-file__body">logger-file/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-file__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-file.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-logentries__body">logger-logentries/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-logentries__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-logentries.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-loggly__body">logger-loggly/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-loggly__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-loggly.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#mailer__body">mailer/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="mailer__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/mailer.index.coffee.html">index.coffee</a></li><li><a href="../files/mailer.templates.coffee.html">templates.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#metrics__body">metrics/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="metrics__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/metrics.httpserver.coffee.html">httpserver.coffee</a></li><li><a href="../files/metrics.index.coffee.html">index.coffee</a></li><li><a href="../files/metrics.percentile.coffee.html">percentile.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#mongodb__body">mongodb/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="mongodb__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/mongodb.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#sockets__body">sockets/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="sockets__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/sockets.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#swagger__body">swagger/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="swagger__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/swagger.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#utils__body">utils/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="utils__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/utils.browser.coffee.html">browser.coffee</a></li><li><a href="../files/utils.data.coffee.html">data.coffee</a></li><li><a href="../files/utils.io.coffee.html">io.coffee</a></li><li><a href="../files/utils.network.coffee.html">network.coffee</a></li><li><a href="../files/utils.system.coffee.html">system.coffee</a></li></ul></div></div></div></div><div class="col-sm-9 col-sm-offset-3"><section><h1>logger.coffee</h1></section><pre class="prettyprint"># EXPRESSER LOGGER
# --------------------------------------------------------------------------
chalk = require &quot;chalk&quot;
events = require &quot;./events.coffee&quot;
fs = require &quot;fs&quot;
lodash = require &quot;lodash&quot;
moment = require &quot;moment&quot;
path = require &quot;path&quot;
settings = require &quot;./settings.coffee&quot;
utils = require &quot;./utils.coffee&quot;

###
# Handles server logging using the console, local files, Logentries, Loggly and
# other transports available as plugins. Multiple transports can be enabled at
# the same time.
###
class Logger
    newInstance: -&gt; return new Logger()

    ##
    # List of available logging drivers. This list will be populated automatically by installed plugins.
    # @property
    # @type Object
    drivers: {}

    ##
    # List of registered transports.
    # @property
    # @type Object
    transports: {}

    ##
    # Method to call on every log request.
    # @property
    # @type Function
    onLog: null

    # INIT
    # --------------------------------------------------------------------------

    ###
    # Init the Logger module and set default settings.
    ###
    init: =&gt;
        events.emit &quot;Logger.before.init&quot;

        if settings.logger.uncaughtException
            @debug &quot;Logger.init&quot;, &quot;Catching unhandled exceptions.&quot;

            process.on &quot;uncaughtException&quot;, (err) =&gt;
                try
                    @error &quot;Unhandled exception!&quot;, err.message, err.stack
                catch ex
                    console.error &quot;Unhandled exception!&quot;, err.message, err.stack, ex

        events.emit &quot;Logger.on.init&quot;
        delete @init

    # IMPLEMENTATION
    # -------------------------------------------------------------------------

    ###
    # Register a Logger transport.
    # @param {String} id Unique ID of the transport to be registered, mandatory.
    # @param {String} driver The transport driver ID (logger, loggly, etc), mandatory.
    # @param {Object} options Registration options to be passed to the transport handler.
    ###
    register: (id, driver, options) -&gt;
        if not @drivers[driver]?
            console.error &quot;Logger.register&quot;, &quot;#{driver} is not installed! Please check if plugin expresser-logger-#{driver} is available on the current environment.&quot;
            return false
        else
            if settings.general.debug
                console.log &quot;Logger.register&quot;, id, driver, options

            @transports[id] = @drivers[driver].getTransport options
            @transports[id].log = @drivers[driver].log
            @transports[id].debug = @debug
            @transports[id].info = @info
            @transports[id].warn = @warn
            @transports[id].error = @error
            @transports[id].critical = @critical

            return @transports[id]

    ###
    # Unregister a Logger transport.
    # @param {String} id Unique ID of the transport to be unregistered.
    ###
    unregister: (id) =&gt;
        @transports[id]?.unregister?()
        delete @transports[id]

        if settings.general.debug
            console.log &quot;Logger.unregister&quot;, id

    # LOG METHODS
    # --------------------------------------------------------------------------

    ###
    # Log to the console.
    # @param {String} logType The log type (ex: warning, error, info, etc).
    # @param {String} msg The message to be logged, mandatory.
    # @param {Boolean} doNotParse If true, message won't be cleaned using the `argsCleaner` helper.
    # @return {String} The human readable log sent to the console.
    ###
    console: (logType, msg, doNotParse = false) -&gt;
        return if process.env.NODE_ENV is &quot;test&quot; and logType isnt &quot;test&quot;

        timestamp = moment().format &quot;HH:mm:ss.SS&quot;

        # Only parse message if doNotClean is false or unset.
        msg = @getMessage msg if not doNotParse

        if console[logType]? and logType isnt &quot;debug&quot;
            method = console[logType]
        else
            method = console.log

        # Only proceed here if styles are not disabled on settings.
        # Get styles (text colour, bold, italic etc...) for the correlated log type.
        if not settings.logger.styles
            styledMsg = msg
        else
            styles = settings.logger.styles[logType]

            if styles?
                chalkStyle = chalk
                chalkStyle = chalkStyle[s] for s in styles
            else
                chalkStyle = chalk.white

            styledMsg = chalkStyle msg

        # Log to console and return message.
        method timestamp, styledMsg

        return msg

    ###
    # Generic log method. You can use this if you want to have your own customized log types
    # instead of the more traditional debug / info / warning / error ...
    # @param {String} logType The log type (for example: info, error, myCustomType etc).
    # @param {Array} args Array to be stringified and logged, mandatory.
    # @return {String} The parsed, stringified log message.
    ###
    log: (logType, args) -&gt;
        return if settings.logger.levels?.indexOf(logType) &lt; 0 and not settings.general.debug

        # Get message out of the arguments.
        msg = @getMessage args

        # Dispatch to all registered transports.
        for key, obj of @transports
            obj.log logType, msg, true

        # Log to the console depending on `console` setting.
        if settings.logger.console
            @console logType, msg, true

        # Custom onLog callback?
        @onLog? logType, args

        return msg

    ###
    # Log to the active transports as `debug`, only if `settings.general.debug` is true.
    # @param {Arguments} args Any number of arguments to be parsed and stringified.
    ###
    debug: -&gt;
        args = Array.prototype.slice.call arguments
        args.unshift &quot;DEBUG&quot;
        msg = @log &quot;debug&quot;, args
        return msg

    ###
    # Log to the active transports as `info`.
    # @param {Arguments} args Any number of arguments to be parsed and stringified.
    ###
    info: -&gt;
        args = Array.prototype.slice.call arguments
        args.unshift &quot;INFO&quot;
        msg = @log &quot;info&quot;, args
        return msg

    ###
    # Log to the active transports as `warn`.
    # @param {Arguments} args Any number of arguments to be parsed and stringified.
    ###
    warn: -&gt;
        args = Array.prototype.slice.call arguments
        args.unshift &quot;WARN&quot;
        msg = @log &quot;warn&quot;, args
        events.emit &quot;Logger.on.warn&quot;, msg
        return msg

    ###
    # Log to the active transports as `error`.
    # @param {Arguments} args Any number of arguments to be parsed and stringified.
    ###
    error: -&gt;
        args = Array.prototype.slice.call arguments
        args.unshift &quot;ERROR&quot;
        msg = @log &quot;error&quot;, args
        events.emit &quot;Logger.on.error&quot;, msg
        return msg

    ###
    # Log to the active transports as `critical`.
    # @param {Arguments} args Any number of arguments to be parsed and stringified.
    ###
    critical: -&gt;
        args = Array.prototype.slice.call arguments
        args.unshift &quot;CRITICAL&quot;
        msg = @log &quot;critical&quot;, args
        events.emit &quot;Logger.on.critical&quot;, msg
        return msg

    # HELPER METHODS
    # --------------------------------------------------------------------------

    ###
    # Helper to log to console about deprecated features.
    # @param {String} feature Module, function or feature that is deprecated, mandatory.
    # @param {String} message Optional message to add to the console.
    # @return {Object} Object on the format {error: 'Feature not enabled', notEnabled: true, message: '...'}
    ###
    deprecated: (feature, message) =&gt;
        line = &quot;#{feature} is deprecated. #{message}&quot;
        @console &quot;deprecated&quot;, line
        result = {error: &quot;#{feature} is deprecated.&quot;, deprecated: true}
        result.message = message if message? and message isnt &quot;&quot;
        return result

    ###
    # Helper to log to console about features not enabled.
    # @param {String} feature Module, function or feature that is deprecated, mandatory.
    # @param {String} message Optional message to add to the console.
    # @return {Object} Object on the format {error: 'Feature not enabled', notEnabled: true, message: '...'}
    ###
    notEnabled: (feature, message) =&gt;
        line = &quot;#{feature} is not enabled. #{message}&quot;
        @console &quot;warn&quot;, line
        result = {error: &quot;#{feature} is not enabled.&quot;, notEnabled: true}
        result.message = message if message? and message isnt &quot;&quot;
        return result

    ###
    # Process and clean arguments according to the `removeFields`, `maskFields`
    # and `obfuscateFields` settings. The maximum level deep down the object
    # is defined by the `maxDepth` setting.
    # @return {Arguments} Arguments with masked, hidden and obfuscated fields processed.
    # @private
    ###
    argsCleaner: -&gt;
        funcText = &quot;[Function]&quot;
        unreadableText = &quot;[Unreadable]&quot;
        max = settings.logger.maxDepth - 1
        result = []

        # Recursive cleaning function.
        cleaner = (obj, index) -&gt;
            i = 0

            if lodash.isArray obj
                while i &lt; obj.length
                    if index &gt; max
                        obj[i] = &quot;...&quot;
                    else if lodash.isFunction obj[i]
                        obj[i] = funcText
                    else
                        cleaner obj[i], index + 1
                    i++

            else if lodash.isObject obj
                for key, value of obj
                    try
                        if index &gt; max
                            obj[key] = &quot;...&quot;
                        else if settings.logger.obfuscateFields?.indexOf(key) &gt;=0
                            obj[key] = &quot;***&quot;
                        else if settings.logger.maskFields?[key]?
                            if lodash.isObject value
                                maskedValue = value.value or value.text or value.contents or value.data or &quot;&quot;
                            else
                                maskedValue = value.toString()
                            obj[key] = utils.data.maskString maskedValue, &quot;*&quot;, settings.logger.maskFields[key]
                        else if settings.logger.removeFields?.indexOf(key) &gt;=0
                            delete obj[key]
                        else if lodash.isArray value
                            while i &lt; value.length
                                cleaner value[i], index + 1
                                i++
                        else if lodash.isFunction value
                            obj[key] = funcText
                        else if lodash.isObject value
                            cleaner value, index + 1
                    catch ex
                        delete obj[key]
                        obj[key] = unreadableText

        # Iterate arguments and execute cleaner on objects.
        for argKey, arg of arguments
            try
                if lodash.isArray arg
                    for a in arg
                        if lodash.isError a
                            result.push a
                        else if lodash.isObject a
                            cloned = lodash.cloneDeep a
                            cleaner cloned, 0
                            result.push cloned
                        else if lodash.isFunction a
                            result.push funcText
                        else
                            result.push a
                else
                    cloned = lodash.cloneDeep arg
                    cleaner cloned, 0
                    result.push cloned

            catch ex
                console.warn &quot;Logger.argsCleaner&quot;, argKey, ex

        return result

    ###
    # Parses arguments and returns a human readable message to be used for logging.
    # @param {Array} params Arguments or array of parameters to be parsed.
    # @return {String} The human readable, parsed JSON message.
    # @private
    ###
    getMessage: (params) -&gt;
        separator = settings.logger.separator
        separated = []
        args = []

        if arguments.length &gt; 1
            args.push value for value in arguments
        else if lodash.isArray params
            args.push value for value in params
        else
            args.push params

        args = @argsCleaner args

        # Parse all arguments and stringify objects. Please note that fields defined
        # on the `removeFields` setting won't be added to the message.
        for arg in args
            if arg?
                stringified = &quot;&quot;

                try
                    if lodash.isArray arg
                        for value in arg
                            stringified += JSON.stringify value, null, 2
                    else if lodash.isError arg
                        arrError = []
                        arrError.push arg.friendlyMessage if arg.friendlyMessage?
                        arrError.push arg.reason if arg.reason?
                        arrError.push arg.code if arg.code?
                        arrError.push arg.message
                        arrError.push arg.stack
                        stringified = arrError.join separator
                    else if lodash.isObject arg
                        stringified = JSON.stringify arg, null, 2
                    else
                        stringified = arg.toString()
                catch ex
                    stringified = arg.toString()

                # Compact log lines?
                if settings.logger.compact
                    stringified = stringified.replace(/(\r\n|\n|\r)/gm, &quot;&quot;).replace(/  +/g, &quot; &quot;);

                separated.push stringified

        # Append IP address, if `serverIP` is set.
        if settings.logger.sendIP
            try
                serverIP = utils.network.getSingleIPv4() or utils.network.getSingleIPv6()
                serverIP = null if serverIP is &quot;&quot;
            catch ex
                serverIP = null

        separated.push &quot;IP #{serverIP}&quot; if serverIP?

        # Return single string log message.
        return separated.join separator

# Singleton implementation
# --------------------------------------------------------------------------
Logger.getInstance = -&gt;
    @instance = new Logger() if not @instance?
    return @instance

module.exports = Logger.getInstance()</pre></div></div></div><script src="https://code.jquery.com/jquery-3.2.1.min.js"></script><script src="../bootstrap/js/bootstrap.min.js"></script><script src="../google-code-prettify/prettify.js"></script><script src="../script.js"></script><script src="../group-examples.js"></script><a href="https://github.com/igoramadas/expresser"><img class="github-ribbon" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub"></a></body></html>