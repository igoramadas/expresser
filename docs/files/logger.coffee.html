<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Expresser - logger.coffee</title><script>if (location.protocol.match(/^http/) && location.pathname.match('\.html') === null && location.pathname.slice(-1) !== '/') {
  location.href = location.href + '/';
}</script><link href="../bootstrap-3.2.0-dist/css/bootstrap.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script><script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]--><link href="../google-code-prettify/prettify.css" rel="stylesheet" type="text/css"><link href="../style.css" rel="stylesheet" type="text/css"></head><body data-spy="scroll" data-target=".sidebar"><nav class="navbar navbar-default navbar-fixed-top" role="navigation"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#top-navigation-collapse"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="top-navigation-collapse"><ul class="nav navbar-nav"><li><a href="../index.html">Home</a></li><li><a href="../classes/index.html">Classes</a></li><li class="dropdown active"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Files - logger.coffee <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../files/app.coffee.html">app.coffee</a></li><li><a href="../files/events.coffee.html">events.coffee</a></li><li><a href="../files/logger.coffee.html">logger.coffee</a></li><li><a href="../files/settings.coffee.html">settings.coffee</a></li><li><a href="../files/utils.coffee.html">utils.coffee</a></li><li><a href="../files/aws.dynamodb.coffee.html">aws/dynamodb.coffee</a></li><li><a href="../files/aws.index.coffee.html">aws/index.coffee</a></li><li><a href="../files/aws.s3.coffee.html">aws/s3.coffee</a></li><li><a href="../files/aws.sns.coffee.html">aws/sns.coffee</a></li><li><a href="../files/cron.index.coffee.html">cron/index.coffee</a></li><li><a href="../files/downloader.index.coffee.html">downloader/index.coffee</a></li><li><a href="../files/gcloud.datastore.coffee.html">gcloud/datastore.coffee</a></li><li><a href="../files/gcloud.index.coffee.html">gcloud/index.coffee</a></li><li><a href="../files/gcloud.storage.coffee.html">gcloud/storage.coffee</a></li><li><a href="../files/logger-file.index.coffee.html">logger-file/index.coffee</a></li><li><a href="../files/logger-logentries.index.coffee.html">logger-logentries/index.coffee</a></li><li><a href="../files/logger-loggly.index.coffee.html">logger-loggly/index.coffee</a></li><li><a href="../files/mailer.index.coffee.html">mailer/index.coffee</a></li><li><a href="../files/mailer.templates.coffee.html">mailer/templates.coffee</a></li><li><a href="../files/metrics.httpserver.coffee.html">metrics/httpserver.coffee</a></li><li><a href="../files/metrics.index.coffee.html">metrics/index.coffee</a></li><li><a href="../files/metrics.percentile.coffee.html">metrics/percentile.coffee</a></li><li><a href="../files/mongodb.index.coffee.html">mongodb/index.coffee</a></li><li><a href="../files/sockets.index.coffee.html">sockets/index.coffee</a></li><li><a href="../files/utils.browser.coffee.html">utils/browser.coffee</a></li><li><a href="../files/utils.data.coffee.html">utils/data.coffee</a></li><li><a href="../files/utils.io.coffee.html">utils/io.coffee</a></li><li><a href="../files/utils.network.coffee.html">utils/network.coffee</a></li><li><a href="../files/utils.system.coffee.html">utils/system.coffee</a></li></ul></li></ul><div class="options"><label class="checkbox"><input id="options-private" type="checkbox"> Private</label></div></div></div></nav><div class="container-fluid content"><div class="row"><div class="hidden-xs sidebar col-sm-3" data-spy="affix"><div class="cormo-sidenav"><div class="panel panel-default"><div class="panel-collapse collapse in" id="undefined_body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/app.coffee.html">app.coffee</a></li><li><a href="../files/events.coffee.html">events.coffee</a></li><li class="active"><a href="../files/logger.coffee.html">logger.coffee</a></li><li><a href="../files/settings.coffee.html">settings.coffee</a></li><li><a href="../files/utils.coffee.html">utils.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#aws__body">aws/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="aws__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/aws.dynamodb.coffee.html">dynamodb.coffee</a></li><li><a href="../files/aws.index.coffee.html">index.coffee</a></li><li><a href="../files/aws.s3.coffee.html">s3.coffee</a></li><li><a href="../files/aws.sns.coffee.html">sns.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#cron__body">cron/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="cron__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/cron.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#downloader__body">downloader/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="downloader__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/downloader.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#gcloud__body">gcloud/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="gcloud__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/gcloud.datastore.coffee.html">datastore.coffee</a></li><li><a href="../files/gcloud.index.coffee.html">index.coffee</a></li><li><a href="../files/gcloud.storage.coffee.html">storage.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-file__body">logger-file/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-file__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-file.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-logentries__body">logger-logentries/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-logentries__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-logentries.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-loggly__body">logger-loggly/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-loggly__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-loggly.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#mailer__body">mailer/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="mailer__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/mailer.index.coffee.html">index.coffee</a></li><li><a href="../files/mailer.templates.coffee.html">templates.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#metrics__body">metrics/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="metrics__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/metrics.httpserver.coffee.html">httpserver.coffee</a></li><li><a href="../files/metrics.index.coffee.html">index.coffee</a></li><li><a href="../files/metrics.percentile.coffee.html">percentile.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#mongodb__body">mongodb/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="mongodb__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/mongodb.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#sockets__body">sockets/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="sockets__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/sockets.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#utils__body">utils/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="utils__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/utils.browser.coffee.html">browser.coffee</a></li><li><a href="../files/utils.data.coffee.html">data.coffee</a></li><li><a href="../files/utils.io.coffee.html">io.coffee</a></li><li><a href="../files/utils.network.coffee.html">network.coffee</a></li><li><a href="../files/utils.system.coffee.html">system.coffee</a></li></ul></div></div></div></div><div class="col-sm-9 col-sm-offset-3"><section><h1>logger.coffee</h1></section><pre class="prettyprint"># EXPRESSER LOGGER
# --------------------------------------------------------------------------
# Handles server logging using local files, Logentries, Loggly and other
# transports available as plugins.
# Multiple services can be enabled at the same time.
class Logger
    newInstance: -&gt; return new Logger()

    chalk = require &quot;chalk&quot;
    events = require &quot;./events.coffee&quot;
    fs = require &quot;fs&quot;
    lodash = require &quot;lodash&quot;
    moment = require &quot;moment&quot;
    path = require &quot;path&quot;
    settings = require &quot;./settings.coffee&quot;
    utils = require &quot;./utils.coffee&quot;

    # PUBLIC PROPERTIES
    # --------------------------------------------------------------------------

    # @property {Object} Holds a list of available logging drivers.
    drivers: {}

    # @property {Object} List of registered transports.
    transports: {}

    # @property {Method} Custom method to call on every log request.
    onLog: null

    # INIT
    # --------------------------------------------------------------------------

    # Init the Logger module. Verify which services are set, and add the necessary transports.
    # IP address will be appended to logs depending on the settings.
    init: =&gt;
        events.emit &quot;Logger.before.init&quot;

        if settings.logger.uncaughtException
            @debug &quot;Logger.init&quot;, &quot;Catching unhandled exceptions.&quot;

            process.on &quot;uncaughtException&quot;, (err) =&gt;
                try
                    @error &quot;Unhandled exception!&quot;, err.message, err.stack
                catch ex
                    console.error &quot;Unhandled exception!&quot;, err.message, err.stack, ex

        # Deprecated settings.logger.maxDeepLevel in favour of maxDepth.
        if settings.logger.maxDeepLevel?
            @deprecated &quot;settings.logger.maxDeepLevel&quot;, &quot;Please use settings.logger.maxDepth.&quot;
            settings.logger.maxDepth = settings.logger.maxDeepLevel

        @setEvents()

        events.emit &quot;Logger.on.init&quot;
        delete @init

    # Bind events.
    setEvents: -&gt;
        events.on &quot;Logger.register&quot;, @register.bind(this)
        events.on &quot;Logger.console&quot;, @console
        events.on &quot;Logger.debug&quot;, @debug
        events.on &quot;Logger.info&quot;, @info
        events.on &quot;Logger.warn&quot;, @warn
        events.on &quot;Logger.error&quot;, @error
        events.on &quot;Logger.critical&quot;, @critical

    # IMPLEMENTATION
    # -------------------------------------------------------------------------

    # Register a Logger transport. This is called by Logger plugins.
    # @param {String} id Unique ID of the transport to be registered.
    register: (id, driver, options) -&gt;
        if not @drivers[driver]?
            console.error &quot;Logger.register&quot;, &quot;The transport #{driver} is not installed! Please check if plugin expresser-logger-#{driver} is available on the current environment.&quot;
            return false
        else
            if settings.general.debug
                console.log &quot;Logger.register&quot;, id, driver, options

            @transports[id] = @drivers[driver].getTransport options
            @transports[id].log = @drivers[driver].log
            @transports[id].debug = @debug
            @transports[id].info = @info
            @transports[id].warn = @warn
            @transports[id].error = @error
            @transports[id].critical = @critical

            return @transports[id]

    # Unregister a Logger transport.
    # @param {String} id Unique ID of the transport to be unregistered.
    unregister: (id) -&gt;
        delete @transports[id]

    # LOG METHODS
    # --------------------------------------------------------------------------

    # Log to the console.
    # @param {String} logType The log type (for example: warning, error, info, security, etc).
    # @param {Array} args Array of arguments to be stringified and logged.
    # @param {Boolean} doNotParse If true, message won't be parsed and cleaned using the argsCleaner helper.
    # @return {String} The human readable log sent to the console.
    console: (logType, msg, doNotParse) -&gt;
        return if process.env.NODE_ENV is &quot;test&quot; and logType isnt &quot;test&quot;

        timestamp = moment().format &quot;HH:mm:ss.SS&quot;

        # Only parse message if doNotClean is false or unset.
        msg = @getMessage msg if not doNotParse

        if console[logType]? and logType isnt &quot;debug&quot;
            method = console[logType]
        else
            method = console.log

        # Get styles (text colour, bold, italic etc...) for the correlated log type.
        styles = settings.logger.styles[logType]

        if styles?
            chalkStyle = chalk
            chalkStyle = chalkStyle[s] for s in styles
        else
            chalkStyle = chalk.white

        method timestamp, chalkStyle msg

        return msg

    # Internal generic log method.
    # @param {String} logType The log type (for example: warning, error, info, security, etc).
    # @param {Array} args Array to be stringified and logged.
    # @return {String} The human readable log line.
    log: (logType, args) -&gt;
        return if settings.logger.levels?.indexOf(logType) &lt; 0 and not settings.general.debug

        # Get message out of the arguments.
        msg = @getMessage args

        # Dispatch to all registered transports.
        for key, obj of @transports
            obj.log logType, msg, true

        # Log to the console depending on `console` setting.
        if settings.logger.console
            @console logType, msg, true

        # Custom onLog callback?
        @onLog? logType, args

        return msg

    # Log to the active transports as `debug`, only if the debug flag is enabled.
    # All arguments are transformed to readable strings.
    debug: -&gt;
        args = Array.prototype.slice.call arguments
        args.unshift &quot;DEBUG&quot;
        @log &quot;debug&quot;, args

    # Log to the active transports as `info`.
    # All arguments are transformed to readable strings.
    info: -&gt;
        args = Array.prototype.slice.call arguments
        args.unshift &quot;INFO&quot;
        @log &quot;info&quot;, args

    # Log to the active transports as `warn`.
    # All arguments are transformed to readable strings.
    warn: -&gt;
        args = Array.prototype.slice.call arguments
        args.unshift &quot;WARN&quot;
        @log &quot;warn&quot;, args

    # Log to the active transports as `error`.
    # All arguments are transformed to readable strings.
    error: -&gt;
        args = Array.prototype.slice.call arguments
        args.unshift &quot;ERROR&quot;
        @log &quot;error&quot;, args

    # Log to the active transports as `critical`.
    # All arguments are transformed to readable strings.
    critical: -&gt;
        args = Array.prototype.slice.call arguments
        args.unshift &quot;CRITICAL&quot;
        @log &quot;critical&quot;, args

    # HELPER METHODS
    # --------------------------------------------------------------------------

    # Helper to log to console about methods / features deprecation.
    deprecated: (func, message) -&gt;
        message = &quot;#{func} is deprecated. #{message}&quot;
        @console &quot;deprecated&quot;, message
        return {error: &quot;Deprecated&quot;, message: message}

    # Helper to log to console that module is not enabled on settings.
    notEnabled: (module, func) -&gt;
        @console &quot;debug&quot;, &quot;#{module}.#{func} abort! #{module} is not enabled.&quot;
        return {error: &quot;Module #{module} is not enabled.&quot;, notEnabled: true}

    # Cleans the arguments passed according to the `removeFields` setting.
    # The maximum level deep down the object is defined by the `maxDeepLevel`.
    # @return {Arguments} Arguments with private fields obfuscated.
    # @private
    argsCleaner: -&gt;
        funcText = &quot;[Function]&quot;
        unreadableText = &quot;[Unreadable]&quot;
        max = settings.logger.maxDepth - 1
        result = []

        # Recursive cleaning function.
        cleaner = (obj, index) -&gt;
            i = 0

            if lodash.isArray obj
                while i &lt; obj.length
                    if index &gt; max
                        obj[i] = &quot;...&quot;
                    else if lodash.isFunction obj[i]
                        obj[i] = funcText
                    else
                        cleaner obj[i], index + 1
                    i++

            else if lodash.isObject obj
                for key, value of obj
                    try
                        if index &gt; max
                            obj[key] = &quot;...&quot;
                        else if settings.logger.obfuscateFields?.indexOf(key) &gt;=0
                            obj[key] = &quot;***&quot;
                        else if settings.logger.maskFields?[key]?
                            if lodash.isObject value
                                maskedValue = value.value or value.text or value.contents or value.data or &quot;&quot;
                            else
                                maskedValue = value.toString()
                            obj[key] = utils.data.maskString maskedValue, &quot;*&quot;, settings.logger.maskFields[key]
                        else if settings.logger.removeFields?.indexOf(key) &gt;=0
                            delete obj[key]
                        else if lodash.isArray value
                            while i &lt; value.length
                                cleaner value[i], index + 1
                                i++
                        else if lodash.isFunction value
                            obj[key] = funcText
                        else if lodash.isObject value
                            cleaner value, index + 1
                    catch ex
                        delete obj[key]
                        obj[key] = unreadableText

        # Iterate arguments and execute cleaner on objects.
        for argKey, arg of arguments
            try
                if lodash.isArray arg
                    for a in arg
                        if lodash.isError a
                            result.push a
                        else if lodash.isObject a
                            cloned = lodash.cloneDeep a
                            cleaner cloned, 0
                            result.push cloned
                        else if lodash.isFunction a
                            result.push funcText
                        else
                            result.push a
                else
                    result.push a

            catch ex
                console.warn &quot;Logger.argsCleaner&quot;, argKey, ex

        return result

    # Returns a human readable message out of the arguments.
    # @return {String} The human readable, parsed JSON message.
    # @private
    getMessage: (params) -&gt;
        separated = []
        args = []

        if arguments.length &gt; 1
            args.push value for value in arguments
        else if lodash.isArray params
            args.push value for value in params
        else
            args.push params

        args = @argsCleaner args

        # Parse all arguments and stringify objects. Please note that fields defined
        # on the `removeFields` setting won't be added to the message.
        for arg in args
            if arg?
                stringified = &quot;&quot;

                try
                    if lodash.isArray arg
                        for value in arg
                            stringified += JSON.stringify value, null, 2
                    else if lodash.isError arg
                        stringified = arg.message + &quot; &quot; + arg.stack
                    else if lodash.isObject arg
                        stringified = JSON.stringify arg, null, 2
                    else
                        stringified = arg.toString()
                catch ex
                    stringified = arg.toString()

                # Compact log lines?
                if settings.logger.compact
                    stringified = stringified.replace(/(\r\n|\n|\r)/gm, &quot;&quot;).replace(/  +/g, &quot; &quot;);

                separated.push stringified

        # Append IP address, if `serverIP` is set.
        try
            serverIP = utils.system.getIP true if settings.logger.sendIP
            serverIP = null if serverIP.error
        catch ex
            serverIP = null

        separated.push &quot;IP #{serverIP}&quot; if serverIP?

        separator = settings.logger.separator

        # Return single string log message.
        return separated.join separator

# Singleton implementation
# --------------------------------------------------------------------------
Logger.getInstance = -&gt;
    @instance = new Logger() if not @instance?
    return @instance

module.exports = Logger.getInstance()</pre></div></div></div><script src="http://code.jquery.com/jquery-1.11.0.min.js"></script><script src="../bootstrap-3.2.0-dist/js/bootstrap.min.js"></script><script src="../google-code-prettify/prettify.js"></script><script src="../script.js"></script><script src="../group-examples.js"></script><a href="#{self.github.repository}"><img class="github-ribbon" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub"></a></body></html>