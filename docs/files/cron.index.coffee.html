<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Expresser - cron/index.coffee</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-9331973-3"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-9331973-3');
</script><script>if (location.protocol.match(/^http/) && location.pathname.match('\.html') === null && location.pathname.slice(-1) !== '/') {
  location.href = location.href + '/';
}</script><link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script><script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]--><link href="../google-code-prettify/prettify.css" rel="stylesheet" type="text/css"><link href="../style.css" rel="stylesheet" type="text/css"></head><body data-spy="scroll" data-target=".sidebar"><nav class="navbar navbar-default navbar-fixed-top" role="navigation"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#top-navigation-collapse"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="top-navigation-collapse"><ul class="nav navbar-nav"><li><a href="../index.html">Home</a></li><li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Guides <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../guides/App.html">App</a></li><li><a href="../guides/Errors.html">Errors</a></li><li><a href="../guides/Events.html">Events</a></li><li><a href="../guides/Logger.html">Logger</a></li><li><a href="../guides/Settings.html">Settings</a></li><li><a href="../guides/Utils.html">Utils</a></li></ul></li><li><a href="../classes/index.html">Classes</a></li><li class="dropdown active"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Files - cron/index.coffee <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../files/app.coffee.html">app.coffee</a></li><li><a href="../files/errors.coffee.html">errors.coffee</a></li><li><a href="../files/events.coffee.html">events.coffee</a></li><li><a href="../files/index.coffee.html">index.coffee</a></li><li><a href="../files/logger.coffee.html">logger.coffee</a></li><li><a href="../files/settings.coffee.html">settings.coffee</a></li><li><a href="../files/utils.coffee.html">utils.coffee</a></li><li><a href="../files/aws.dynamodb.coffee.html">aws/dynamodb.coffee</a></li><li><a href="../files/aws.index.coffee.html">aws/index.coffee</a></li><li><a href="../files/aws.s3.coffee.html">aws/s3.coffee</a></li><li><a href="../files/aws.sns.coffee.html">aws/sns.coffee</a></li><li><a href="../files/cron.index.coffee.html">cron/index.coffee</a></li><li><a href="../files/downloader.index.coffee.html">downloader/index.coffee</a></li><li><a href="../files/gcloud.datastore.coffee.html">gcloud/datastore.coffee</a></li><li><a href="../files/gcloud.index.coffee.html">gcloud/index.coffee</a></li><li><a href="../files/gcloud.storage.coffee.html">gcloud/storage.coffee</a></li><li><a href="../files/logger-file.index.coffee.html">logger-file/index.coffee</a></li><li><a href="../files/logger-logentries.index.coffee.html">logger-logentries/index.coffee</a></li><li><a href="../files/logger-loggly.index.coffee.html">logger-loggly/index.coffee</a></li><li><a href="../files/mailer.index.coffee.html">mailer/index.coffee</a></li><li><a href="../files/mailer.templates.coffee.html">mailer/templates.coffee</a></li><li><a href="../files/metrics.httpserver.coffee.html">metrics/httpserver.coffee</a></li><li><a href="../files/metrics.index.coffee.html">metrics/index.coffee</a></li><li><a href="../files/metrics.percentile.coffee.html">metrics/percentile.coffee</a></li><li><a href="../files/mongodb.index.coffee.html">mongodb/index.coffee</a></li><li><a href="../files/sockets.index.coffee.html">sockets/index.coffee</a></li><li><a href="../files/utils.browser.coffee.html">utils/browser.coffee</a></li><li><a href="../files/utils.data.coffee.html">utils/data.coffee</a></li><li><a href="../files/utils.io.coffee.html">utils/io.coffee</a></li><li><a href="../files/utils.network.coffee.html">utils/network.coffee</a></li><li><a href="../files/utils.system.coffee.html">utils/system.coffee</a></li></ul></li></ul><div class="options"><label class="checkbox"><input id="options-private" type="checkbox"> Private</label></div></div></div></nav><div class="container-fluid content"><div class="row"><div class="hidden-xs sidebar col-sm-3" data-spy="affix"><div class="cormo-sidenav"><div class="panel panel-default"><div class="panel-collapse collapse in" id="undefined_body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/app.coffee.html">app.coffee</a></li><li><a href="../files/errors.coffee.html">errors.coffee</a></li><li><a href="../files/events.coffee.html">events.coffee</a></li><li><a href="../files/index.coffee.html">index.coffee</a></li><li><a href="../files/logger.coffee.html">logger.coffee</a></li><li><a href="../files/settings.coffee.html">settings.coffee</a></li><li><a href="../files/utils.coffee.html">utils.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#aws__body">aws/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="aws__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/aws.dynamodb.coffee.html">dynamodb.coffee</a></li><li><a href="../files/aws.index.coffee.html">index.coffee</a></li><li><a href="../files/aws.s3.coffee.html">s3.coffee</a></li><li><a href="../files/aws.sns.coffee.html">sns.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#cron__body">cron/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="cron__body"><ul class="nav nav-pills nav-stacked"><li class="active"><a href="../files/cron.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#downloader__body">downloader/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="downloader__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/downloader.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#gcloud__body">gcloud/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="gcloud__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/gcloud.datastore.coffee.html">datastore.coffee</a></li><li><a href="../files/gcloud.index.coffee.html">index.coffee</a></li><li><a href="../files/gcloud.storage.coffee.html">storage.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-file__body">logger-file/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-file__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-file.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-logentries__body">logger-logentries/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-logentries__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-logentries.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-loggly__body">logger-loggly/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-loggly__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-loggly.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#mailer__body">mailer/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="mailer__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/mailer.index.coffee.html">index.coffee</a></li><li><a href="../files/mailer.templates.coffee.html">templates.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#metrics__body">metrics/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="metrics__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/metrics.httpserver.coffee.html">httpserver.coffee</a></li><li><a href="../files/metrics.index.coffee.html">index.coffee</a></li><li><a href="../files/metrics.percentile.coffee.html">percentile.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#mongodb__body">mongodb/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="mongodb__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/mongodb.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#sockets__body">sockets/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="sockets__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/sockets.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#utils__body">utils/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="utils__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/utils.browser.coffee.html">browser.coffee</a></li><li><a href="../files/utils.data.coffee.html">data.coffee</a></li><li><a href="../files/utils.io.coffee.html">io.coffee</a></li><li><a href="../files/utils.network.coffee.html">network.coffee</a></li><li><a href="../files/utils.system.coffee.html">system.coffee</a></li></ul></div></div></div></div><div class="col-sm-9 col-sm-offset-3"><section><h1>cron/index.coffee</h1></section><pre class="prettyprint"># EXPRESSER CRON
# -----------------------------------------------------------------------------
fs = require &quot;fs&quot;
path = require &quot;path&quot;
errors = null
events = null
lodash = null
logger = null
moment = null
settings = null
utils = null

# Handle scheduled cron jobs. You can use intervals (seconds) or specific
# times to trigger jobs, and the module will take care of setting the proper timers.
# Jobs are added using &quot;job&quot; objects with id, schedule, callback and other options.
class Cron

    @priority: 3

    ##
    # The jobs collection.
    # @property
    #@ type Array
    @jobs: []

    # INIT
    # -------------------------------------------------------------------------

    # Init the cron manager. If `loadOnInit` setting is true, the `cron.json`
    # file will be parsed and loaded straight away (if there's one).
    @init: -&gt;
        events = @expresser.events
        lodash = @expresser.libs.lodash
        logger = @expresser.logger
        moment = @expresser.libs.moment
        settings = @expresser.settings
        utils = @expresser.utils

        logger.debug &quot;Cron.init&quot;
        events.emit &quot;Cron.before.init&quot;

        @setEvents()

        @load settings.cron.defaultFilename if settings.cron.loadOnInit

        events.emit &quot;Cron.on.init&quot;
        delete @init

    # Bind events.
    @setEvents: -&gt;
        events.on &quot;Cron.load&quot;, @load
        events.on &quot;Cron.start&quot;, @start
        events.on &quot;Cron.stop&quot;, @stop
        events.on &quot;Cron.add&quot;, @add
        events.on &quot;Cron.remove&quot;, @remove

    # Load jobs from the specified (default cron.json) file.
    # If `autoStart` is true, it will automatically call the `start` method after loading.
    # @param {String} filename Path to the JSON file containing jobs, optional, default is &quot;cron.json&quot;.
    # @param {Object} options Options to be passed when loading cron jobs.
    # @option options {String} filename Name of file to be loaded (in case filename was not set on first parameter)
    # @option options {String} basePath Sets the base path of modules when requiring them.
    # @option options {Boolean} autoStart If true, call `start` after loading.
    @load: (filename, options) -&gt;
        logger.debug &quot;Cron.load&quot;, filename, options

        if not settings.cron.enabled
            return logger.notEnabled(&quot;Cron&quot;)

        # Set default options.
        options = filename if lodash.isObject filename
        options = lodash.defaults options, {autoStart: settings.cron.autoStart, basePath: settings.cron.basePath}

        # Make sure filename is set.
        filename = options.filename if not filename?

        # Get full path to the passed json file.
        filepath = utils.io.getFilePath filename

        # Found the cron json file? Read it.
        if filepath?
            basename = path.basename filepath
            cronJson = &quot;&quot;

            try
                cronJson = fs.readFileSync filepath, {encoding: settings.general.encoding}
                cronJson = utils.data.minifyJson cronJson
            catch ex
                err = &quot;Could not parse #{filepath} as JSON. #{ex.name} #{ex.message}&quot;
                logger.error &quot;Cron.load&quot;, err
                throw {error: &quot;Invalid JSON&quot;, message: err}

            # Iterate jobs, but do not add if job's `enabled` is false.
            for key, data of cronJson
                module = require(path.dirname(require.main.filename) + &quot;/&quot; + options.basePath + key)

                # Only proceed if the cronDisabled flag is not present on the module.
                # If no ID is set for the job, use module key + callback name.
                if module.cronDisabled isnt true
                    for d in data
                        if not d.enabled? or d.enabled
                            cb = module[d.callback]
                            job = d
                            job.filename = filename
                            job.module = key
                            job.id = key + &quot;.&quot; + d.callback if not job.id?
                            job.callback = cb
                            job.timer = null
                            @add job
                        else
                            logger.info &quot;Cron.load&quot;, filename, key, d.callback, &quot;Job 'enabled' is false. Skip!&quot;
                else
                    logger.info &quot;Cron.load&quot;, filename, &quot;Module has 'cronDisabled' set. Skip!&quot;

            # Auto starting jobs is optional.
            if options.autoStart
                if filename
                    @start {filename: filename}
                else
                    @start()

            logger.info &quot;Cron.load&quot;, &quot;#{basename} loaded.&quot;, options
        else
            err = &quot;Cron file #{filename} not found.&quot;
            logger.error &quot;Cron.load&quot;, err
            throw {error: &quot;Not found&quot;, message: &quot;Could not load cron file #{filename}.&quot;}

    # METHODS
    # -------------------------------------------------------------------------

    # Start the specified cron job. If no `id` is specified, all jobs will be started.
    # A filter can also be passed as an object. For example to start all jobs for
    # the module &quot;email&quot;, use start({module: &quot;email&quot;}).
    # @param {String} idOrFilter The job id or filter, optional (if not specified, start everything).
    @start: (idOrFilter) -&gt;
        logger.debug &quot;Cron.start&quot;, idOrFilter

        if not settings.cron.enabled
            return logger.notEnabled(&quot;Cron&quot;)

        if not idOrFilter?
            logger.info &quot;Cron.start&quot;, &quot;All jobs&quot;
            arr = @jobs

        if lodash.isString idOrFilter or lodash.isNumber idOrFilter
            logger.info &quot;Cron.start&quot;, idOrFilter
            arr = lodash.find @jobs, {id: idOrFilter.toString()}
        else
            logger.info &quot;Cron.start&quot;, idOrFilter
            arr = lodash.find @jobs, idOrFilter

        if not arr? or arr.length &lt; 1
            filterString = idOrFilter
            filterString = JSON.stringify filterString, null, 0 if lodash.isObject filterString
            logger.warn &quot;Cron.start&quot;, &quot;No jobs matching #{filterString}.&quot;
            return {notFound: true}
        else
            for job in arr
                clearTimeout job.timer if job.timer?
                setTimer job

    # Stop the specified cron job. If no `id` is specified, all jobs will be stopped.
    # A filter can also be passed as an object. For example to stop all jobs for
    # the module &quot;mymodule&quot;, use stop({module: &quot;mymodule&quot;}).
    # @param {String} idOrFilter The job id or filter, optional (if not specified, stop everything).
    @stop: (idOrFilter) -&gt;
        logger.debug &quot;Cron.stop&quot;, idOrFilter

        if not idOrFilter?
            logger.info &quot;Cron.stop&quot;, &quot;All jobs&quot;
            arr = @jobs

        if lodash.isString idOrFilter or lodash.isNumber idOrFilter
            logger.info &quot;Cron.stop&quot;, idOrFilter
            arr = lodash.find @jobs, {id: idOrFilter.toString()}
        else
            logger.info &quot;Cron.stop&quot;, idOrFilter
            arr = lodash.find @jobs, idOrFilter

        if not arr? or arr.length &lt; 1
            filterString = idOrFilter
            filterString = JSON.stringify filterString, null, 0 if lodash.isObject filterString
            logger.warn &quot;Cron.stop&quot;, &quot;No jobs matching #{filterString}.&quot;
            return {notFound: true}
        else
            for job in arr
                clearTimeout job.timer if job.timer?
                job.timer = null

    # Add a scheduled job to the cron, passing a `job`.
    # You can also pass only the `job` if it has an id property.
    # @param {String} id The job ID, optional, overrides job.id in case it has one.
    # @param {Object} job The job object.
    # @option job {String} id The job ID, optional.
    # @option job [Integer, Array] schedule If a number assume it's the interval in seconds, otherwise a times array.
    # @option job {Method} callback The callback (job) to be triggered.
    # @option job {Boolean} once If true, the job will be triggered only once no matter which schedule it has.
    # @return {Object} Returns {error, job}, where job is the job object and error is the error message (if any).
    @add: (job) -&gt;
        logger.debug &quot;Cron.add&quot;, job

        if not settings.cron.enabled
            return logger.notEnabled(&quot;Cron&quot;)

        # Throw error if no `id` was provided.
        if not job.id? or job.id is &quot;&quot;
            err = &quot;Job must have an ID. Please set the job.id property.&quot;
            logger.error &quot;Cron.add&quot;, err
            throw {error: &quot;Missing job ID&quot;, message: err}

        # Throw error if job callback is not a valid function.
        if not lodash.isFunction job.callback
            err = &quot;Job #{job.id} callback is not a valid, please set job.callback to a valid Function.&quot;
            logger.error &quot;Cron.add&quot;, err
            throw {error: &quot;Missing job callback&quot;, message: err}

        # Find existing job.
        existing = lodash.find @jobs, {id: job.id}

        # Handle existing jobs.
        if existing?
            if settings.cron.allowReplacing
                clearTimeout existing.timer if existing.timer?
                existing.timer = null
            else
                err = &quot;Job #{job.id} already exists and 'allowReplacing' is false. Abort!&quot;
                logger.error &quot;Cron.add&quot;, err
                throw {error: &quot;Job exists&quot;, message: err}

        # Set `startTime` and `endTime` if not set.
        job.startTime = moment 0 if not job.startTime?
        job.endTime = moment 0 if not job.endTime?

        # Only create the timer if `autoStart` is not false, add to the jobs list.
        setTimer job if job.autoStart isnt false
        @jobs.push job

        return {job: job}

    # Remove and stop a current job. If job does not exist, a warning will be logged.
    # @param {String} id The job ID.
    @remove: (id) -&gt;
        existing = lodash.find @jobs, {id: id}

        # Job exists?
        if not existing?
            logger.warn &quot;Cron.remove&quot;, &quot;Job #{id} does not exist.&quot;
            return false

        # Clear timer and remove job from array.
        clearTimeout existing.timer if existing.timer?
        @jobs.splice existing

    # HELPERS
    # -------------------------------------------------------------------------

    # Helper to get the timeout value (ms) to the next job callback.
    # @private
    getTimeout = (job) -&gt;
        now = moment()
        nextDate = moment()

        # If `schedule` is not an array, parse it as integer / seconds.
        if lodash.isNumber job.schedule or lodash.isString job.schedule
            timeout = moment().add(job.schedule, &quot;s&quot;).valueOf() - now.valueOf()
        else
            minTime = &quot;99:99:99&quot;
            nextTime = &quot;99:99:99&quot;

            # Get the next and minimum times from `schedule`.
            for sc in job.schedule
                minTime = sc if sc &lt; minTime
                nextTime = sc if sc &lt; nextTime and sc &gt; nextDate.format(&quot;HH:mm:ss&quot;)

            # If no times were found for today then set for tomorrow, minimum time.
            if nextTime is &quot;99:99:99&quot;
                nextDate = nextDate.add 1, &quot;d&quot;
                nextTime = minTime

            # Return the timeout.
            arr = nextTime.split &quot;:&quot;
            dateValue = [nextDate.year(), nextDate.month(), nextDate.date(), parseInt(arr[0]), parseInt(arr[1]), parseInt(arr[2])]
            timeout = moment(dateValue).valueOf() - now.valueOf()

        return timeout

    # Helper to prepare and get a job callback function.
    # @private
    getCallback = (job) -&gt;
        callback = -&gt;
            logger.debug &quot;Cron&quot;, &quot;Job #{job.id} trigger.&quot;
            job.timer = null
            job.startTime = moment()
            job.endTime = moment()

            try
                # The parameters can be force set using &quot;params&quot;.
                # If not present, pass the job itself to the callback instead.
                if job.params
                    job.callback.apply job.callback, job.params
                else
                    job.callback job

                # Job end time should be set on the callback, but if it wasn't, we force set it here.
                job.endTime = moment() if job.startTime is job.endTime
            catch ex
                logger.error &quot;Cron.getCallback&quot;, &quot;Could not run job.&quot;, ex.message, ex.stack

            # Only reset timer if once is not true.
            setTimer job if not job.once

        # Return generated callback.
        return callback

    # Helper to get a timer / interval based on the defined options.
    # @private
    setTimer = (job) -&gt;
        logger.debug &quot;Cron.setTimer&quot;, job.id, job.description, job.schedule

        callback = getCallback job

        # Get the correct schedule / timeout value.
        schedule = job.schedule
        schedule = moment.duration(schedule).asMilliseconds() if not lodash.isNumber schedule

        # Make sure timer is not running.
        clearTimeout job.timer if job.timer?

        # Set the timeout based on the defined schedule.
        timeout = getTimeout job
        job.timer = setTimeout callback, timeout
        job.nextRun = moment().add timeout, &quot;ms&quot;

# Exports
# -----------------------------------------------------------------------------
module.exports = Cron</pre></div></div></div><script src="https://code.jquery.com/jquery-3.2.1.min.js"></script><script src="../bootstrap/js/bootstrap.min.js"></script><script src="../google-code-prettify/prettify.js"></script><script src="../script.js"></script><script src="../group-examples.js"></script><a href="https://github.com/igoramadas/expresser"><img class="github-ribbon" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub"></a></body></html>