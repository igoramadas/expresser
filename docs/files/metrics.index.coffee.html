<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Expresser - metrics/index.coffee</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-9331973-3"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-9331973-3');
</script><script>if (location.protocol.match(/^http/) && location.pathname.match('\.html') === null && location.pathname.slice(-1) !== '/') {
  location.href = location.href + '/';
}</script><link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script><script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]--><link href="../google-code-prettify/prettify.css" rel="stylesheet" type="text/css"><link href="../style.css" rel="stylesheet" type="text/css"></head><body data-spy="scroll" data-target=".sidebar"><nav class="navbar navbar-default navbar-fixed-top" role="navigation"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#top-navigation-collapse"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="top-navigation-collapse"><ul class="nav navbar-nav"><li><a href="../index.html">Home</a></li><li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Guides <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../guides/App.html">App</a></li><li><a href="../guides/Errors.html">Errors</a></li><li><a href="../guides/Events.html">Events</a></li><li><a href="../guides/Logger.html">Logger</a></li><li><a href="../guides/Settings.html">Settings</a></li><li><a href="../guides/Utils.html">Utils</a></li></ul></li><li><a href="../classes/index.html">Classes</a></li><li class="dropdown active"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Files - metrics/index.coffee <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../files/app.coffee.html">app.coffee</a></li><li><a href="../files/errors.coffee.html">errors.coffee</a></li><li><a href="../files/events.coffee.html">events.coffee</a></li><li><a href="../files/index.coffee.html">index.coffee</a></li><li><a href="../files/logger.coffee.html">logger.coffee</a></li><li><a href="../files/settings.coffee.html">settings.coffee</a></li><li><a href="../files/utils.coffee.html">utils.coffee</a></li><li><a href="../files/aws.dynamodb.coffee.html">aws/dynamodb.coffee</a></li><li><a href="../files/aws.index.coffee.html">aws/index.coffee</a></li><li><a href="../files/aws.s3.coffee.html">aws/s3.coffee</a></li><li><a href="../files/aws.sns.coffee.html">aws/sns.coffee</a></li><li><a href="../files/cron.index.coffee.html">cron/index.coffee</a></li><li><a href="../files/cron.job.coffee.html">cron/job.coffee</a></li><li><a href="../files/downloader.index.coffee.html">downloader/index.coffee</a></li><li><a href="../files/gcloud.datastore.coffee.html">gcloud/datastore.coffee</a></li><li><a href="../files/gcloud.index.coffee.html">gcloud/index.coffee</a></li><li><a href="../files/gcloud.storage.coffee.html">gcloud/storage.coffee</a></li><li><a href="../files/logger-file.index.coffee.html">logger-file/index.coffee</a></li><li><a href="../files/logger-logentries.index.coffee.html">logger-logentries/index.coffee</a></li><li><a href="../files/logger-loggly.index.coffee.html">logger-loggly/index.coffee</a></li><li><a href="../files/mailer.index.coffee.html">mailer/index.coffee</a></li><li><a href="../files/mailer.templates.coffee.html">mailer/templates.coffee</a></li><li><a href="../files/metrics.httpserver.coffee.html">metrics/httpserver.coffee</a></li><li><a href="../files/metrics.index.coffee.html">metrics/index.coffee</a></li><li><a href="../files/metrics.percentile.coffee.html">metrics/percentile.coffee</a></li><li><a href="../files/mongodb.index.coffee.html">mongodb/index.coffee</a></li><li><a href="../files/sockets.index.coffee.html">sockets/index.coffee</a></li><li><a href="../files/utils.browser.coffee.html">utils/browser.coffee</a></li><li><a href="../files/utils.data.coffee.html">utils/data.coffee</a></li><li><a href="../files/utils.io.coffee.html">utils/io.coffee</a></li><li><a href="../files/utils.network.coffee.html">utils/network.coffee</a></li><li><a href="../files/utils.system.coffee.html">utils/system.coffee</a></li></ul></li></ul><div class="options"><label class="checkbox"><input id="options-private" type="checkbox"> Private</label></div></div></div></nav><div class="container-fluid content"><div class="row"><div class="hidden-xs sidebar col-sm-3" data-spy="affix"><div class="cormo-sidenav"><div class="panel panel-default"><div class="panel-collapse collapse in" id="undefined_body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/app.coffee.html">app.coffee</a></li><li><a href="../files/errors.coffee.html">errors.coffee</a></li><li><a href="../files/events.coffee.html">events.coffee</a></li><li><a href="../files/index.coffee.html">index.coffee</a></li><li><a href="../files/logger.coffee.html">logger.coffee</a></li><li><a href="../files/settings.coffee.html">settings.coffee</a></li><li><a href="../files/utils.coffee.html">utils.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#aws__body">aws/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="aws__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/aws.dynamodb.coffee.html">dynamodb.coffee</a></li><li><a href="../files/aws.index.coffee.html">index.coffee</a></li><li><a href="../files/aws.s3.coffee.html">s3.coffee</a></li><li><a href="../files/aws.sns.coffee.html">sns.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#cron__body">cron/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="cron__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/cron.index.coffee.html">index.coffee</a></li><li><a href="../files/cron.job.coffee.html">job.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#downloader__body">downloader/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="downloader__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/downloader.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#gcloud__body">gcloud/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="gcloud__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/gcloud.datastore.coffee.html">datastore.coffee</a></li><li><a href="../files/gcloud.index.coffee.html">index.coffee</a></li><li><a href="../files/gcloud.storage.coffee.html">storage.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-file__body">logger-file/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-file__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-file.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-logentries__body">logger-logentries/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-logentries__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-logentries.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-loggly__body">logger-loggly/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-loggly__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-loggly.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#mailer__body">mailer/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="mailer__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/mailer.index.coffee.html">index.coffee</a></li><li><a href="../files/mailer.templates.coffee.html">templates.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#metrics__body">metrics/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="metrics__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/metrics.httpserver.coffee.html">httpserver.coffee</a></li><li class="active"><a href="../files/metrics.index.coffee.html">index.coffee</a></li><li><a href="../files/metrics.percentile.coffee.html">percentile.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#mongodb__body">mongodb/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="mongodb__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/mongodb.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#sockets__body">sockets/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="sockets__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/sockets.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#utils__body">utils/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="utils__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/utils.browser.coffee.html">browser.coffee</a></li><li><a href="../files/utils.data.coffee.html">data.coffee</a></li><li><a href="../files/utils.io.coffee.html">io.coffee</a></li><li><a href="../files/utils.network.coffee.html">network.coffee</a></li><li><a href="../files/utils.system.coffee.html">system.coffee</a></li></ul></div></div></div></div><div class="col-sm-9 col-sm-offset-3"><section><h1>metrics/index.coffee</h1></section><pre class="prettyprint"># EXPRESSER METRICS
# --------------------------------------------------------------------------
# Gather application metrics and generate JSON output to be used by
# monitoring systems.
# &lt;!--
# @see settings.metrics
# --&gt;
class Metrics

    priority: 2

    events = null
    lodash = null
    logger = null
    moment = null
    percentile = require &quot;./percentile.coffee&quot;
    settings = null
    utils = null

    # This is where we store all metrics.
    metrics = {}

    # Timer to cleanup metrics.
    cleanupTimer = null

    # HTTP server module exposed to other modules.
    httpServer: require &quot;./httpserver.coffee&quot;

    # Init metrics and set up cleanup timer.
    init: -&gt;
        events = @expresser.events
        lodash = @expresser.libs.lodash
        logger = @expresser.logger
        moment = @expresser.libs.moment
        settings = @expresser.settings
        utils = @expresser.utils

        logger.debug &quot;Metrics.init&quot;
        events.emit &quot;Metrics.before.init&quot;

        # Make sure settings are valid.
        settings.metrics.httpServer = {} if not settings.metrics.httpServer?
        settings.metrics.intervals = [] if not settings.metrics.intervals?
        settings.metrics.percentiles = [] if not settings.metrics.percentiles?

        # Schedule the cleanup job.
        cleanupTimer = setInterval @cleanup, settings.metrics.cleanupInterval * 60 * 1000

        # Init the HTTP server module. Start if a valid port was set.
        @httpServer.init this
        @httpServer.start() if settings.metrics.httpServer.port? and settings.metrics.httpServer.autoStart

        events.emit &quot;Metrics.on.init&quot;
        delete @init

    # COUNTERS
    # -------------------------------------------------------------------------

    # Starts the counter for a specific metric. The data is optional.
    # @param {String} id ID of the metric to be started.
    # @param {Object} data Additional info about the current metric (URL data, for example).
    # @param {Number} expiresIn Optional, metric should expire in these amount of milliseconds if not ended.
    # @return {Object} Returns the metric object to be used later on `end`.
    start: (id, data, expiresIn) -&gt;
        logger.debug &quot;Metrics.start&quot;, obj, data, expiresIn

        if not settings.metrics.enabled
            return logger.notEnabled &quot;Metrics&quot;

        expiresIn = 0 if not expiresIn?

        obj = {}
        obj.id = id
        obj.data = data
        obj.startTime = moment().valueOf()

        # Should the metric expire (value in milliseconds)?
        if expiresIn &gt; 0
            expiryTimeout = =&gt;
                logger.debug &quot;Metrics.start&quot;, &quot;Expired!&quot;, obj
                obj.expired = true
                @end obj

            obj.timeout = setTimeout expiryTimeout, expiresIn

        # Create array of counters for the selected ID. Add metric to the beggining of the array.
        metrics[id] = [] if not metrics[id]?
        metrics[id].unshift obj

        return obj

    # Ends the counter for the specified metric, with an optional error to be passed along.
    # @param {Object} obj The metric object started previsouly on `start`.
    # @param {Object} error Optional error that ocurred while processing the metric.
    end: (obj, error) -&gt;
        obj.endTime = moment().valueOf()
        obj.duration = obj.endTime - obj.startTime
        obj.error = error

        # Clear the expiry timeout only if there's one.
        if obj.timeout?
            clearTimeout obj.timeout
            delete obj.timeout

        logger.debug &quot;Metrics.end&quot;, obj

    # Get collected data for the specified metric.
    # @param {String} id ID of the metric.
    get: (id) -&gt;
        return metrics[id]

    # CLEANUP
    # -------------------------------------------------------------------------

    # Clean collected metrics by removing data older than X minutes (defined on settings).
    # Please note that this runs on s schedule so you shouldn't need to call it manually, in most cases.
    cleanup: -&gt;
        logger.debug &quot;Metrics.cleanup&quot;

        if not settings.metrics.enabled
            return logger.notEnabled &quot;Metrics&quot;

        now = moment().valueOf()
        keyCounter = 0

        # Hold empty metric IDs.
        emptyIds = []

        # Iterate metrics collection.
        for key, obj of metrics
            i = obj.length - 1
            counter = 0
            keyCounter++

            if obj.length &lt; 1
                emptyIds.push key

            # Iterate requests for the current metrics, last to first.
            while i &gt;= 0
                diff = now - obj[i].startTime
                minutes = diff / 1000 / 60

                # Remove if verified as old. Otherwise, force finish the iteration.
                if minutes &gt; settings.metrics.expireAfter or settings.metrics.expireAfter is 0
                    obj.pop()
                    i--
                    counter++
                else
                    i = -1

        # Delete empty metrics if enabled on settings.
        if settings.metrics.cleanupEmpty and emptyIds.length &gt; 0
            for key in emptyIds
                delete metrics[key]

        if counter &gt; 0 and keyCounter &gt; 0
            logger.info &quot;Metrics.cleanup&quot;, &quot;Removed #{counter} records from #{keyCounter} keys.&quot;

    # OUTPUT
    # -------------------------------------------------------------------------

    # Generate the JSON output with all metrics.
    # @param {Object} options Options to filter the output. Available options are same as settings.metrics.
    # @return {Object} JSON output with relevant metrics.
    output: (options) -&gt;
        logger.debug &quot;Metrics.output&quot;, options
        utils.system.getInfo()

        # Get all metrics keys.
        keys = lodash.keys metrics

        # Set default options.
        options = {} if not options?
        options = lodash.defaultsDeep options, settings.metrics
        options.keys = keys if not options.keys?

        result = {}

        # Add server info to the output?
        if options.systemMetrics?.fields?.length &gt; 0
            serverInfo = utils.system.getInfo()
            serverKey = options.systemMetrics.key
            result[serverKey] = {}

            for f in options.systemMetrics.fields
                result[serverKey][f] = serverInfo[f]

        # For each different metric...
        for key in keys
            if not options?.keys? or options?.keys?.indexOf(key) &gt;= 0
                obj = metrics[key]

                result[key] = {total_calls: obj.length}

                # Iterate intervals (for example 1m, 5m and 15m) to get specific stats.
                for interval in options.intervals
                    result[key][&quot;last_#{interval}min&quot;] = getSummary options, obj, interval

                # Stats for last 3 calls.
                samples = []
                samples.push getLastSummary(obj[2]) if obj[2]?
                samples.push getLastSummary(obj[1]) if obj[1]?
                samples.push getLastSummary(obj[0]) if obj[0]?

                result[key].last_samples = samples

        logger.debug &quot;Metrics.output&quot;, options, result

        return result

    # Helper to generate summary for the specified interval.
    getSummary = (options, obj, interval) -&gt;
        now = moment().valueOf()
        values = []
        errorCount = 0
        expiredCount = 0
        i = 0

        # Iterate logged metrics, and get only if corresponding to the specified interval.
        while i &lt; obj.length
            diff = now - obj[i].startTime
            minutes = diff / 1000 / 60

            if minutes &lt;= interval
                values.push obj[i]
                errorCount++ if obj[i].error
                expiredCount++ if obj[i].expired
                i++
            else
                i = obj.length

        # All we care about is the duration for the relevant requests.
        durations = lodash.map values, &quot;duration&quot;
        avg = lodash.mean durations
        avg = 0 if isNaN avg

        # Create a summary with the important stats for each metric.
        summary = {}
        summary.calls = values.length
        summary.errors = errorCount
        summary.expired = expiredCount
        summary.min = lodash.min(durations) or 0
        summary.max = lodash.max(durations) or 0
        summary.avg = avg or 0
        summary.avg = Math.round summary.avg

        # Get percentiles based on settings.
        for perc in options.percentiles
            summary[&quot;p#{perc}&quot;] = percentile.calculate durations, perc

        return summary

    # Helper to get summary for last calls.
    getLastSummary = (value) -&gt;
        return {
            startTime: moment(value.startTime).format &quot;MMM Do - HH:mm:ss.SSSS&quot;
            duration: value.duration
            data: value.data
        }

# Singleton implementation
# -----------------------------------------------------------------------------
Metrics.getInstance = -&gt;
    @instance = new Metrics() if not @instance?
    return @instance

module.exports = exports = Metrics.getInstance()</pre></div></div></div><script src="https://code.jquery.com/jquery-3.2.1.min.js"></script><script src="../bootstrap/js/bootstrap.min.js"></script><script src="../google-code-prettify/prettify.js"></script><script src="../script.js"></script><script src="../group-examples.js"></script><a href="https://github.com/igoramadas/expresser"><img class="github-ribbon" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub"></a></body></html>