<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Expresser - app.coffee</title><script>if (location.protocol.match(/^http/) && location.pathname.match('\.html') === null && location.pathname.slice(-1) !== '/') {
  location.href = location.href + '/';
}</script><link href="../bootstrap-3.2.0-dist/css/bootstrap.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script><script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]--><link href="../google-code-prettify/prettify.css" rel="stylesheet" type="text/css"><link href="../style.css" rel="stylesheet" type="text/css"></head><body data-spy="scroll" data-target=".sidebar"><nav class="navbar navbar-default navbar-fixed-top" role="navigation"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#top-navigation-collapse"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="top-navigation-collapse"><ul class="nav navbar-nav"><li><a href="../index.html">Home</a></li><li><a href="../classes/index.html">Classes</a></li><li class="dropdown active"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Files - app.coffee <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../files/app.coffee.html">app.coffee</a></li><li><a href="../files/events.coffee.html">events.coffee</a></li><li><a href="../files/logger.coffee.html">logger.coffee</a></li><li><a href="../files/settings.coffee.html">settings.coffee</a></li><li><a href="../files/utils.coffee.html">utils.coffee</a></li><li><a href="../files/aws.dynamodb.coffee.html">aws/dynamodb.coffee</a></li><li><a href="../files/aws.index.coffee.html">aws/index.coffee</a></li><li><a href="../files/aws.s3.coffee.html">aws/s3.coffee</a></li><li><a href="../files/aws.sns.coffee.html">aws/sns.coffee</a></li><li><a href="../files/cron.index.coffee.html">cron/index.coffee</a></li><li><a href="../files/downloader.index.coffee.html">downloader/index.coffee</a></li><li><a href="../files/gcloud.datastore.coffee.html">gcloud/datastore.coffee</a></li><li><a href="../files/gcloud.index.coffee.html">gcloud/index.coffee</a></li><li><a href="../files/gcloud.storage.coffee.html">gcloud/storage.coffee</a></li><li><a href="../files/logger-file.index.coffee.html">logger-file/index.coffee</a></li><li><a href="../files/logger-logentries.index.coffee.html">logger-logentries/index.coffee</a></li><li><a href="../files/logger-loggly.index.coffee.html">logger-loggly/index.coffee</a></li><li><a href="../files/mailer.index.coffee.html">mailer/index.coffee</a></li><li><a href="../files/mailer.templates.coffee.html">mailer/templates.coffee</a></li><li><a href="../files/metrics.httpserver.coffee.html">metrics/httpserver.coffee</a></li><li><a href="../files/metrics.index.coffee.html">metrics/index.coffee</a></li><li><a href="../files/metrics.percentile.coffee.html">metrics/percentile.coffee</a></li><li><a href="../files/mongodb.index.coffee.html">mongodb/index.coffee</a></li><li><a href="../files/sockets.index.coffee.html">sockets/index.coffee</a></li><li><a href="../files/utils.browser.coffee.html">utils/browser.coffee</a></li><li><a href="../files/utils.data.coffee.html">utils/data.coffee</a></li><li><a href="../files/utils.io.coffee.html">utils/io.coffee</a></li><li><a href="../files/utils.network.coffee.html">utils/network.coffee</a></li><li><a href="../files/utils.system.coffee.html">utils/system.coffee</a></li></ul></li></ul><div class="options"><label class="checkbox"><input id="options-private" type="checkbox"> Private</label></div></div></div></nav><div class="container-fluid content"><div class="row"><div class="hidden-xs sidebar col-sm-3" data-spy="affix"><div class="cormo-sidenav"><div class="panel panel-default"><div class="panel-collapse collapse in" id="undefined_body"><ul class="nav nav-pills nav-stacked"><li class="active"><a href="../files/app.coffee.html">app.coffee</a></li><li><a href="../files/events.coffee.html">events.coffee</a></li><li><a href="../files/logger.coffee.html">logger.coffee</a></li><li><a href="../files/settings.coffee.html">settings.coffee</a></li><li><a href="../files/utils.coffee.html">utils.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#aws__body">aws/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="aws__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/aws.dynamodb.coffee.html">dynamodb.coffee</a></li><li><a href="../files/aws.index.coffee.html">index.coffee</a></li><li><a href="../files/aws.s3.coffee.html">s3.coffee</a></li><li><a href="../files/aws.sns.coffee.html">sns.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#cron__body">cron/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="cron__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/cron.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#downloader__body">downloader/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="downloader__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/downloader.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#gcloud__body">gcloud/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="gcloud__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/gcloud.datastore.coffee.html">datastore.coffee</a></li><li><a href="../files/gcloud.index.coffee.html">index.coffee</a></li><li><a href="../files/gcloud.storage.coffee.html">storage.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-file__body">logger-file/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-file__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-file.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-logentries__body">logger-logentries/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-logentries__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-logentries.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-loggly__body">logger-loggly/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-loggly__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-loggly.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#mailer__body">mailer/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="mailer__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/mailer.index.coffee.html">index.coffee</a></li><li><a href="../files/mailer.templates.coffee.html">templates.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#metrics__body">metrics/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="metrics__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/metrics.httpserver.coffee.html">httpserver.coffee</a></li><li><a href="../files/metrics.index.coffee.html">index.coffee</a></li><li><a href="../files/metrics.percentile.coffee.html">percentile.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#mongodb__body">mongodb/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="mongodb__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/mongodb.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#sockets__body">sockets/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="sockets__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/sockets.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#utils__body">utils/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="utils__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/utils.browser.coffee.html">browser.coffee</a></li><li><a href="../files/utils.data.coffee.html">data.coffee</a></li><li><a href="../files/utils.io.coffee.html">io.coffee</a></li><li><a href="../files/utils.network.coffee.html">network.coffee</a></li><li><a href="../files/utils.system.coffee.html">system.coffee</a></li></ul></div></div></div></div><div class="col-sm-9 col-sm-offset-3"><section><h1>app.coffee</h1></section><pre class="prettyprint"># EXPRESSER APP
# -----------------------------------------------------------------------------
express = require &quot;express&quot;
events = require &quot;./events.coffee&quot;
fs = require &quot;fs&quot;
http = require &quot;http&quot;
https = require &quot;https&quot;
lodash = require &quot;lodash&quot;
logger = require &quot;./logger.coffee&quot;
path = require &quot;path&quot;
settings = require &quot;./settings.coffee&quot;
util = require &quot;util&quot;
utils = require &quot;./utils.coffee&quot;

# Current node environment and HTTP server handler are set on init.
nodeEnv = null

###
# This is the &quot;core&quot; of an Expresser based application. The App wraps the
# Express server and its middlewares / routes, along with a few extra helpers.
###
class App
    newInstance: -&gt; return new App()

    ##
    # Exposes the Express app object to the outside.
    # @property
    # @type express-App
    expressApp: null

    ##
    # The underlying HTTP(s) server.
    # @property
    # @type http-Server
    webServer: null

    ##
    # The HTTP to HTTPS redirector server (only if settings.app.ssl.redirectorPort is set).
    # @property
    # @type httpServer
    redirectorServer: null

    ##
    # Additional middlewares to be used by the Express server.
    # These will be called before the default middlewares.
    # @property
    # @type Array
    prependMiddlewares: []

    ##
    # Additional middlewares to be used by the Express server.
    # These will be called after the default middlewares.
    # @property
    # @type Array
    appendMiddlewares: []

    # INIT
    # --------------------------------------------------------------------------

    ###
    # Create, configure and run the Express server. In most cases this should be
    # the last step of you app loading, after loading custom modules, setting
    # custom configuration, etc.
    ###
    init: -&gt;
        logger.debug &quot;App.init&quot;
        events.emit &quot;App.before.init&quot;

        nodeEnv = process.env.NODE_ENV

        # Get version from main app's package.json (NOT Expresser, but the actual app using it!)
        try
            @version = require(@expresser.rootPath + &quot;/package.json&quot;)?.version
        catch ex
            logger.error &quot;App.init&quot;, &quot;Could not fetch version from package.json.&quot;, ex

        # Configure the Express server.
        @configure()

        # Start web server!
        @start()

        events.emit &quot;App.on.init&quot;
        delete @init

    ###
    # Configure the server. Set views, options, use Express modules, etc.
    ###
    configure: -&gt;
        midBodyParser = require &quot;body-parser&quot;
        midCookieParser = require &quot;cookie-parser&quot;
        midSession = require &quot;cookie-session&quot;
        midCompression = require &quot;compression&quot;

        if settings.general.debug or nodeEnv is &quot;test&quot;
            midErrorHandler = require &quot;errorhandler&quot;

        # Create express v4 app.
        @expressApp = express()

        # DEPRECATED! The &quot;server&quot; was renamed to &quot;expressApp&quot;.
        @server = @expressApp()

        # Set view options, use Pug for HTML templates.
        @expressApp.set &quot;views&quot;, settings.app.viewPath
        @expressApp.set &quot;view engine&quot;, settings.app.viewEngine
        @expressApp.set &quot;view options&quot;, { layout: false }

        # Prepend middlewares, if any was specified.
        if @prependMiddlewares.length &gt; 0
            @expressApp.use mw for mw in @prependMiddlewares

        # Use Express basic handlers.
        @expressApp.use midBodyParser.json {limit: settings.app.bodyParser.limit}
        @expressApp.use midBodyParser.urlencoded {extended: settings.app.bodyParser.extended, limit: settings.app.bodyParser.limit}

        if settings.app.cookie.enabled
            @expressApp.use midCookieParser settings.app.cookie.secret

        if settings.app.session.enabled
            @expressApp.use midSession {secret: settings.app.session.secret, cookie: {maxAge: new Date(Date.now() + (settings.app.session.maxAge * 1000))}}

        # Use HTTP compression only if enabled on settings.
        if settings.app.compressionEnabled
            @expressApp.use midCompression

        # Fix connect assets helper context.
        connectAssetsOptions = lodash.cloneDeep settings.app.connectAssets
        connectAssetsOptions.helperContext = @expressApp.locals

        # Connect assets and dynamic compiling.
        ConnectAssets = (require &quot;./app/connect-assets.js&quot;) connectAssetsOptions
        @expressApp.use ConnectAssets

        # Append extra middlewares, if any was specified.
        if @appendMiddlewares.length &gt; 0
            @expressApp.use mw for mw in @appendMiddlewares

        # Configure development environment to dump exceptions and show stack.
        if settings.general.debug or nodeEnv is &quot;test&quot;
            @expressApp.use midErrorHandler {dumpExceptions: true, showStack: true}

        # Use Express static routing.
        @expressApp.use express.static settings.app.publicPath

        # Log all requests if debug is true.
        if settings.general.debug
            @expressApp.use @requestLogger

        # Delete!
        delete @configure

    # START AND KILL
    # --------------------------------------------------------------------------

    # Start the server using HTTP or HTTPS, depending on the settings.
    start: -&gt;
        if @webServer?
            throw new Error &quot;Server is already running on port #{settings.app.port}.&quot;

        events.emit &quot;App.before.start&quot;

        if settings.app.ssl.enabled and settings.app.ssl.keyFile? and settings.app.ssl.certFile?
            sslKeyFile = utils.io.getFilePath settings.app.ssl.keyFile
            sslCertFile = utils.io.getFilePath settings.app.ssl.certFile

            # Certificate files were found? Proceed, otherwise alert the user and throw an error.
            if sslKeyFile? and sslCertFile?
                if fs.existsSync(sslKeyFile) and fs.existsSync(sslCertFile)
                    sslKey = fs.readFileSync sslKeyFile, {encoding: settings.general.encoding}
                    sslCert = fs.readFileSync sslCertFile, {encoding: settings.general.encoding}
                    sslOptions = {key: sslKey, cert: sslCert}
                    serverRef = https.createServer sslOptions, @expressApp
                else
                    throw new Error &quot;The certificate files could not be found. Please check the 'settings.app.ssl' settings.&quot;
            else
                throw new Error &quot;SSL is enabled but no key and certificate files were defined. Please check the 'settings.app.ssl' settings.&quot;
        else
            serverRef = http.createServer @expressApp

        # Expose the web server.
        @webServer = serverRef

        # Start the app!
        if settings.app.ip? and settings.app.ip isnt &quot;&quot;
            serverRef.listen settings.app.port, settings.app.ip
            logger.info &quot;App&quot;, settings.app.title, &quot;Listening on #{settings.app.ip} port #{settings.app.port}&quot;
        else
            serverRef.listen settings.app.port
            logger.info &quot;App&quot;, settings.app.title, &quot;Listening on port #{settings.app.port}&quot;

        # Using SSL and redirector port is set? Then create the http server.
        if settings.app.ssl.enabled and settings.app.ssl.redirectorPort &gt; 0
            logger.info &quot;App&quot;, &quot;#{settings.app.title} will redirect HTTP #{settings.app.ssl.redirectorPort} to HTTPS on #{settings.app.port}.&quot;

            redirServer = express()
            redirServer.get &quot;*&quot;, (req, res) -&gt; res.redirect &quot;https://#{req.hostname}:#{settings.app.port}#{req.url}&quot;

            # Log all redirector requests if debug is true.
            if settings.general.debug
                redirServer.use @requestLogger

            @redirectorServer = http.createServer redirServer
            @redirectorServer.listen settings.app.ssl.redirectorPort

        # Pass the HTTP(s) server created to external modules.
        events.emit &quot;App.on.start&quot;, serverRef

    # Kill the underlying HTTP(S) server(s).
    kill: -&gt;
        events.emit &quot;App.before.kill&quot;

        @redirectorServer?.close()
        @redirectorServer = null

        @webServer?.close()
        webServer = null

        events.emit &quot;App.on.kill&quot;

    # HELPER AND UTILS
    # --------------------------------------------------------------------------

    ###
    # Return a collection with all routes registered on the server.
    # @param {Boolean} simple If true, returns only an array the route strings.
    # @return {Array} Collection with routes (as object or as string).
    ###
    getRoutes: (simple = false) =&gt;
        result = []

        for r in @expressApp._router.stack
            if r.route?.path? and r.route.path isnt &quot;&quot;
                if simple
                    result.push r.route.path
                else
                    result.push {route: r.route.path, methods: lodash.keys(r.route.methods)}

        return result

    # Helper to log all requests when debug is true.
    requestLogger: (req, res, next) -&gt;
        ip = utils.browser.getClientIP req
        method = req.method
        url = req.url

        console.log &quot;Request from #{ip}&quot;, method, url

        next() if next?

        return url

    # Helper to render Pug views. The request, response and view are mandatory,
    # and the options argument is optional.
    # @param {Object} req The request object.
    # @param {Object} res The response object.
    # @param {String} view The Pug filename.
    # @param {Object} options Options passed to the view, optional.
    renderView: (req, res, view, options) -&gt;
        logger.debug &quot;App.renderView&quot;, req.originalUrl, view, options

        try
            options = {} if not options?
            options.device = utils.browser.getDeviceString req
            options.title = settings.app.title if not options.title?

            # View filename must jave .pug extension.
            view += &quot;.pug&quot; if view.indexOf(&quot;.pug&quot;) &lt; 0

            # Send rendered view to client.
            res.render view, options

        catch ex
            logger.error &quot;App.renderView&quot;, view, ex
            @renderError req, res, ex

        events.emit &quot;App.on.renderView&quot;, req, res, view, options

    # Render response as human readable JSON data.
    # @param {Object} req The request object.
    # @param {Object} res The response object.
    # @param {Object} data The JSON data to be sent.
    renderJson: (req, res, data) -&gt;
        logger.debug &quot;App.renderJson&quot;, req.originalUrl, data

        if lodash.isString data
            try
                data = JSON.parse data
            catch ex
                return @renderError req, res, ex, 500

        # Remove methods from JSON before rendering.
        cleanJson = (obj) -&gt;
            if lodash.isArray obj
                cleanJson i for i in obj
            else if lodash.isObject obj
                for k, v of obj
                    if lodash.isFunction v
                        delete obj[k]
                    else
                        cleanJson v

        cleanJson data

        # Add Access-Control-Allow-Origin to all when debug is true.
        if settings.general.debug
            res.setHeader &quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;

        # Send JSON response.
        res.json data

        events.emit &quot;App.on.renderJson&quot;, req, res, data

    # Render response as image.
    # @param {Object} req The request object.
    # @param {Object} res The response object.
    # @param {String} filename The full path to the image file.
    # @param {Object} options Options passed to the image renderer, for example the &quot;mimetype&quot;.
    renderImage: (req, res, filename, options) -&gt;
        logger.debug &quot;App.renderImage&quot;, req.originalUrl, filename, options

        mimetype = options?.mimetype

        # Try to figure out the mime type in case it wasn't passed along the options.
        if not mimetype?
            extname = path.extname(filename).toLowerCase().replace(&quot;.&quot;,&quot;&quot;)
            extname = &quot;jpeg&quot; if extname is &quot;jpg&quot;
            mimetype = &quot;image/#{extname}&quot;

        # Send image to client.
        res.contentType mimetype
        res.sendFile filename

        events.emit &quot;App.on.renderImage&quot;, req, res, filename, options

    # Send error response as JSON. When the server can't return a valid result,
    # send an error response with the specified status code and error output.
    # @param {Object} req The request object.
    # @param {Object} res The response object.
    # @param {Object} error The error object or message to be sent to the client.
    # @param {Integer} status The response status code, optional, default is 500.
    renderError: (req, res, error, status) -&gt;
        logger.error &quot;App.renderError&quot;, req.originalUrl, status, error

        status = 408 if status is &quot;ETIMEDOUT&quot;

        # Set default status to 500 and stringify message if necessary.
        status = status or error?.statusCode or 500

        try
            if lodash.isError error
                error = error.message + &quot; &quot; + error.stack
            else if not lodash.isString error
                error = JSON.stringify error, null, 0
        catch ex
            error = error.toString()

        # Send error JSON to client.
        res.status(status).json {error: error, url: req.originalUrl}

        events.emit &quot;App.on.renderError&quot;, req, res, error, status

# Singleton implementation
# -----------------------------------------------------------------------------
App.getInstance = -&gt;
    @instance = new App() if not @instance?
    return @instance

# Exports
module.exports = App.getInstance()</pre></div></div></div><script src="http://code.jquery.com/jquery-1.11.0.min.js"></script><script src="../bootstrap-3.2.0-dist/js/bootstrap.min.js"></script><script src="../google-code-prettify/prettify.js"></script><script src="../script.js"></script><script src="../group-examples.js"></script><a href="#{self.github.repository}"><img class="github-ribbon" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub"></a></body></html>