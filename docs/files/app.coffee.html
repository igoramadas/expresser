<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Expresser - app.coffee</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-9331973-3"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-9331973-3');
</script><script>if (location.protocol.match(/^http/) && location.pathname.match('\.html') === null && location.pathname.slice(-1) !== '/') {
  location.href = location.href + '/';
}</script><link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script><script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]--><link href="../google-code-prettify/prettify.css" rel="stylesheet" type="text/css"><link href="../style.css" rel="stylesheet" type="text/css"></head><body data-spy="scroll" data-target=".sidebar"><nav class="navbar navbar-default navbar-fixed-top" role="navigation"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#top-navigation-collapse"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="top-navigation-collapse"><ul class="nav navbar-nav"><li><a href="../index.html">Home</a></li><li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Guides <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../guides/App.html">App</a></li><li><a href="../guides/Errors.html">Errors</a></li><li><a href="../guides/Events.html">Events</a></li><li><a href="../guides/Logger.html">Logger</a></li><li><a href="../guides/Settings.html">Settings</a></li><li><a href="../guides/Utils.html">Utils</a></li></ul></li><li><a href="../classes/index.html">Classes</a></li><li class="dropdown active"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Files - app.coffee <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../files/app.coffee.html">app.coffee</a></li><li><a href="../files/errors.coffee.html">errors.coffee</a></li><li><a href="../files/events.coffee.html">events.coffee</a></li><li><a href="../files/index.coffee.html">index.coffee</a></li><li><a href="../files/logger.coffee.html">logger.coffee</a></li><li><a href="../files/settings.coffee.html">settings.coffee</a></li><li><a href="../files/utils.coffee.html">utils.coffee</a></li><li><a href="../files/aws.dynamodb.coffee.html">aws/dynamodb.coffee</a></li><li><a href="../files/aws.index.coffee.html">aws/index.coffee</a></li><li><a href="../files/aws.s3.coffee.html">aws/s3.coffee</a></li><li><a href="../files/aws.sns.coffee.html">aws/sns.coffee</a></li><li><a href="../files/cron.index.coffee.html">cron/index.coffee</a></li><li><a href="../files/cron.job.coffee.html">cron/job.coffee</a></li><li><a href="../files/gcloud.datastore.coffee.html">gcloud/datastore.coffee</a></li><li><a href="../files/gcloud.index.coffee.html">gcloud/index.coffee</a></li><li><a href="../files/gcloud.storage.coffee.html">gcloud/storage.coffee</a></li><li><a href="../files/logger-file.index.coffee.html">logger-file/index.coffee</a></li><li><a href="../files/logger-logentries.index.coffee.html">logger-logentries/index.coffee</a></li><li><a href="../files/logger-loggly.index.coffee.html">logger-loggly/index.coffee</a></li><li><a href="../files/mailer.index.coffee.html">mailer/index.coffee</a></li><li><a href="../files/mailer.templates.coffee.html">mailer/templates.coffee</a></li><li><a href="../files/metrics.httpserver.coffee.html">metrics/httpserver.coffee</a></li><li><a href="../files/metrics.index.coffee.html">metrics/index.coffee</a></li><li><a href="../files/metrics.percentile.coffee.html">metrics/percentile.coffee</a></li><li><a href="../files/mongodb.index.coffee.html">mongodb/index.coffee</a></li><li><a href="../files/sockets.index.coffee.html">sockets/index.coffee</a></li><li><a href="../files/utils.browser.coffee.html">utils/browser.coffee</a></li><li><a href="../files/utils.data.coffee.html">utils/data.coffee</a></li><li><a href="../files/utils.io.coffee.html">utils/io.coffee</a></li><li><a href="../files/utils.network.coffee.html">utils/network.coffee</a></li><li><a href="../files/utils.system.coffee.html">utils/system.coffee</a></li></ul></li></ul><div class="options"><label class="checkbox"><input id="options-private" type="checkbox"> Private</label></div></div></div></nav><div class="container-fluid content"><div class="row"><div class="hidden-xs sidebar col-sm-3" data-spy="affix"><div class="cormo-sidenav"><div class="panel panel-default"><div class="panel-collapse collapse in" id="undefined_body"><ul class="nav nav-pills nav-stacked"><li class="active"><a href="../files/app.coffee.html">app.coffee</a></li><li><a href="../files/errors.coffee.html">errors.coffee</a></li><li><a href="../files/events.coffee.html">events.coffee</a></li><li><a href="../files/index.coffee.html">index.coffee</a></li><li><a href="../files/logger.coffee.html">logger.coffee</a></li><li><a href="../files/settings.coffee.html">settings.coffee</a></li><li><a href="../files/utils.coffee.html">utils.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#aws__body">aws/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="aws__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/aws.dynamodb.coffee.html">dynamodb.coffee</a></li><li><a href="../files/aws.index.coffee.html">index.coffee</a></li><li><a href="../files/aws.s3.coffee.html">s3.coffee</a></li><li><a href="../files/aws.sns.coffee.html">sns.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#cron__body">cron/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="cron__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/cron.index.coffee.html">index.coffee</a></li><li><a href="../files/cron.job.coffee.html">job.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#gcloud__body">gcloud/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="gcloud__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/gcloud.datastore.coffee.html">datastore.coffee</a></li><li><a href="../files/gcloud.index.coffee.html">index.coffee</a></li><li><a href="../files/gcloud.storage.coffee.html">storage.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-file__body">logger-file/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-file__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-file.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-logentries__body">logger-logentries/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-logentries__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-logentries.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-loggly__body">logger-loggly/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-loggly__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-loggly.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#mailer__body">mailer/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="mailer__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/mailer.index.coffee.html">index.coffee</a></li><li><a href="../files/mailer.templates.coffee.html">templates.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#metrics__body">metrics/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="metrics__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/metrics.httpserver.coffee.html">httpserver.coffee</a></li><li><a href="../files/metrics.index.coffee.html">index.coffee</a></li><li><a href="../files/metrics.percentile.coffee.html">percentile.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#mongodb__body">mongodb/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="mongodb__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/mongodb.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#sockets__body">sockets/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="sockets__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/sockets.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#utils__body">utils/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="utils__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/utils.browser.coffee.html">browser.coffee</a></li><li><a href="../files/utils.data.coffee.html">data.coffee</a></li><li><a href="../files/utils.io.coffee.html">io.coffee</a></li><li><a href="../files/utils.network.coffee.html">network.coffee</a></li><li><a href="../files/utils.system.coffee.html">system.coffee</a></li></ul></div></div></div></div><div class="col-sm-9 col-sm-offset-3"><section><h1>app.coffee</h1></section><pre class="prettyprint"># EXPRESSER APP
# -----------------------------------------------------------------------------
express = require &quot;express&quot;
errors = require &quot;./errors.coffee&quot;
events = require &quot;./events.coffee&quot;
fs = require &quot;fs&quot;
http = require &quot;http&quot;
https = require &quot;https&quot;
lodash = require &quot;lodash&quot;
logger = require &quot;./logger.coffee&quot;
path = require &quot;path&quot;
settings = require &quot;./settings.coffee&quot;
util = require &quot;util&quot;
utils = require &quot;./utils.coffee&quot;

nodeEnv = null

###
# This is the &quot;core&quot; of an Expresser based application. The App wraps the
# Express server and its middlewares / routes, along with a few extra helpers.
###
class App
    newInstance: -&gt; return new App()

    ##
    # Exposes the Express app object to the outside.
    # @property
    # @type express-Application
    expressApp: null

    ##
    # The underlying HTTP(S) server.
    # @property
    # @type http-Server
    webServer: null

    ##
    # The HTTP to HTTPS redirector server (only if settings.app.ssl.redirectorPort is set).
    # @property
    # @type http-Server
    redirectorServer: null

    ##
    # Additional middlewares to be used by the Express server.
    # These will be called before the default middlewares.
    # @property
    # @type Array
    prependMiddlewares: []

    ##
    # Additional middlewares to be used by the Express server.
    # These will be called after the default middlewares.
    # @property
    # @type Array
    appendMiddlewares: []

    # INIT
    # --------------------------------------------------------------------------

    ###
    # Create, configure and run the Express application. In most cases this should be
    # the last step of you app loading, after loading custom modules, setting custom
    # configuration, etc. Please note that this will be called automatically if
    # you call the main `expresser.init()`.
    ###
    init: -&gt;
        logger.debug &quot;App.init&quot;
        events.emit &quot;App.before.init&quot;

        nodeEnv = process.env.NODE_ENV

        # Get version from main app's package.json (NOT Expresser, but the actual app using it!)
        try
            if @expresser?.rootPath
                @version = require(@expresser.rootPath + &quot;/package.json&quot;)?.version
            else
                @version = require(__dirname + &quot;../../package.json&quot;)?.version
        catch ex
            logger.error &quot;App.init&quot;, &quot;Could not fetch version from package.json.&quot;, ex

        # Configure the Express server.
        @configure()

        # Start web server!
        @start()

        events.emit &quot;App.on.init&quot;
        delete @init

    ###
    # Configure the server. Set views, options, use Express modules, etc.
    # Called automatically on `init()`, so normally you should never need
    # to call `configure()` on your own.
    # @private
    ###
    configure: -&gt;
        midBodyParser = require &quot;body-parser&quot;
        midCookieParser = require &quot;cookie-parser&quot;
        midCompression = require &quot;compression&quot;
        midSession = require &quot;express-session&quot;
        memoryStore = require(&quot;memorystore&quot;) midSession

        if settings.general.debug or nodeEnv is &quot;test&quot;
            midErrorHandler = require &quot;errorhandler&quot;

        # Create express v4 app.
        @expressApp = express()

        # DEPRECATED! The &quot;server&quot; was renamed to &quot;expressApp&quot;.
        @server = @expressApp

        # BRAKING! Alert if user is still using old ./views default path for views.
        if not fs.existsSync(settings.app.viewPath)
            logger.warn &quot;Attention!&quot;, &quot;Views path not found: #{settings.app.viewPath}&quot;, &quot;Note that the default path has changed from ./views/ to ./assets/views/&quot;

        # Set view options, use Pug for HTML templates.
        @expressApp.set &quot;views&quot;, settings.app.viewPath
        @expressApp.set &quot;view engine&quot;, settings.app.viewEngine
        @expressApp.set &quot;view options&quot;, { layout: false }

        # Prepend middlewares, if any was specified.
        if @prependMiddlewares.length &gt; 0
            @expressApp.use mw for mw in @prependMiddlewares

        # Use Express basic handlers.
        @expressApp.use midBodyParser.json {limit: settings.app.bodyParser.limit}
        @expressApp.use midBodyParser.urlencoded {extended: settings.app.bodyParser.extended, limit: settings.app.bodyParser.limit}

        if settings.app.cookie.enabled
            @expressApp.use midCookieParser settings.app.cookie.secret

        if settings.app.session.enabled
            @expressApp.use midSession {store: new memoryStore(), secret: settings.app.session.secret, resave: false, saveUninitialized: false, cookie: {httpOnly: settings.app.session.httpOnly, maxAge: new Date(Date.now() + (settings.app.session.maxAge * 1000))}}

        # Use HTTP compression only if enabled on settings.
        if settings.app.compressionEnabled
            @expressApp.use midCompression

        # Fix connect assets helper context.
        connectAssetsOptions = lodash.cloneDeep settings.app.connectAssets
        connectAssetsOptions.helperContext = @expressApp.locals

        # Connect assets and dynamic compiling.
        ConnectAssets = (require &quot;./app/connect-assets.js&quot;) connectAssetsOptions
        @expressApp.use ConnectAssets

        # Append extra middlewares, if any was specified.
        if @appendMiddlewares.length &gt; 0
            @expressApp.use mw for mw in @appendMiddlewares

        # Configure development environment to dump exceptions and show stack.
        if settings.general.debug or nodeEnv is &quot;test&quot;
            @expressApp.use midErrorHandler {dumpExceptions: true, showStack: true}

        # Use Express static routing.
        @expressApp.use express.static settings.app.publicPath

        # Log all requests if debug is true.
        if settings.general.debug
            @expressApp.use (req, res, next) -&gt;
                ip = utils.browser.getClientIP req
                method = req.method
                url = req.url

                console.log &quot;Request from #{ip}&quot;, method, url

                next() if next?

                return url

        # We should not call configure more than once!
        delete @configure

    # START AND KILL
    # --------------------------------------------------------------------------

    ###
    # Start the server using HTTP or HTTPS, depending on the settings.
    ###
    start: -&gt;
        if @webServer?
            return logger.warn &quot;App.start&quot;, &quot;Application has already started (webServer is not null). Abort!&quot;

        events.emit &quot;App.before.start&quot;

        if settings.app.ssl.enabled and settings.app.ssl.keyFile? and settings.app.ssl.certFile?
            sslKeyFile = utils.io.getFilePath settings.app.ssl.keyFile
            sslCertFile = utils.io.getFilePath settings.app.ssl.certFile

            # Certificate files were found? Proceed, otherwise alert the user and throw an error.
            if sslKeyFile? and sslCertFile?
                if fs.existsSync(sslKeyFile) and fs.existsSync(sslCertFile)
                    sslKey = fs.readFileSync sslKeyFile, {encoding: settings.general.encoding}
                    sslCert = fs.readFileSync sslCertFile, {encoding: settings.general.encoding}
                    sslOptions = {key: sslKey, cert: sslCert}
                    serverRef = https.createServer sslOptions, @expressApp
                else
                    return errors.throw &quot;certificatesNotFound&quot;, &quot;Please check paths defined on settings.app.ssl.&quot;
            else
                return errors.throw &quot;certificatesNotFound&quot;, &quot;Please check paths defined on settings.app.ssl.&quot;
        else
            serverRef = http.createServer @expressApp

        # Expose the web server.
        @webServer = serverRef

        # Start the app!
        if settings.app.ip? and settings.app.ip isnt &quot;&quot;
            serverRef.listen settings.app.port, settings.app.ip
            logger.info &quot;App&quot;, settings.app.title, &quot;Listening on #{settings.app.ip} port #{settings.app.port}&quot;
        else
            serverRef.listen settings.app.port
            logger.info &quot;App&quot;, settings.app.title, &quot;Listening on port #{settings.app.port}&quot;

        # Using SSL and redirector port is set? Then create the http server.
        if settings.app.ssl.enabled and settings.app.ssl.redirectorPort &gt; 0
            logger.info &quot;App&quot;, &quot;#{settings.app.title} will redirect HTTP #{settings.app.ssl.redirectorPort} to HTTPS on #{settings.app.port}.&quot;

            redirServer = express()
            redirServer.get &quot;*&quot;, (req, res) -&gt; res.redirect &quot;https://#{req.hostname}:#{settings.app.port}#{req.url}&quot;

            # Log all redirector requests if debug is true.
            if settings.general.debug
                redirServer.use @requestLogger

            @redirectorServer = http.createServer redirServer
            @redirectorServer.listen settings.app.ssl.redirectorPort

        # Pass the HTTP(s) server created to external modules.
        events.emit &quot;App.on.start&quot;, serverRef

    ###
    # Kill the underlying HTTP(S) server(s).
    ###
    kill: -&gt;
        events.emit &quot;App.before.kill&quot;

        try
            @webServer?.close()
            @redirectorServer?.close()
        catch ex
            logger.error &quot;App.kill&quot;, ex

        webServer = null
        @redirectorServer = null

        events.emit &quot;App.on.kill&quot;

    # BRIDGED EXPRESS METHODS
    # --------------------------------------------------------------------------

    ##
    # Helper to call the Express App .all().
    all: =&gt;
        return errors.throw &quot;expressNotInit&quot; if not @expressApp?
        logger.debug &quot;App.all&quot;, util.inspect(arguments[0]), util.inspect(arguments[1])
        @expressApp.all.apply @expressApp, arguments

    ##
    # Helper to call the Express App .get().
    get: =&gt;
        return errors.throw &quot;expressNotInit&quot; if not @expressApp?
        logger.debug &quot;App.get&quot;, util.inspect(arguments[0]), util.inspect(arguments[1])
        @expressApp.get.apply @expressApp, arguments

    ##
    # Helper to call the Express App .post().
    post: =&gt;
        return errors.throw &quot;expressNotInit&quot; if not @expressApp?
        logger.debug &quot;App.post&quot;, util.inspect(arguments[0]), util.inspect(arguments[1])
        @expressApp.post.apply @expressApp, arguments

    ##
    # Helper to call the Express App .put().
    put: =&gt;
        return errors.throw &quot;expressNotInit&quot; if not @expressApp?
        logger.debug &quot;App.put&quot;, util.inspect(arguments[0]), util.inspect(arguments[1])
        @expressApp.put.apply @expressApp, arguments

    ##
    # Helper to call the Express App .patch().
    patch: =&gt;
        return errors.throw &quot;expressNotInit&quot; if not @expressApp?
        logger.debug &quot;App.patch&quot;, util.inspect(arguments[0]), util.inspect(arguments[1])
        @expressApp.patch.apply @expressApp, arguments

    ##
    # Helper to call the Express App .delete().
    delete: =&gt;
        return errors.throw &quot;expressNotInit&quot; if not @expressApp?
        logger.debug &quot;App.delete&quot;, util.inspect(arguments[0]), util.inspect(arguments[1])
        @expressApp.delete.apply @expressApp, arguments

    ##
    # Helper to call the Express App .listen().
    listen: =&gt;
        return errors.throw &quot;expressNotInit&quot; if not @expressApp?
        logger.debug &quot;App.listen&quot;, util.inspect(arguments[0]), util.inspect(arguments[1])
        @expressApp.listen.apply @expressApp, arguments

    ##
    # Helper to call the Express App .route().
    route: =&gt;
        return errors.throw &quot;expressNotInit&quot; if not @expressApp?
        logger.debug &quot;App.route&quot;, arguments[0]
        @expressApp.route.apply @expressApp, arguments

    ##
    # Helper to call the Express App .use().
    use: =&gt;
        return errors.throw &quot;expressNotInit&quot; if not @expressApp?
        logger.debug &quot;App.use&quot;, util.inspect(arguments[0]), util.inspect(arguments[1])
        @expressApp.use.apply @expressApp, arguments

    # HELPER AND UTILS
    # --------------------------------------------------------------------------

    ###
    # Return an array with all routes registered on the Express application.
    # @param {Boolean} asString If true, returns the route strings only, otherwise returns full objects.
    # @return {Array} Array with the routes (as object or as string if asString = true).
    ###
    listRoutes: (asString = false) =&gt;
        result = []

        for r in @expressApp._router.stack
            if r.route?.path? and r.route.path isnt &quot;&quot;
                if asString
                    result.push r.route.path
                else
                    result.push {route: r.route.path, methods: lodash.keys(r.route.methods)}

        return result

    ###
    # Render a Pug view and send to the client.
    # @param {Object} req The Express request object, mandatory.
    # @param {Object} res The Express response object, mandatory.
    # @param {String} view The Pug view filename, mandatory.
    # @param {Object} options Options passed to the view, optional.
    ###
    renderView: (req, res, view, options) -&gt;
        logger.debug &quot;App.renderView&quot;, req.originalUrl, view, options

        try
            options = {} if not options?
            options.device = utils.browser.getDeviceDetails req
            options.title = settings.app.title if not options.title?

            # View filename must jave .pug extension.
            view += &quot;.pug&quot; if view.indexOf(&quot;.pug&quot;) &lt; 0

            # Send rendered view to client.
            res.render view, options

        catch ex
            logger.error &quot;App.renderView&quot;, view, ex
            @renderError req, res, ex

        events.emit &quot;App.on.renderView&quot;, req, res, view, options

    ###
    # Render response as JSON data and send to the client.
    # @param {Object} req The Express request object, mandatory.
    # @param {Object} res The Express response object, mandatory.
    # @param {Object} data The JSON data to be sent, mandatory.
    ###
    renderJson: (req, res, data) -&gt;
        logger.debug &quot;App.renderJson&quot;, req.originalUrl, data

        if lodash.isString data
            try
                data = JSON.parse data
            catch ex
                return @renderError req, res, ex, 500

        # Remove methods from JSON before rendering.
        cleanJson = (obj, depth) -&gt;
            if depth &gt; settings.logger.maxDepth
                return

            if lodash.isArray obj
                for i in obj
                    cleanJson i, depth + 1
            else if lodash.isObject obj
                for k, v of obj
                    if lodash.isFunction v
                        delete obj[k]
                    else
                        cleanJson v, depth + 1

        cleanJson data, 0

        # Add Access-Control-Allow-Origin to all when debug is true.
        if settings.general.debug
            res.setHeader &quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;

        # Send JSON response.
        res.json data

        events.emit &quot;App.on.renderJson&quot;, req, res, data

    ###
    # Render an image from the speficied file, and send to the client.
    # @param {Object} req The Express request object, mandatory.
    # @param {Object} res The Express response object, mandatory.
    # @param {String} filename The full path to the image file, mandatory.
    # @param {Object} options Options passed to the image renderer, for example the &quot;mimetype&quot;.
    ###
    renderImage: (req, res, filename, options) -&gt;
        logger.debug &quot;App.renderImage&quot;, req.originalUrl, filename, options

        mimetype = options?.mimetype

        # Try to figure out the mime type in case it wasn't passed along the options.
        if not mimetype?
            extname = path.extname(filename).toLowerCase().replace(&quot;.&quot;,&quot;&quot;)
            extname = &quot;jpeg&quot; if extname is &quot;jpg&quot;
            mimetype = &quot;image/#{extname}&quot;

        # Send image to client.
        res.contentType mimetype
        res.sendFile filename

        events.emit &quot;App.on.renderImage&quot;, req, res, filename, options

    ###
    # Sends error response as JSON.
    # @param {Object} req The Express request object, mandatory.
    # @param {Object} res The Express response object, mandatory.
    # @param {Object} error The error object or message to be sent to the client, mandatory.
    # @param {Number} status The response status code, optional, default is 500.
    ###
    renderError: (req, res, error, status) -&gt;
        logger.debug &quot;App.renderError&quot;, req.originalUrl, status, error

        # Status defaults to 500.
        status = error?.statusCode or 500 if not status?
        status = 408 if status is &quot;ETIMEDOUT&quot;

        # Helper to build message out of the error object.
        getMessage = (obj) -&gt;
            msg = {}

            if lodash.isString obj
                msg.message = obj
            else
                msg.message = obj.message if obj.message?
                msg.friendlyMessage = obj.friendlyMessage if obj.friendlyMessage?
                msg.reason = obj.reason if obj.reason?
                msg.code = obj.code if obj.code?

            # Nothing taken out of error objec? Return null then.
            if lodash.keys(msg).length is 0
                return null

            return msg

        try
            message = getMessage error

            # Error might be encapsulated inside another &quot;error&quot; property.
            if not mesage? and error.error?
                message = getMessage error.error

        catch ex
            logger.error &quot;App.renderError&quot;, ex

        # Can't figure it out? Just pass error as string then.
        if not message?
            message = error.toString()

        # Send error JSON to client.
        res.status(status).json {error: message, url: req.originalUrl}

        events.emit &quot;App.on.renderError&quot;, req, res, error, status

# Singleton implementation
# -----------------------------------------------------------------------------
App.getInstance = -&gt;
    @instance = new App() if not @instance?
    return @instance

module.exports = App.getInstance()</pre></div></div></div><script src="https://code.jquery.com/jquery-3.2.1.min.js"></script><script src="../bootstrap/js/bootstrap.min.js"></script><script src="../google-code-prettify/prettify.js"></script><script src="../script.js"></script><script src="../group-examples.js"></script><a href="https://github.com/igoramadas/expresser"><img class="github-ribbon" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub"></a></body></html>