<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Expresser - downloader/index.coffee</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-9331973-3"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-9331973-3');
</script><script>if (location.protocol.match(/^http/) && location.pathname.match('\.html') === null && location.pathname.slice(-1) !== '/') {
  location.href = location.href + '/';
}</script><link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script><script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]--><link href="../google-code-prettify/prettify.css" rel="stylesheet" type="text/css"><link href="../style.css" rel="stylesheet" type="text/css"></head><body data-spy="scroll" data-target=".sidebar"><nav class="navbar navbar-default navbar-fixed-top" role="navigation"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#top-navigation-collapse"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="top-navigation-collapse"><ul class="nav navbar-nav"><li><a href="../index.html">Home</a></li><li><a href="../classes/index.html">Classes</a></li><li class="dropdown active"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Files - downloader/index.coffee <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../files/app.coffee.html">app.coffee</a></li><li><a href="../files/errors.coffee.html">errors.coffee</a></li><li><a href="../files/events.coffee.html">events.coffee</a></li><li><a href="../files/index.coffee.html">index.coffee</a></li><li><a href="../files/logger.coffee.html">logger.coffee</a></li><li><a href="../files/settings.coffee.html">settings.coffee</a></li><li><a href="../files/utils.coffee.html">utils.coffee</a></li><li><a href="../files/aws.dynamodb.coffee.html">aws/dynamodb.coffee</a></li><li><a href="../files/aws.index.coffee.html">aws/index.coffee</a></li><li><a href="../files/aws.s3.coffee.html">aws/s3.coffee</a></li><li><a href="../files/aws.sns.coffee.html">aws/sns.coffee</a></li><li><a href="../files/cron.index.coffee.html">cron/index.coffee</a></li><li><a href="../files/downloader.index.coffee.html">downloader/index.coffee</a></li><li><a href="../files/gcloud.datastore.coffee.html">gcloud/datastore.coffee</a></li><li><a href="../files/gcloud.index.coffee.html">gcloud/index.coffee</a></li><li><a href="../files/gcloud.storage.coffee.html">gcloud/storage.coffee</a></li><li><a href="../files/logger-file.index.coffee.html">logger-file/index.coffee</a></li><li><a href="../files/logger-logentries.index.coffee.html">logger-logentries/index.coffee</a></li><li><a href="../files/logger-loggly.index.coffee.html">logger-loggly/index.coffee</a></li><li><a href="../files/mailer.index.coffee.html">mailer/index.coffee</a></li><li><a href="../files/mailer.templates.coffee.html">mailer/templates.coffee</a></li><li><a href="../files/metrics.httpserver.coffee.html">metrics/httpserver.coffee</a></li><li><a href="../files/metrics.index.coffee.html">metrics/index.coffee</a></li><li><a href="../files/metrics.percentile.coffee.html">metrics/percentile.coffee</a></li><li><a href="../files/mongodb.index.coffee.html">mongodb/index.coffee</a></li><li><a href="../files/sockets.index.coffee.html">sockets/index.coffee</a></li><li><a href="../files/utils.browser.coffee.html">utils/browser.coffee</a></li><li><a href="../files/utils.data.coffee.html">utils/data.coffee</a></li><li><a href="../files/utils.io.coffee.html">utils/io.coffee</a></li><li><a href="../files/utils.network.coffee.html">utils/network.coffee</a></li><li><a href="../files/utils.system.coffee.html">utils/system.coffee</a></li></ul></li></ul><div class="options"><label class="checkbox"><input id="options-private" type="checkbox"> Private</label></div></div></div></nav><div class="container-fluid content"><div class="row"><div class="hidden-xs sidebar col-sm-3" data-spy="affix"><div class="cormo-sidenav"><div class="panel panel-default"><div class="panel-collapse collapse in" id="undefined_body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/app.coffee.html">app.coffee</a></li><li><a href="../files/errors.coffee.html">errors.coffee</a></li><li><a href="../files/events.coffee.html">events.coffee</a></li><li><a href="../files/index.coffee.html">index.coffee</a></li><li><a href="../files/logger.coffee.html">logger.coffee</a></li><li><a href="../files/settings.coffee.html">settings.coffee</a></li><li><a href="../files/utils.coffee.html">utils.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#aws__body">aws/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="aws__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/aws.dynamodb.coffee.html">dynamodb.coffee</a></li><li><a href="../files/aws.index.coffee.html">index.coffee</a></li><li><a href="../files/aws.s3.coffee.html">s3.coffee</a></li><li><a href="../files/aws.sns.coffee.html">sns.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#cron__body">cron/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="cron__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/cron.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#downloader__body">downloader/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="downloader__body"><ul class="nav nav-pills nav-stacked"><li class="active"><a href="../files/downloader.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#gcloud__body">gcloud/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="gcloud__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/gcloud.datastore.coffee.html">datastore.coffee</a></li><li><a href="../files/gcloud.index.coffee.html">index.coffee</a></li><li><a href="../files/gcloud.storage.coffee.html">storage.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-file__body">logger-file/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-file__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-file.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-logentries__body">logger-logentries/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-logentries__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-logentries.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#logger-loggly__body">logger-loggly/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="logger-loggly__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/logger-loggly.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#mailer__body">mailer/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="mailer__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/mailer.index.coffee.html">index.coffee</a></li><li><a href="../files/mailer.templates.coffee.html">templates.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#metrics__body">metrics/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="metrics__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/metrics.httpserver.coffee.html">httpserver.coffee</a></li><li><a href="../files/metrics.index.coffee.html">index.coffee</a></li><li><a href="../files/metrics.percentile.coffee.html">percentile.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#mongodb__body">mongodb/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="mongodb__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/mongodb.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#sockets__body">sockets/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="sockets__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/sockets.index.coffee.html">index.coffee</a></li></ul></div></div><div class="panel panel-default"><div class="panel-heading" data-toggle="collapse" data-target="#utils__body">utils/<span class="pull-right glyphicon"></span></div><div class="panel-collapse collapse in" id="utils__body"><ul class="nav nav-pills nav-stacked"><li><a href="../files/utils.browser.coffee.html">browser.coffee</a></li><li><a href="../files/utils.data.coffee.html">data.coffee</a></li><li><a href="../files/utils.io.coffee.html">io.coffee</a></li><li><a href="../files/utils.network.coffee.html">network.coffee</a></li><li><a href="../files/utils.system.coffee.html">system.coffee</a></li></ul></div></div></div></div><div class="col-sm-9 col-sm-offset-3"><section><h1>downloader/index.coffee</h1></section><pre class="prettyprint"># EXPRESSER DOWNLOADER
# --------------------------------------------------------------------------
# Helper to manage downloads from external sources. Supports downloading
# throttling, avoids duplicates, etc.
# &lt;!--
# @see settings.downloader
# --&gt;
class Downloader

    priority: 3

    fs = require &quot;fs&quot;
    http = require &quot;http&quot;
    https = require &quot;https&quot;
    path = require &quot;path&quot;
    url = require &quot;url&quot;

    events = null
    lodash = null
    logger = null
    moment = null
    settings = null

    # The download queue and simultaneous count.
    queue = []
    downloading = []

    # INIT
    # --------------------------------------------------------------------------

    # Init the module.
    # @param {Object} options Downloader init options.
    init: (options) -&gt;
        events = @expresser.events
        lodash = @expresser.libs.lodash
        logger = @expresser.logger
        moment = @expresser.libs.moment
        settings = @expresser.settings

        logger.debug &quot;Downloader.init&quot;, options
        events.emit &quot;Downloader.before.init&quot;

        @setEvents()

        events.emit &quot;Downloader.on.init&quot;, options
        delete @init

    # Bind events.
    setEvents: -&gt;
        events.on &quot;Downloader.download&quot;, @download
        events.on &quot;Downloader.stop&quot;, @stop

    # METHODS
    # --------------------------------------------------------------------------

    # Download an external file and save it to the specified location. The `callback`
    # has the signature (error, data). Returns the downloader object which is added
    # to the `queue`, which has the download properties and a `stop` helper to force
    # stopping it. Returns false on error or duplicate.
    # Tip: if you want to get the downloaded data without having to read the target file
    # you can get the downloaded contents via the `options.downloadedData`.
    # @param {String} remoteUrl The URL of the remote file to be downloaded.
    # @param {String} saveTo The full local path and destination filename.
    # @param {Object} options Optional, object with request options, for example auth.
    # @param {Method} callback Optional, a function (err, result) to be called when download has finished.
    # @return {Object} Returns the download job having timestamp, remoteUrl, saveTo, options, callback and stop helper.
    download: (remoteUrl, saveTo, options) -&gt;
        logger.debug &quot;Downloader.download&quot;, remoteUrl, saveTo, options

        if not settings.downloader.enabled
            return logger.notEnabled(&quot;Downloader&quot;, &quot;download&quot;)

        if not remoteUrl? or remoteUrl is &quot;&quot;
            err = new Error &quot;First parameter 'remoteUrl' is mandatory!&quot;
            logger.error &quot;Downloader.download&quot;, err
            throw err

        # Check options and callback.
        if not callback? and lodash.isFunction options
            callback = options
            options = null

        now = new Date().getTime()

        # Create the download object.
        downloadObj = {timestamp: now, remoteUrl: remoteUrl, saveTo: saveTo, options: options, callback: callback, stopFlag: false}

        # Prevent duplicates?
        if settings.downloader.preventDuplicates
            existing = lodash.find downloading, {remoteUrl: remoteUrl, saveTo: saveTo}

            # If downloading the same file and to the same location, abort download.
            if existing?.saveTo is saveTo
                logger.error &quot;Downloader.download&quot;, &quot;Aborted, already downloading.&quot;, remoteUrl, saveTo
                err = {message: &quot;Download aborted: same file is already downloading.&quot;, duplicate: true}
                callback? err, downloadObj
                return null

        # Create a `stop` method to force stop the download by setting the `stopFlag`.
        # Accepts a `keep` boolean, if true the already downloaded data will be kept on forced stop.
        stopHelper = (keep) -&gt; @stopFlag = true

        # Update download object with stop helper and add to queue.
        downloadObj.stop = stopHelper
        queue.push downloadObj

        # Start download immediatelly if not exceeding the `maxSimultaneous` setting.
        next() if downloading.length &lt; settings.downloader.maxSimultaneous

        return downloadObj

    # Force stop a current download.
    # @param {String} remoteUrl The URL of the download to stop.
    # @param {String} saveTo The full local path of the download to stop.
    # @return {Boolean} Returns true if a match was found, or false if no matching download to stop.
    stop: (remoteUrl, saveTo, keep) -&gt;
        existing = lodash.find downloading, {remoteUrl: remoteUrl, saveTo: saveTo}

        # Download exists? If so set its stop flag and return true, otherwise false.
        if existing?
            existing.stopFlag = true
            return true
        else
            return false

    # INTERNAL IMPLEMENTATION
    # --------------------------------------------------------------------------

    # Helper to remove a download from the `downloading` list.
    removeDownloading = (obj) -&gt;
        filter = {timestamp: obj.timestamp, remoteUrl: obj.remoteUrl, saveTo: obj.saveTo}
        downloading = lodash.reject downloading, filter

    # Helper function to proccess download errors.
    downloadError = (err, obj) -&gt;
        logger.debug &quot;Downloader.downloadError&quot;, err, obj
        removeDownloading obj
        next()
        obj.callback(err, obj) if obj.callback?

    # Helper function to parse the URL and get its options.
    parseUrlOptions = (obj, options) -&gt;
        if obj.redirectUrl? and obj.redirectUrl isnt &quot;&quot;
            urlInfo = url.parse obj.redirectUrl
        else
            urlInfo = url.parse obj.remoteUrl

        # Set URL options.
        options =
            host: urlInfo.hostname
            hostname: urlInfo.hostname
            port: urlInfo.port
            path: urlInfo.path

        # Check for credentials on the URL.
        if urlInfo.auth? and urlInfo.auth isnt &quot;&quot;
            options.auth = urlInfo.auth

        return options

    # Helper function to start a download request.
    reqStart = (obj, options) -&gt;
        if obj.remoteUrl.indexOf(&quot;https&quot;) is 0
            options.port = 443 if not options.port?
            httpHandler = https
        else
            httpHandler = http

        # Start the request.
        req = httpHandler.get options, (response) =&gt;

            # Downloaded contents will be appended also to the `downloadedData`
            # property of the options object.
            obj.downloadedData = &quot;&quot;

            # Set the estination temp file.
            saveToTemp = obj.saveTo + settings.downloader.tempExtension

            # If status is 301 or 302, redirect to the specified location and stop the current request.
            if response.statusCode is 301 or response.statusCode is 302

                obj.redirectUrl = response.headers.location
                options = lodash.assign options, parseUrlOptions obj
                req.end()

                reqStart obj, options

                # If status is not 200 or 304, it means something went wrong so do not proceed
                # with the download. Otherwise proceed and listen to the `data` and `end` events.
            else if response.statusCode isnt 200 and response.statusCode isnt 304

                err = {code: response.statusCode, message: &quot;Server returned an unexpected status code: #{response.statusCode}&quot;}
                downloadError err, obj

            else
                # Create the file stream with a .download extension. This will be renamed after the
                # download has finished and the file is totally written.
                fileWriter = fs.createWriteStream saveToTemp, {&quot;flags&quot;: &quot;w+&quot;}

                # Helper called response gets new data. The data will also be
                # appended to `options.data` property.
                onData = (data) -&gt;
                    if obj.stopFlag
                        req.end()
                        onEnd()
                    else
                        fileWriter.write data
                        obj.downloadedData += data

                # Helper called when response ends.
                onEnd = -&gt;
                    response.removeListener &quot;data&quot;, onData

                    fileWriter.addListener &quot;close&quot;, -&gt;

                        # Check if temp file exists.
                        tempExists = fs.existsSync saveToTemp

                        # Do not keep temporaty files!
                        if not tempExists
                            err = {message:&quot;Can't find downloaded file: #{saveToTemp}&quot;}
                        else if obj.stopFlag
                            fs.unlinkSync saveToTemp

                        # Check if destination file already exists.
                        fileExists = fs.existsSync obj.saveTo

                        # Only proceed with renaming if `stopFlag` wasn't set and destionation is valid.
                        if not obj.stopFlag
                            fs.unlinkSync obj.saveTo if fileExists
                            fs.renameSync saveToTemp, obj.saveTo if tempExists

                        # Remove from `downloading` list and proceed with the callback.
                        removeDownloading obj
                        obj.callback(err, obj) if obj.callback?

                        logger.debug &quot;Downloader.next&quot;, &quot;End&quot;, obj.remoteUrl, obj.saveTo

                    fileWriter.end()
                    fileWriter.destroySoon()
                    next()

                # Attachd response listeners.
                response.addListener &quot;data&quot;, onData
                response.addListener &quot;end&quot;, onEnd

        # Unhandled error, call the downloadError helper.
        req.on &quot;error&quot;, (err) =&gt;
            downloadError err, obj

    # Process next download.
    next = -&gt;
        return if queue.length &lt; 0

        # Get first download from queue.
        obj = queue.shift()

        # Check if download is valid.
        if not obj?
            logger.debug &quot;Downloader.next&quot;, &quot;Skip&quot;, &quot;Downloader object is invalid.&quot;
            return
        else
            logger.debug &quot;Downloader.next&quot;, obj

        # Add to downloading array.
        downloading.push obj

        if settings.downloader.headers? and settings.downloader.headers isnt &quot;&quot;
            headers = settings.web.downloaderHeaders
        else
            headers = null

        # Set and extend default options.
        options = lodash.assign {headers: headers, rejectUnauthorized: settings.downloader.rejectUnauthorized}, obj.options, parseUrlOptions(obj)

        # Start download
        if obj.stopFlag
            logger.debug &quot;Downloader.next&quot;, &quot;Skip, 'stopFlag' is #{obj.stopFlag}.&quot;, obj
            removeDownloading obj
            next()
        else
            reqStart obj, options

# Singleton implementation
# --------------------------------------------------------------------------
Downloader.getInstance = -&gt;
    @instance = new Downloader() if not @instance?
    return @instance

module.exports = exports = Downloader.getInstance()</pre></div></div></div><script src="https://code.jquery.com/jquery-3.2.1.min.js"></script><script src="../bootstrap/js/bootstrap.min.js"></script><script src="../google-code-prettify/prettify.js"></script><script src="../script.js"></script><script src="../group-examples.js"></script><a href="https://github.com/igoramadas/expresser"><img class="github-ribbon" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub"></a></body></html>