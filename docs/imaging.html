<!DOCTYPE html>

<html>
<head>
  <title>imaging.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>imaging.coffee</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="expresser.html">
                    expresser.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="app.html">
                    app.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="database.html">
                    database.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="downloader.html">
                    downloader.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="firewall.html">
                    firewall.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="imaging.html">
                    imaging.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="logger.html">
                    logger.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="mail.html">
                    mail.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="settings.html">
                    settings.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="sockets.html">
                    sockets.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="twitter.html">
                    twitter.coffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="utils.html">
                    utils.coffee
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        <h2>EXPRESSER IMAGING</h2>

        
      
        
        <p>Handles and manipulates images on the server using ImageMagick.
Parameters on <a href="settings.coffee">settings.html</a>: Settings.Logger</p>

        
          <div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Imaging</span></span></pre></div>
        
      
        
        <p>Required modules.</p>

        
          <div class='highlight'><pre>    fs = require <span class="string">"fs"</span>
    im = require <span class="string">"imagemagick"</span>
    logger = require <span class="string">"./logger.coffee"</span>
    path = require <span class="string">"path"</span>
    settings = require <span class="string">"./settings.coffee"</span></pre></div>
        
      
        
        <h2>IMAGE METHODS</h2>

        
      
        
        <p>Internal method to convert image filetypes. Image will also be resized and scale to the specified
dimensions (width and height). A callback (err, stdout) can be passed as well.</p>

        
          <div class='highlight'><pre>    <span class="function"><span class="title">convert</span></span> = (source, filetype, options, callback) =&gt;
        fs.exists source, (exists) -&gt;
            <span class="keyword">if</span> exists
                <span class="keyword">try</span>
                    callback = options <span class="keyword">if</span> <span class="keyword">typeof</span> options <span class="keyword">is</span> <span class="string">"function"</span> <span class="keyword">and</span> <span class="keyword">not</span> callback?</pre></div>
        
      
        
        <p>Create arguments for the ImageMagick <code>convert</code> command.</p>

        
          <div class='highlight'><pre>                    args = []
                    args.push source</pre></div>
        
      
        
        <p>Get proper dimensions.</p>

        
          <div class='highlight'><pre>                    size = options.size
                    width = options.width <span class="keyword">if</span> options.width?
                    height = options.height <span class="keyword">if</span> options.height?</pre></div>
        
      
        
        <p>Set size based on options.</p>

        
          <div class='highlight'><pre>                    <span class="keyword">if</span> <span class="keyword">not</span> size?
                        size = <span class="string">""</span>
                        <span class="keyword">if</span> width? <span class="keyword">and</span> width &gt; <span class="number">0</span>
                            size += width
                        <span class="keyword">if</span> height? <span class="keyword">and</span> height &gt; <span class="number">0</span>
                            size += <span class="string">"x"</span> + height</pre></div>
        
      
        
        <p>Resize?</p>

        
          <div class='highlight'><pre>                    <span class="keyword">if</span> size? <span class="keyword">and</span> size <span class="keyword">is</span> <span class="string">""</span>
                        args.push <span class="string">"-resize"</span>
                        args.push size</pre></div>
        
      
        
        <p>Set quality?</p>

        
          <div class='highlight'><pre>                    <span class="keyword">if</span> options.quality? <span class="keyword">and</span> options.quality <span class="keyword">isnt</span> <span class="string">""</span>
                        args.push <span class="string">"-quality"</span>
                        args.push options.quality</pre></div>
        
      
        
        <p>Add target filename argument.</p>

        
          <div class='highlight'><pre>                    args.push source.replace(path.extname(source), filetype)</pre></div>
        
      
        
        <p>Try converting the source to the destination filetype trigger the <code>callback</code>, if passed.</p>

        
          <div class='highlight'><pre>                    im.convert args, (err, stdout) -&gt; callback(err, stdout) <span class="keyword">if</span> callback?</pre></div>
        
      
        
        <p>Log convert action if debug is enabled.</p>

        
          <div class='highlight'><pre>                    <span class="keyword">if</span> settings.general.debug
                        logger.info <span class="string">"Expresser"</span>, <span class="string">"Imaging.convert"</span>, source, options</pre></div>
        
      
        
        <p>In case of exception, log it and pass to the <code>callback</code>.</p>

        
          <div class='highlight'><pre>                <span class="keyword">catch</span> ex
                    logger.error <span class="string">"Expresser"</span>, <span class="string">"Imaging.convert"</span>, ex
                    callback(ex, <span class="literal">false</span>) <span class="keyword">if</span> callback?

            <span class="keyword">else</span></pre></div>
        
      
        
        <p>Source file does not exist, so log the warning and trigger
the <code>callback</code> if one was passed.</p>

        
          <div class='highlight'><pre>                logger.warn <span class="string">"Expresser"</span>, <span class="string">"Imaging.convert"</span>, <span class="string">"Abort, source file does not exist."</span>, source
                callback(<span class="string">"Source file does not exist."</span>, <span class="literal">false</span>) <span class="keyword">if</span> callback?</pre></div>
        
      
        
        <p>Converts the specified image to GIF, with optional options and callback.</p>

        
          <div class='highlight'><pre>    toGif: (source, options, callback) =&gt;
        convert source, <span class="string">".gif"</span>, options, callback</pre></div>
        
      
        
        <p>Converts the specified image to JPG, with optional options and callback.</p>

        
          <div class='highlight'><pre>    toJpg: (source, options, callback) =&gt;
        convert source, <span class="string">".jpg"</span>, options, callback</pre></div>
        
      
        
        <p>Converts the specified image to PNG, with optional options and callback.</p>

        
          <div class='highlight'><pre>    toPng: (source, options, callback) =&gt;
        convert source, <span class="string">".png"</span>, options, callback</pre></div>
        
      
        
        <h2>Singleton implementation</h2>

        
      
        
        
        
          <div class='highlight'><pre>Imaging.<span class="function"><span class="title">getInstance</span></span> = -&gt;
    <span class="property">@instance</span> = <span class="keyword">new</span> Imaging() <span class="keyword">if</span> <span class="keyword">not</span> <span class="property">@instance</span>?
    <span class="keyword">return</span> <span class="property">@instance</span>

module.exports = exports = Imaging.getInstance()</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
