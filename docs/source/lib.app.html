<!DOCTYPE html>

<html>
<head>
  <title>app.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="lib.app.html">
                lib/app.coffee
              </a>
            
              
              <a class="source" href="lib.database.html">
                lib/database.coffee
              </a>
            
              
              <a class="source" href="lib.events.html">
                lib/events.coffee
              </a>
            
              
              <a class="source" href="lib.logger.html">
                lib/logger.coffee
              </a>
            
              
              <a class="source" href="lib.settings.html">
                lib/settings.coffee
              </a>
            
              
              <a class="source" href="lib.utils.html">
                lib/utils.coffee
              </a>
            
              
              <a class="source" href="plugins.cron.index.html">
                plugins/cron/index.coffee
              </a>
            
              
              <a class="source" href="plugins.database-file.index.html">
                plugins/database-file/index.coffee
              </a>
            
              
              <a class="source" href="plugins.database-mongo.index.html">
                plugins/database-mongo/index.coffee
              </a>
            
              
              <a class="source" href="plugins.downloader.index.html">
                plugins/downloader/index.coffee
              </a>
            
              
              <a class="source" href="plugins.firewall.index.html">
                plugins/firewall/index.coffee
              </a>
            
              
              <a class="source" href="plugins.logger-file.index.html">
                plugins/logger-file/index.coffee
              </a>
            
              
              <a class="source" href="plugins.logger-logentries.index.html">
                plugins/logger-logentries/index.coffee
              </a>
            
              
              <a class="source" href="plugins.logger-loggly.index.html">
                plugins/logger-loggly/index.coffee
              </a>
            
              
              <a class="source" href="plugins.mailer.index.html">
                plugins/mailer/index.coffee
              </a>
            
              
              <a class="source" href="plugins.sockets.index.html">
                plugins/sockets/index.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>app.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="expresser-app">EXPRESSER APP</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>The Express server. By default it will run on HTTP port 8080
<!--
@see settings.app
--></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">App</span></span>

    express = <span class="hljs-built_in">require</span> <span class="hljs-string">"express"</span>
    fs = <span class="hljs-built_in">require</span> <span class="hljs-string">"fs"</span>
    http = <span class="hljs-built_in">require</span> <span class="hljs-string">"http"</span>
    https = <span class="hljs-built_in">require</span> <span class="hljs-string">"https"</span>
    lodash = <span class="hljs-built_in">require</span> <span class="hljs-string">"lodash"</span>
    net = <span class="hljs-built_in">require</span> <span class="hljs-string">"net"</span>
    path = <span class="hljs-built_in">require</span> <span class="hljs-string">"path"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Current node environment and HTTP server handler are set on init.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    nodeEnv = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Internal modules will be set on <code>init</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    firewall = <span class="hljs-literal">null</span>
    logger = <span class="hljs-literal">null</span>
    settings = <span class="hljs-literal">null</span>
    sockets = <span class="hljs-literal">null</span>
    utils = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>@property {Object} Exposes the Express HTTP or HTTPS <code>server</code> object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    server: <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>@property [Array<Object>] Array of additional middlewares to be used
by the Express server. These will be called before anything is processed,
so should be used for things that need immediate processing
(firewall, for example).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    prependMiddlewares: []</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>@property [Array<Object>] Array of additional middlewares to be used
by the Express server. Please note that if you’re adding middlewares
manually you must do it BEFORE calling <code>init</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    appendMiddlewares: []</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h2 id="init">INIT</h2>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Init the Express server. Firewall and Sockets modules will be
used only if available and enabled on the settings.
@param {Object} options App init options. If passed as an array, assume it’s the array with extra middlewares.
@option options {Array} appendMiddlewares Array with extra middlewares to be loaded.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    init: <span class="hljs-function"><span class="hljs-params">(options)</span> =&gt;</span>
        <span class="hljs-keyword">if</span> lodash.isArray options
            options = {appendMiddlewares: options}
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options?
            options = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Load settings and utils.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        settings = <span class="hljs-built_in">require</span> <span class="hljs-string">"./settings.coffee"</span>
        utils = <span class="hljs-built_in">require</span> <span class="hljs-string">"./utils.coffee"</span>
        nodeEnv = process.env.NODE_ENV</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Set default error handler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        @setErrorHandler()</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Require logger.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        logger = <span class="hljs-built_in">require</span> <span class="hljs-string">"./logger.coffee"</span>
        logger.debug <span class="hljs-string">"App"</span>, <span class="hljs-string">"init"</span>, options</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Configure Express server and start server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        @configureServer options
        @startServer()</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Log process termination to the console. This will force flush any buffered logs to disk.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setErrorHandler: <span class="hljs-function">=&gt;</span>
        process.<span class="hljs-literal">on</span> <span class="hljs-string">"exit"</span>, <span class="hljs-function"><span class="hljs-params">(sig)</span> -&gt;</span>
            <span class="hljs-built_in">console</span>.warn <span class="hljs-string">"App"</span>, <span class="hljs-string">"Terminating Expresser app..."</span>, Date(Date.now()), sig

            <span class="hljs-keyword">try</span>
                logger.flushLocal()
            <span class="hljs-keyword">catch</span> ex
                <span class="hljs-built_in">console</span>.warn <span class="hljs-string">"App"</span>, <span class="hljs-string">"Could not flush buffered logs to disk."</span>, ex.message</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Configure the server. Set views, options, use Express modules, etc.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    configureServer: <span class="hljs-function"><span class="hljs-params">(options)</span> =&gt;</span>
        midBodyParser = <span class="hljs-built_in">require</span> <span class="hljs-string">"body-parser"</span>
        midCookieParser = <span class="hljs-built_in">require</span> <span class="hljs-string">"cookie-parser"</span>
        midSession = <span class="hljs-built_in">require</span> <span class="hljs-string">"cookie-session"</span>
        midCompression = <span class="hljs-built_in">require</span> <span class="hljs-string">"compression"</span>

        <span class="hljs-keyword">if</span> nodeEnv <span class="hljs-keyword">is</span> <span class="hljs-string">"development"</span>
            midErrorHandler = <span class="hljs-built_in">require</span> <span class="hljs-string">"errorhandler"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Create express v4 app.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        @server = express()

        settings.updateFromPaaS() <span class="hljs-keyword">if</span> settings.app.paas</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Set view options, use Jade for HTML templates.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        @server.set <span class="hljs-string">"views"</span>, settings.path.viewsDir
        @server.set <span class="hljs-string">"view engine"</span>, settings.app.viewEngine
        @server.set <span class="hljs-string">"view options"</span>, { layout: <span class="hljs-literal">false</span> }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Check for extra middlewares to be added before any other middlewares.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> options.prependMiddlewares?
            <span class="hljs-keyword">if</span> lodash.isArray options.prependMiddlewares
                @prependMiddlewares.push mw <span class="hljs-keyword">for</span> mw <span class="hljs-keyword">in</span> options.prependMiddlewares
            <span class="hljs-keyword">else</span>
                @prependMiddlewares.push options.prependMiddlewares</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Prepend middlewares, if any was specified.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> @prependMiddlewares.length &gt; <span class="hljs-number">0</span>
            @server.use mw <span class="hljs-keyword">for</span> mw <span class="hljs-keyword">in</span> @prependMiddlewares</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Enable firewall?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> settings.firewall?.enabled
            firewall = <span class="hljs-built_in">require</span> <span class="hljs-string">"./firewall.coffee"</span>
            firewall.bind @server</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Use Express basic handlers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        @server.use midBodyParser.json {limit: settings.app.bodyParser.limit}
        @server.use midBodyParser.urlencoded {extended: settings.app.bodyParser.extended, limit: settings.app.bodyParser.limit}
        @server.use midCookieParser settings.app.cookieSecret <span class="hljs-keyword">if</span> settings.app.cookieEnabled
        @server.use midSession {secret: settings.app.sessionSecret} <span class="hljs-keyword">if</span> settings.app.sessionEnabled</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Use HTTP compression only if enabled on settings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        @server.use midCompression <span class="hljs-keyword">if</span> settings.app.compressionEnabled</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Fix connect assets helper context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        connectAssetsOptions = lodash.cloneDeep settings.app.connectAssets
        connectAssetsOptions.helperContext = @server.locals</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Connect assets and dynamic compiling.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ConnectAssets = (<span class="hljs-built_in">require</span> <span class="hljs-string">"connect-assets"</span>) connectAssetsOptions
        @server.use ConnectAssets</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Check for extra middlewares to be added.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> options.appendMiddlewares?
            <span class="hljs-keyword">if</span> lodash.isArray options.appendMiddlewares
                @appendMiddlewares.push mw <span class="hljs-keyword">for</span> mw <span class="hljs-keyword">in</span> options.appendMiddlewares
            <span class="hljs-keyword">else</span>
                @appendMiddlewares.push options.appendMiddlewares</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Add more middlewares, if any (for example passport for authentication).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> @appendMiddlewares.length &gt; <span class="hljs-number">0</span>
            @server.use mw <span class="hljs-keyword">for</span> mw <span class="hljs-keyword">in</span> @appendMiddlewares</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Configure development environment to dump exceptions and show stack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> nodeEnv <span class="hljs-keyword">is</span> <span class="hljs-string">"development"</span>
            @server.use midErrorHandler {dumpExceptions: <span class="hljs-literal">true</span>, showStack: <span class="hljs-literal">true</span>}</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Use Express static routing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        @server.use express.static settings.path.publicDir</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>If debug is on, log requests to the console.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> settings.general.debug
            @server.use (req, res, next) =&gt;
                ip = utils.getClientIP req
                method = req.method
                url = req.url</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Check if request flash is present before logging.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> req.flash? <span class="hljs-keyword">and</span> lodash.isFunction req.flash
                    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Request from <span class="hljs-subst">#{ip}</span>"</span>, method, url, req.flash()
                <span class="hljs-keyword">else</span>
                    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Request from <span class="hljs-subst">#{ip}</span>"</span>, method, url
                next() <span class="hljs-keyword">if</span> next?</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Start the server using HTTP or HTTPS, depending on the settings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    startServer: <span class="hljs-function">=&gt;</span>
        <span class="hljs-keyword">if</span> settings.app.ssl.enabled <span class="hljs-keyword">and</span> settings.app.ssl.keyFile? <span class="hljs-keyword">and</span> settings.app.ssl.certFile?
            sslKeyFile = utils.getFilePath settings.app.ssl.keyFile
            sslCertFile = utils.getFilePath settings.app.ssl.certFile</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Certificate files were found? Proceed, otherwise alert the user and throw an error.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> sslKeyFile? <span class="hljs-keyword">and</span> sslCertFile?
                <span class="hljs-keyword">if</span> fs.existsSync(sslKeyFile) <span class="hljs-keyword">and</span> fs.existsSync(sslCertFile)
                    sslKey = fs.readFileSync sslKeyFile, {encoding: settings.general.encoding}
                    sslCert = fs.readFileSync sslCertFile, {encoding: settings.general.encoding}
                    sslOptions = {key: sslKey, cert: sslCert}
                    server = https.createServer sslOptions, @server
                <span class="hljs-keyword">else</span>
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"The certificate files could not be found. Please check the 'settings.app.ssl' settings."</span>
            <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"SSL is enabled but no key and certificate files were defined. Please check the 'settings.app.ssl' settings."</span>
        <span class="hljs-keyword">else</span>
            server = http.createServer @server</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Enable sockets?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> settings.sockets?.enabled
            sockets = @expresser.sockets
            sockets.bind server

        <span class="hljs-keyword">if</span> settings.app.ip? <span class="hljs-keyword">and</span> settings.app.ip <span class="hljs-keyword">isnt</span> <span class="hljs-string">""</span>
            server.listen settings.app.port, settings.app.ip
            logger.info <span class="hljs-string">"App"</span>, settings.app.title, <span class="hljs-string">"Listening on <span class="hljs-subst">#{settings.app.ip}</span> port <span class="hljs-subst">#{settings.app.port}</span>"</span>
        <span class="hljs-keyword">else</span>
            server.listen settings.app.port
            logger.info <span class="hljs-string">"App"</span>, settings.app.title, <span class="hljs-string">"Listening on port <span class="hljs-subst">#{settings.app.port}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Using SSL and redirector port is set? Then create the http server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> settings.app.ssl.enabled <span class="hljs-keyword">and</span> settings.app.ssl.redirectorPort &gt; <span class="hljs-number">0</span>
            logger.info <span class="hljs-string">"App"</span>, <span class="hljs-string">"<span class="hljs-subst">#{settings.app.title}</span> will redirect HTTP <span class="hljs-subst">#{settings.app.ssl.redirectorPort}</span> to HTTPS on <span class="hljs-subst">#{settings.app.port}</span>."</span>

            redirServer = express()
            redirServer.get <span class="hljs-string">"*"</span>, <span class="hljs-function"><span class="hljs-params">(req, res)</span> -&gt;</span> res.redirect <span class="hljs-string">"https://<span class="hljs-subst">#{req.hostname}</span>:<span class="hljs-subst">#{settings.app.port}</span><span class="hljs-subst">#{req.url}</span>"</span>

            @redirectorServer = http.createServer redirServer
            @redirectorServer.listen settings.app.ssl.redirectorPort</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h2 id="helper-and-utils">HELPER AND UTILS</h2>

            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Helper to render Jade views. The request, response and view are mandatory,
and the options argument is optional.
@param {Object} req The request object.
@param {Object} res The response object.
@param {String} view The Jade filename.
@param {Object} options Options passed to the view, optional.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    renderView: <span class="hljs-function"><span class="hljs-params">(req, res, view, options)</span> =&gt;</span>
        options = {} <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options?
        options.device = utils.getClientDevice req
        options.title = settings.app.title <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.title?</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>View filename must jave .jade extension.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        view += <span class="hljs-string">".jade"</span> <span class="hljs-keyword">if</span> view.indexOf(<span class="hljs-string">".jade"</span>) &lt; <span class="hljs-number">0</span>

        res.render view, options

        logger.debug <span class="hljs-string">"App.renderView"</span>, req.originalUrl, view, options</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Render response as human readable JSON data.
@param {Object} req The request object.
@param {Object} res The response object.
@param {Object} data The JSON data to be sent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    renderJson: <span class="hljs-function"><span class="hljs-params">(req, res, data)</span> =&gt;</span>
        <span class="hljs-keyword">if</span> lodash.isString data
            <span class="hljs-keyword">try</span>
                data = JSON.parse data
            <span class="hljs-keyword">catch</span> ex
                <span class="hljs-keyword">return</span> @renderError req, res, ex, <span class="hljs-number">500</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Remove methods from JSON before rendering.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">        <span class="hljs-title">cleanJson</span> = <span class="hljs-params">(obj)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> lodash.isArray obj
                cleanJson i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> obj
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> lodash.isObject obj
                <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
                    <span class="hljs-keyword">if</span> lodash.isFunction v
                        <span class="hljs-keyword">delete</span> obj[k]
                    <span class="hljs-keyword">else</span>
                        cleanJson v

        cleanJson data</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Add Access-Control-Allow-Origin to all when debug is true.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> settings.general.debug
            res.setHeader <span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Send JSON response.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res.json data

        logger.debug <span class="hljs-string">"App.renderJson"</span>, req.originalUrl, data</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Render response as image.
@param {Object} req The request object.
@param {Object} res The response object.
@param {String} filename The full path to the image file.
@param {Object} options Options passed to the image renderer, for example the “mimetype”.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    renderImage: <span class="hljs-function"><span class="hljs-params">(req, res, filename, options)</span> -&gt;</span>
        mimetype = options?.mimetype</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Try to figure out the mime type in case it wasn’t passed along the options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> mimetype?
            extname = path.extname(filename).toLowerCase().replace(<span class="hljs-string">"."</span>,<span class="hljs-string">""</span>)
            extname = <span class="hljs-string">"jpeg"</span> <span class="hljs-keyword">if</span> extname <span class="hljs-keyword">is</span> <span class="hljs-string">"jpg"</span>
            mimetype = <span class="hljs-string">"image/<span class="hljs-subst">#{extname}</span>"</span>

        res.contentType mimetype
        res.sendFile filename

        logger.debug <span class="hljs-string">"App.renderImage"</span>, req.originalUrl, filename, options</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Send error response as JSON. When the server can’t return a valid result,
send an error response with the specified status code and error output.
@param {Object} req The request object.
@param {Object} res The response object.
@param {Object} error The error object or message to be sent to the client.
@param {Integer} status The response status code, optional, default is 500.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    renderError: <span class="hljs-function"><span class="hljs-params">(req, res, error, status)</span> =&gt;</span>
        status = <span class="hljs-number">408</span> <span class="hljs-keyword">if</span> status <span class="hljs-keyword">is</span> <span class="hljs-string">"ETIMEDOUT"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Set default status to 500 and stringify message if necessary.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        status = status <span class="hljs-keyword">or</span> err?.statusCode <span class="hljs-keyword">or</span> <span class="hljs-number">500</span>
        error = JSON.stringify err <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> lodash.isString error

        res.status status
        res.json {error: error, url: req.originalUrl}

        logger.error <span class="hljs-string">"App.renderError"</span>, req.originalUrl, status, error</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <h2 id="singleton-implementation">Singleton implementation</h2>

            </div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>App.getInstance = <span class="hljs-function">-&gt;</span>
    @instance = <span class="hljs-keyword">new</span> App() <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @instance?
    <span class="hljs-keyword">return</span> @instance

<span class="hljs-built_in">module</span>.exports = exports = App.getInstance()</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
