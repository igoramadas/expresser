<!DOCTYPE html>

<html>
<head>
  <title>index.coffee - Docs</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="lib.app.html">
                lib/app.coffee
              </a>
            
              
              <a class="source" href="lib.database.html">
                lib/database.coffee
              </a>
            
              
              <a class="source" href="lib.events.html">
                lib/events.coffee
              </a>
            
              
              <a class="source" href="lib.logger.html">
                lib/logger.coffee
              </a>
            
              
              <a class="source" href="lib.settings.html">
                lib/settings.coffee
              </a>
            
              
              <a class="source" href="lib.utils.html">
                lib/utils.coffee
              </a>
            
              
              <a class="source" href="plugins.cron.index.html">
                plugins/cron/index.coffee
              </a>
            
              
              <a class="source" href="plugins.database-mongodb.index.html">
                plugins/database-mongodb/index.coffee
              </a>
            
              
              <a class="source" href="plugins.database-tingodb.index.html">
                plugins/database-tingodb/index.coffee
              </a>
            
              
              <a class="source" href="plugins.downloader.index.html">
                plugins/downloader/index.coffee
              </a>
            
              
              <a class="source" href="plugins.logger-file.index.html">
                plugins/logger-file/index.coffee
              </a>
            
              
              <a class="source" href="plugins.logger-logentries.index.html">
                plugins/logger-logentries/index.coffee
              </a>
            
              
              <a class="source" href="plugins.logger-loggly.index.html">
                plugins/logger-loggly/index.coffee
              </a>
            
              
              <a class="source" href="plugins.mailer.index.html">
                plugins/mailer/index.coffee
              </a>
            
              
              <a class="source" href="plugins.paas.index.html">
                plugins/paas/index.coffee
              </a>
            
              
              <a class="source" href="plugins.sockets.index.html">
                plugins/sockets/index.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>index.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="expresser-cron">EXPRESSER CRON</h2>
<p>Handle scheduled cron jobs. You can use intervals (seconds) or specific
times to trigger jobs, and the module will take care of setting the proper timers.
Jobs are added using “job” objects with id, schedule, callback and other options.</p>
<!--
@example Sample job object, alerts user every minute (60 seconds).
  var myJob = {
    id: "alertJob",
    schedule: 60,
    callback: function(job) { alertUser(mydata); }
  }
@example Sample job object, sends email every day at 10AM and 5PM.
  var otherJob = {
    id: "my mail job",
    schedule: ["10:00:00", "17:00:00"],
    callback: function(job) { mail.send(something); }
  }

This module will load scheduled tasks from the "cron.json" file if the
setting `loadOnInit` is true.

@see settings.cron
-->

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cron</span></span>

    events = <span class="hljs-literal">null</span>
    fs = <span class="hljs-built_in">require</span> <span class="hljs-string">"fs"</span>
    lodash = <span class="hljs-literal">null</span>
    logger = <span class="hljs-literal">null</span>
    moment = <span class="hljs-literal">null</span>
    path = <span class="hljs-built_in">require</span> <span class="hljs-string">"path"</span>
    settings = <span class="hljs-literal">null</span>
    utils = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>@property {Array} The jobs collection, please do not edit this object manually!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    jobs: []</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="init">INIT</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Init the cron manager. If <code>loadOnInit</code> setting is true, the `cron.json
file will be parsed and loaded straight away (if there’s one).
@param {Object} options Cron init options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    init: <span class="hljs-function"><span class="hljs-params">(options)</span> =&gt;</span>
        events = @expresser.events
        lodash = @expresser.libs.lodash
        logger = @expresser.logger
        moment = @expresser.libs.moment
        settings = @expresser.settings
        utils = @expresser.utils

        logger.debug <span class="hljs-string">"Cron.init"</span>, options

        options = {} <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options?
        options = lodash.defaultsDeep options, settings.cron

        @setEvents()
        @load <span class="hljs-literal">true</span>, options <span class="hljs-keyword">if</span> options.loadOnInit

        events.emit <span class="hljs-string">"Cron.on.init"</span>, options</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Bind events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setEvents: <span class="hljs-function">=&gt;</span>
        events.<span class="hljs-literal">on</span> <span class="hljs-string">"Cron.start"</span>, @start
        events.<span class="hljs-literal">on</span> <span class="hljs-string">"Cron.stop"</span>, @stop
        events.<span class="hljs-literal">on</span> <span class="hljs-string">"Cron.add"</span>, @add
        events.<span class="hljs-literal">on</span> <span class="hljs-string">"Cron.remove"</span>, @remove</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Load jobs from the specified (default cron.json) file.
If <code>autoStart</code> is true, it will automatically call the <code>start</code> method after loading.
@param {String} filename Path to the JSON file containing jobs, optional, default is “cron.json”.
@param {Object} options Options to be passed when loading cron jobs.
@option options {String} basePath Sets the base path of modules when requiring them.
@option options {Boolean} autoStart If true, call “start” after loading.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    load: <span class="hljs-function"><span class="hljs-params">(filename, options)</span> =&gt;</span>
        logger.debug <span class="hljs-string">"Cron.load"</span>, filename, options</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Set default options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        options = {} <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options?
        options = lodash.defaults options, {autoStart: <span class="hljs-literal">false</span>, basePath: <span class="hljs-string">""</span>}

        <span class="hljs-keyword">if</span> lodash.isBoolean filename
            filename = <span class="hljs-literal">false</span>
            options.autoStart = filename

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> filename? <span class="hljs-keyword">or</span> filename <span class="hljs-keyword">is</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">or</span> filename <span class="hljs-keyword">is</span> <span class="hljs-string">""</span>
            filename = <span class="hljs-string">"cron.json"</span>
            doNotWarn = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Get full path to the passed json file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        filepath = utils.getFilePath filename</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Found the cron json file? Read it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> filepath?
            basename = path.basename filepath
            cronJson = <span class="hljs-string">""</span>

            <span class="hljs-keyword">try</span>
                cronJson = fs.readFileSync filepath, {encoding: settings.general.encoding}
                cronJson = utils.minifyJson cronJson
            <span class="hljs-keyword">catch</span> ex
                err = <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Could not parse <span class="hljs-subst">#{filepath}</span> as JSON. <span class="hljs-subst">#{ex.name}</span> <span class="hljs-subst">#{ex.message}</span>"</span>
                logger.error <span class="hljs-string">"Cron.load"</span>, err
                <span class="hljs-keyword">throw</span> err</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Iterate jobs, but do not add if job’s <code>enabled</code> is false.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> key, data <span class="hljs-keyword">of</span> cronJson
                <span class="hljs-built_in">module</span> = <span class="hljs-built_in">require</span>(path.dirname(<span class="hljs-built_in">require</span>.main.filename) + <span class="hljs-string">"/"</span> + options.basePath + key)</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Only proceed if the cronDisabled flag is not present on the module.
If no ID is set for the job, use module key + callback name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">module</span>.cronDisabled <span class="hljs-keyword">isnt</span> <span class="hljs-literal">true</span>
                    <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> data
                        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> d.enabled? <span class="hljs-keyword">or</span> d.enabled
                            cb = <span class="hljs-built_in">module</span>[d.callback]
                            job = d
                            job.<span class="hljs-built_in">module</span> = key
                            job.id = key + <span class="hljs-string">"."</span> + d.callback <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> job.id?
                            job.callback = cb
                            job.timer = <span class="hljs-literal">null</span>
                            @add job
                        <span class="hljs-keyword">else</span>
                            logger.debug <span class="hljs-string">"Cron.load"</span>, filename, key, d.callback, <span class="hljs-string">"Job 'enabled' is false. Skip!"</span>
                <span class="hljs-keyword">else</span>
                    logger.debug <span class="hljs-string">"Cron.load"</span>, filename, <span class="hljs-string">"Module has 'cronDisabled' set. Skip!"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Start all jobs automatically if <code>autoStart</code> is true.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            @start() <span class="hljs-keyword">if</span> options.autoStart

            logger.info <span class="hljs-string">"Cron.load"</span>, <span class="hljs-string">"<span class="hljs-subst">#{basename}</span> loaded."</span>, options
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> doNotWarn
            logger.warn <span class="hljs-string">"Cron.load"</span>, <span class="hljs-string">"<span class="hljs-subst">#{basename}</span> not found."</span>, options</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h2 id="methods">METHODS</h2>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Start the specified cron job. If no <code>id</code> is specified, all jobs will be started.
A filter can also be passed as an object. For example to start all jobs for
the module “email”, use start({module: “email”}).
@param {String} idOrFilter The job id or filter, optional (if not specified, start everything).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    start: <span class="hljs-function"><span class="hljs-params">(idOrFilter)</span> =&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> idOrFilter?
            logger.info <span class="hljs-string">"Cron.start"</span>, <span class="hljs-string">"All jobs"</span>
            arr = @jobs
        <span class="hljs-keyword">if</span> lodash.isString idOrFilter <span class="hljs-keyword">or</span> lodash.isNumber idOrFilter
            logger.info <span class="hljs-string">"Cron.start"</span>, idOrFilter
            arr = lodash.find @jobs, {id: idOrFilter.toString()}
        <span class="hljs-keyword">else</span>
            logger.info <span class="hljs-string">"Cron.start"</span>, idOrFilter
            arr = lodash.find @jobs, idOrFilter

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> arr? <span class="hljs-keyword">or</span> arr.length &lt; <span class="hljs-number">1</span>
            logger.debug <span class="hljs-string">"Cron.start"</span>, <span class="hljs-string">"Job <span class="hljs-subst">#{idOrFilter}</span> does not exist. Abort!"</span>
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">for</span> job <span class="hljs-keyword">in</span> arr
                clearTimeout job.timer <span class="hljs-keyword">if</span> job.timer?
                setTimer job</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Stop the specified cron job. If no <code>id</code> is specified, all jobs will be stopped.
A filter can also be passed as an object. For example to stop all jobs for
the module “mymodule”, use stop({module: “mymodule”}).
@param {String} idOrFilter The job id or filter, optional (if not specified, stop everything).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    stop: <span class="hljs-function"><span class="hljs-params">(idOrFilter)</span> =&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> idOrFilter?
            logger.info <span class="hljs-string">"Cron.stop"</span>, <span class="hljs-string">"All jobs"</span>
            arr = @jobs
        <span class="hljs-keyword">if</span> lodash.isString idOrFilter <span class="hljs-keyword">or</span> lodash.isNumber idOrFilter
            logger.info <span class="hljs-string">"Cron.stop"</span>, idOrFilter
            arr = lodash.find @jobs, {id: idOrFilter.toString()}
        <span class="hljs-keyword">else</span>
            logger.info <span class="hljs-string">"Cron.stop"</span>, idOrFilter
            arr = lodash.find @jobs, idOrFilter

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> arr? <span class="hljs-keyword">or</span> arr.length &lt; <span class="hljs-number">1</span>
            logger.debug <span class="hljs-string">"Cron.stop"</span>, <span class="hljs-string">"Job <span class="hljs-subst">#{idOrFilter}</span> does not exist. Abort!"</span>
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">for</span> job <span class="hljs-keyword">in</span> arr
                clearTimeout job.timer <span class="hljs-keyword">if</span> job.timer?
                job.timer = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Add a scheduled job to the cron, passing an <code>id</code> and <code>job</code>.
You can also pass only the <code>job</code> if it has an id property.
@param {String} id The job ID, optional, overrides job.id in case it has one.
@param {Object} job The job object.
@option job {String} id The job ID, optional.
@option job [Integer, Array] schedule If a number assume it’s the interval in seconds, otherwise a times array.
@option job {Method} callback The callback (job) to be triggered.
@option job {Boolean} once If true, the job will be triggered only once no matter which schedule it has.
@return {Object} Returns {error, job}, where job is the job object and error is the error message (if any).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    add: <span class="hljs-function"><span class="hljs-params">(job)</span> =&gt;</span>
        logger.debug <span class="hljs-string">"Cron.add"</span>, job</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Throw error if no <code>id</code> was provided.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> job.id? <span class="hljs-keyword">or</span> job.id <span class="hljs-keyword">is</span> <span class="hljs-string">""</span>
            err = Error <span class="hljs-string">"Job must have an ID. Please set the job.id property."</span>
            logger.error <span class="hljs-string">"Cron.add"</span>, err
            <span class="hljs-keyword">throw</span> err</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Throw error if job callback is not a valid function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> lodash.isFunction job.callback
            err = <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Job <span class="hljs-subst">#{job.id}</span> callback is not a valid, please set job.callback as a valid Function."</span>
            logger.error <span class="hljs-string">"Cron.add"</span>, err
            <span class="hljs-keyword">throw</span> err</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Find existing job.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        existing = lodash.find @jobs, {id: job.id}</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Handle existing jobs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> existing?
            <span class="hljs-keyword">if</span> settings.cron.allowReplacing
                clearTimeout existing.timer <span class="hljs-keyword">if</span> existing.timer?
                existing.timer = <span class="hljs-literal">null</span>
            <span class="hljs-keyword">else</span>
                errorMsg = <span class="hljs-string">"Job <span class="hljs-subst">#{job.id}</span> already exists and 'allowReplacing' is false. Abort!"</span>
                logger.error <span class="hljs-string">"Cron.add"</span>, errorMsg
                <span class="hljs-keyword">return</span> {error: errorMsg}</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Set <code>startTime</code> and <code>endTime</code> if not set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        job.startTime = moment <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> job.startTime?
        job.endTime = moment <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> job.endTime?</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Only create the timer if <code>autoStart</code> is not false, add to the jobs list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        setTimer job <span class="hljs-keyword">if</span> job.autoStart <span class="hljs-keyword">isnt</span> <span class="hljs-literal">false</span>
        @jobs.push job

        <span class="hljs-keyword">return</span> {job: job}</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Remove and stop a current job. If job does not exist, a warning will be logged.
@param {String} id The job ID.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    remove: <span class="hljs-function"><span class="hljs-params">(id)</span> =&gt;</span>
        existing = lodash.find @jobs, {id: id}</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Job exists?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> existing?
            logger.debug <span class="hljs-string">"Cron.remove"</span>, <span class="hljs-string">"Job <span class="hljs-subst">#{id}</span> does not exist. Abort!"</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Clear timer and remove job from array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        clearTimeout existing.timer <span class="hljs-keyword">if</span> existing.timer?
        @jobs.splice existing</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h2 id="helpers">HELPERS</h2>

            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Helper to get the timeout value (ms) to the next job callback.
@private</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">    <span class="hljs-title">getTimeout</span> = <span class="hljs-params">(job)</span> -&gt;</span>
        now = moment()
        nextDate = moment()</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>If <code>schedule</code> is not an array, parse it as integer / seconds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> lodash.isNumber job.schedule <span class="hljs-keyword">or</span> lodash.isString job.schedule
            timeout = moment().add(job.schedule, <span class="hljs-string">"s"</span>).valueOf() - now.valueOf()
        <span class="hljs-keyword">else</span>
            minTime = <span class="hljs-string">"99:99:99"</span>
            nextTime = <span class="hljs-string">"99:99:99"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Get the next and minimum times from <code>schedule</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> sc <span class="hljs-keyword">in</span> job.schedule
                minTime = sc <span class="hljs-keyword">if</span> sc &lt; minTime
                nextTime = sc <span class="hljs-keyword">if</span> sc &lt; nextTime <span class="hljs-keyword">and</span> sc &gt; nextDate.format(<span class="hljs-string">"HH:mm:ss"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>If no times were found for today then set for tomorrow, minimum time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> nextTime <span class="hljs-keyword">is</span> <span class="hljs-string">"99:99:99"</span>
                nextDate = nextDate.add <span class="hljs-number">1</span>, <span class="hljs-string">"d"</span>
                nextTime = minTime</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Return the timeout.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            arr = nextTime.split <span class="hljs-string">":"</span>
            dateValue = [nextDate.year(), nextDate.month(), nextDate.date(), parseInt(arr[<span class="hljs-number">0</span>]), parseInt(arr[<span class="hljs-number">1</span>]), parseInt(arr[<span class="hljs-number">2</span>])]
            timeout = moment(dateValue).valueOf() - now.valueOf()

        <span class="hljs-keyword">return</span> timeout</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Helper to prepare and get a job callback function.
@private</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">    <span class="hljs-title">getCallback</span> = <span class="hljs-params">(job)</span> -&gt;</span><span class="hljs-function">
        <span class="hljs-title">callback</span> = -&gt;</span>
            logger.debug <span class="hljs-string">"Cron"</span>, <span class="hljs-string">"Job <span class="hljs-subst">#{job.id}</span> trigger."</span>
            job.timer = <span class="hljs-literal">null</span>
            job.startTime = moment()
            job.endTime = moment()

            <span class="hljs-keyword">try</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>The parameters can be force set using “params”.
If not present, pass the job itself to the callback instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> job.params
                    job.callback.apply job.callback, job.params
                <span class="hljs-keyword">else</span>
                    job.callback job</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Job end time should be set on the callback, but if it wasn’t, we force set it here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                job.endTime = moment() <span class="hljs-keyword">if</span> job.startTime <span class="hljs-keyword">is</span> job.endTime
            <span class="hljs-keyword">catch</span> ex
                logger.error <span class="hljs-string">"Cron.getCallback"</span>, <span class="hljs-string">"Could not run job."</span>, ex.message, ex.stack</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Only reset timer if once is not true.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            setTimer job <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> job.once</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Return generated callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> callback</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Helper to get a timer / interval based on the defined options.
@private</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">    <span class="hljs-title">setTimer</span> = <span class="hljs-params">(job)</span> -&gt;</span>
        logger.debug <span class="hljs-string">"Cron.setTimer"</span>, job.id, job.description, job.schedule

        callback = getCallback job</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Get the correct schedule / timeout value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        schedule = job.schedule
        schedule = moment.duration(schedule).asMilliseconds() <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> lodash.isNumber schedule</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Make sure timer is not running.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        clearTimeout job.timer <span class="hljs-keyword">if</span> job.timer?</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Set the timeout based on the defined schedule.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        timeout = getTimeout job
        job.timer = setTimeout callback, timeout
        job.nextRun = moment().add timeout, <span class="hljs-string">"ms"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <h2 id="singleton-implementation-">Singleton implementation.</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>Cron.getInstance = <span class="hljs-function">-&gt;</span>
    @instance = <span class="hljs-keyword">new</span> Cron() <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @instance?
    <span class="hljs-keyword">return</span> @instance

<span class="hljs-built_in">module</span>.exports = exports = Cron.getInstance()</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
