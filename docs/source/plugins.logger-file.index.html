<!DOCTYPE html>

<html>
<head>
  <title>index.coffee - Docs</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="lib.app.html">
                lib/app.coffee
              </a>
            
              
              <a class="source" href="lib.database.html">
                lib/database.coffee
              </a>
            
              
              <a class="source" href="lib.events.html">
                lib/events.coffee
              </a>
            
              
              <a class="source" href="lib.logger.html">
                lib/logger.coffee
              </a>
            
              
              <a class="source" href="lib.settings.html">
                lib/settings.coffee
              </a>
            
              
              <a class="source" href="lib.utils.html">
                lib/utils.coffee
              </a>
            
              
              <a class="source" href="plugins.cron.index.html">
                plugins/cron/index.coffee
              </a>
            
              
              <a class="source" href="plugins.database-mongodb.index.html">
                plugins/database-mongodb/index.coffee
              </a>
            
              
              <a class="source" href="plugins.database-tingodb.index.html">
                plugins/database-tingodb/index.coffee
              </a>
            
              
              <a class="source" href="plugins.downloader.index.html">
                plugins/downloader/index.coffee
              </a>
            
              
              <a class="source" href="plugins.logger-file.index.html">
                plugins/logger-file/index.coffee
              </a>
            
              
              <a class="source" href="plugins.logger-logentries.index.html">
                plugins/logger-logentries/index.coffee
              </a>
            
              
              <a class="source" href="plugins.logger-loggly.index.html">
                plugins/logger-loggly/index.coffee
              </a>
            
              
              <a class="source" href="plugins.mailer.index.html">
                plugins/mailer/index.coffee
              </a>
            
              
              <a class="source" href="plugins.paas.index.html">
                plugins/paas/index.coffee
              </a>
            
              
              <a class="source" href="plugins.sockets.index.html">
                plugins/sockets/index.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>index.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="expresser-logger-file">EXPRESSER LOGGER - FILE</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>File logging plugin for Expresser. Supports saving directly to the disk
using one file per log type per day, and includes auto cleaning features.
<!--
@see settings.logger.file
--></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoggerFile</span></span>

    events = <span class="hljs-literal">null</span>
    fs = <span class="hljs-built_in">require</span> <span class="hljs-string">"fs"</span>
    lodash = <span class="hljs-literal">null</span>
    logger = <span class="hljs-literal">null</span>
    moment = <span class="hljs-literal">null</span>
    path = <span class="hljs-built_in">require</span> <span class="hljs-string">"path"</span>
    settings = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="init">INIT</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Init the File module. Verify which services are set, and add the necessary transports.
IP address and timestamp will be appended to logs depending on the settings.
@param {Object} options File init options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    init: <span class="hljs-function">=&gt;</span>
        events = @expresser.events
        lodash = @expresser.libs.lodash
        logger = @expresser.logger
        moment = @expresser.libs.moment
        settings = @expresser.settings

        logger.drivers.file = <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Auto register as “file” if a default path is defined on the settings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> settings.logger.file.enabled <span class="hljs-keyword">and</span> settings.logger.file.path?
            result = logger.register <span class="hljs-string">"file"</span>, <span class="hljs-string">"file"</span>, settings.logger.file

        events.emit <span class="hljs-string">"LoggerFile.on.init"</span>
        
        <span class="hljs-keyword">return</span> result</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Get the file transport object.
@param {Object} options File logging options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    getTransport: <span class="hljs-function"><span class="hljs-params">(options)</span> =&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options?.path? <span class="hljs-keyword">or</span> options.path <span class="hljs-keyword">is</span> <span class="hljs-string">""</span>
            err = <span class="hljs-keyword">new</span> Error <span class="hljs-string">"The options.path is mandatory! Please specify a valid path to the logs folder."</span>
            logger.error <span class="hljs-string">"LoggerFile.getTransport"</span>, err, options
            <span class="hljs-keyword">throw</span> err

        options = lodash.defaultsDeep options, settings.logger.file
        options.onLogSuccess = logger.onLogSuccess <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.onLogSuccess?
        options.onLogError = logger.onLogError <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.onLogError?</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Create logs folder if it doesn’t exist.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        folderExists = fs.existsSync options.path</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Make sure the log folder exists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> folderExists
            fs.mkdirSync options.path
            <span class="hljs-keyword">if</span> settings.general.debug
                <span class="hljs-built_in">console</span>.log <span class="hljs-string">"LoggerFile.getTransport"</span>, <span class="hljs-string">"Created <span class="hljs-subst">#{options.path}</span> folder."</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Set local buffer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        transport = {flushing: <span class="hljs-literal">false</span>, buffer: {}, flush: @flush, clean: @clean}
        transport.onLogSuccess = options.onLogSuccess
        transport.onLogError = options.onLogError
        transport.bufferDispatcher = setInterval transport.flush, options.bufferInterval</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Check the maxAge of local logs and set up auto clean.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> options.maxAge? <span class="hljs-keyword">and</span> options.maxAge &gt; <span class="hljs-number">0</span>
            transport.timerCleanLocal = setInterval transport.clean, options.bufferInterval * <span class="hljs-number">20</span>

        <span class="hljs-keyword">return</span> transport</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2 id="log-methods">LOG METHODS</h2>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Log locally. The path is defined on <code>Settings.Path.logsDir</code>.
@param {String} logType The log type (info, warn, error, debug, etc).
@param {Array} args Array or string to be logged.
@param {Boolean} avoidConsole If true it will NOT log to the console.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    log: <span class="hljs-function"><span class="hljs-params">(logType, args, avoidConsole)</span> -&gt;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> settings.logger.levels.indexOf(logType) &lt; <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Get message out of the arguments if not a string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> lodash.isString args
            message = args
        <span class="hljs-keyword">else</span>
            message = logger.getMessage args</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Set log props and send to buffer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        now = moment()
        message = now.format(<span class="hljs-string">"HH:mm:ss.SSS"</span>) + <span class="hljs-string">" - "</span> + message

        @buffer[logType] = [] <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @buffer[logType]?
        @buffer[logType].push message</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Log to the console depending on <code>console</code> setting.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> settings.logger.<span class="hljs-built_in">console</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> avoidConsole
            logger.<span class="hljs-built_in">console</span> logType, args</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Flush all local buffered log messages to disk. This is usually called by the <code>bufferDispatcher</code> timer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    flush: <span class="hljs-function">-&gt;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> @flushing</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Set flushing and get current date.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        @flushing = <span class="hljs-literal">true</span>
        now = moment()
        date = now.format settings.logger.file.dateFormat</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Flush all buffered logs to disk. Please note that messages from the last seconds of the previous day
can be saved to the current day depending on how long it takes for the bufferDispatcher to run.
Default is every 10 seconds, so messages from 23:59:50 onwards could be saved on the next day.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> key, logs <span class="hljs-keyword">of</span> @buffer
            <span class="hljs-keyword">if</span> logs.length &gt; <span class="hljs-number">0</span>
                writeData = logs.join <span class="hljs-string">"\n"</span>
                filePath = path.join settings.logger.file.path, <span class="hljs-string">"<span class="hljs-subst">#{date}</span>.<span class="hljs-subst">#{key}</span>.log"</span>
                successMsg = <span class="hljs-string">"<span class="hljs-subst">#{logs.length}</span> records logged to disk."</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Reset this local buffer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                @buffer[key] = []</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Only use <code>appendFile</code> on new versions of Node.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> fs.appendFile?
                    fs.appendFile filePath, <span class="hljs-string">"\n"</span> + writeData, <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
                        @flushing = <span class="hljs-literal">false</span>

                        <span class="hljs-keyword">if</span> err?
                            <span class="hljs-built_in">console</span>.error <span class="hljs-string">"LoggerFile.flush"</span>, err
                            @onLogError? err
                        <span class="hljs-keyword">else</span>
                            @onLogSuccess? successMsg

                        events.emit <span class="hljs-string">"LoggerFile.on.flush"</span>, <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Delete old log files from disk. The maximum date is taken from the settings
if not passed.
@param {Integer} maxAge Max age of logs, in days.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    clean: <span class="hljs-function"><span class="hljs-params">(maxAge)</span> =&gt;</span>
        maxAge = settings.logger.file.maxAge <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> maxAge?
        maxDate = moment().subtract maxAge, <span class="hljs-string">"d"</span>

        fs.readdir settings.logger.file.path, <span class="hljs-function"><span class="hljs-params">(err, files)</span> =&gt;</span>
            <span class="hljs-keyword">if</span> err?
                <span class="hljs-built_in">console</span>.error <span class="hljs-string">"LoggerFile.clean"</span>, err
            <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files
                    date = moment f.split(<span class="hljs-string">"."</span>)[<span class="hljs-number">0</span>], settings.logger.file.dateFormat
                    <span class="hljs-keyword">if</span> date.isSameOrBefore maxDate
                        fs.unlinkSync path.join(settings.logger.file.path, f)

                events.emit <span class="hljs-string">"LoggerFile.on.clean"</span>, <span class="hljs-keyword">this</span>, maxAge</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h2 id="singleton-implementation">Singleton implementation</h2>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>LoggerFile.getInstance = <span class="hljs-function">-&gt;</span>
    @instance = <span class="hljs-keyword">new</span> LoggerFile() <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @instance?
    <span class="hljs-keyword">return</span> @instance

<span class="hljs-built_in">module</span>.exports = exports = LoggerFile.getInstance()</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
