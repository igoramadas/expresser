<!DOCTYPE html>

<html>
<head>
  <title>index.coffee - Docs</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="lib.app.html">
                lib/app.coffee
              </a>
            
              
              <a class="source" href="lib.database.html">
                lib/database.coffee
              </a>
            
              
              <a class="source" href="lib.events.html">
                lib/events.coffee
              </a>
            
              
              <a class="source" href="lib.logger.html">
                lib/logger.coffee
              </a>
            
              
              <a class="source" href="lib.settings.html">
                lib/settings.coffee
              </a>
            
              
              <a class="source" href="lib.utils.html">
                lib/utils.coffee
              </a>
            
              
              <a class="source" href="plugins.cron.index.html">
                plugins/cron/index.coffee
              </a>
            
              
              <a class="source" href="plugins.database-mongodb.index.html">
                plugins/database-mongodb/index.coffee
              </a>
            
              
              <a class="source" href="plugins.database-tingodb.index.html">
                plugins/database-tingodb/index.coffee
              </a>
            
              
              <a class="source" href="plugins.downloader.index.html">
                plugins/downloader/index.coffee
              </a>
            
              
              <a class="source" href="plugins.logger-file.index.html">
                plugins/logger-file/index.coffee
              </a>
            
              
              <a class="source" href="plugins.logger-logentries.index.html">
                plugins/logger-logentries/index.coffee
              </a>
            
              
              <a class="source" href="plugins.logger-loggly.index.html">
                plugins/logger-loggly/index.coffee
              </a>
            
              
              <a class="source" href="plugins.mailer.index.html">
                plugins/mailer/index.coffee
              </a>
            
              
              <a class="source" href="plugins.metrics.httpserver.html">
                plugins/metrics/httpserver.coffee
              </a>
            
              
              <a class="source" href="plugins.metrics.index.html">
                plugins/metrics/index.coffee
              </a>
            
              
              <a class="source" href="plugins.metrics.percentile.html">
                plugins/metrics/percentile.coffee
              </a>
            
              
              <a class="source" href="plugins.paas.index.html">
                plugins/paas/index.coffee
              </a>
            
              
              <a class="source" href="plugins.sockets.index.html">
                plugins/sockets/index.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>index.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="expresser-mailer">EXPRESSER MAILER</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Sends and manages emails, with template and tags replacement support.
When parsing templates, the tags should be wrapped with normal brackets {}.
Example: {contents}
The base message template (which is loaded with every single sent message)
must be saved as base.html, under the /emailtemplates folder (or whatever
folder / base file name you have set on the settings).
<!--
@see settings.mailer
--></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Mailer</span></span>

    events = <span class="hljs-literal">null</span>
    fs = <span class="hljs-built_in">require</span> <span class="hljs-string">"fs"</span>
    lodash = <span class="hljs-literal">null</span>
    logger = <span class="hljs-literal">null</span>
    moment = <span class="hljs-literal">null</span>
    nodemailer = <span class="hljs-built_in">require</span> <span class="hljs-string">"nodemailer"</span>
    path = <span class="hljs-built_in">require</span> <span class="hljs-string">"path"</span>
    settings = <span class="hljs-literal">null</span>
    utils = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>SMTP objects will be instantiated on <code>init</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    smtp: <span class="hljs-literal">null</span>
    smtp2: <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Templates cache to avoid disk reads.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    templateCache = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="init">INIT</h2>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Init the Mailer module and create the SMTP objects.
@param {Object} options Mailer init options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    init: <span class="hljs-function"><span class="hljs-params">(options)</span> =&gt;</span>
        events = @expresser.events
        lodash = @expresser.libs.lodash
        logger = @expresser.logger
        moment = @expresser.libs.moment
        settings = @expresser.settings
        utils = @expresser.utils

        logger.debug <span class="hljs-string">"Mailer.init"</span>, options
        events.emit <span class="hljs-string">"Mailer.before.init"</span>

        options = {} <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options?
        options = lodash.defaultsDeep options, settings.mailer</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Define default primary SMTP.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> options.smtp.service? <span class="hljs-keyword">and</span> options.smtp.service <span class="hljs-keyword">isnt</span> <span class="hljs-string">""</span>
            @setSmtp options.smtp, <span class="hljs-literal">false</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> options.smtp.host? <span class="hljs-keyword">and</span> options.smtp.host <span class="hljs-keyword">isnt</span> <span class="hljs-string">""</span> <span class="hljs-keyword">and</span> options.smtp.port &gt; <span class="hljs-number">0</span>
            @setSmtp options.smtp, <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Define default secondary SMTP.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> options.smtp2.service? <span class="hljs-keyword">and</span> options.smtp2.service <span class="hljs-keyword">isnt</span> <span class="hljs-string">""</span>
            @setSmtp options.smtp2, <span class="hljs-literal">true</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> options.smtp2.host? <span class="hljs-keyword">and</span> options.smtp2.host <span class="hljs-keyword">isnt</span> <span class="hljs-string">""</span> <span class="hljs-keyword">and</span> options.smtp2.port &gt; <span class="hljs-number">0</span>
            @setSmtp options.smtp2, <span class="hljs-literal">true</span>

        @setEvents()

        events.emit <span class="hljs-string">"Mailer.on.init"</span>, options</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Bind event listeners.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setEvents: <span class="hljs-function">=&gt;</span>
        events.<span class="hljs-literal">on</span> <span class="hljs-string">"Mailer.send"</span>, @send</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="outbound">OUTBOUND</h2>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Sends an email to the specified address. A callback can be specified, having (err, result).
@param {String} options The email message options
@option options {String} body The email body in text or HTML.
@option options {String} subject The email subject.
@option options {String} to The “to” address.
@option options {String} from The “from” address, optional, if blank use default from settings.
@option options {String} template The template file to be loaded, optional.
@param {Method} callback Callback (err, result) when message is sent or fails.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    send: <span class="hljs-function"><span class="hljs-params">(options, callback)</span> =&gt;</span>
        logger.debug <span class="hljs-string">"Mailer.send"</span>, options</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Get passed SMTP servers or the default ones.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        smtp = options.smtp <span class="hljs-keyword">or</span> @smtp
        smtp2 = options.smtp2 <span class="hljs-keyword">or</span> @smtp2</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Check if SMTP server is set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> smtp? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> smtp2?
            err = <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Default SMTP transports were not initiated and nothing was passed on options.smtp."</span>
            logger.error <span class="hljs-string">"Mailer.send"</span>, err, options
            <span class="hljs-keyword">throw</span> err</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Make sure “to” address is valid.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.to? <span class="hljs-keyword">or</span> options.to <span class="hljs-keyword">is</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">or</span> options.to <span class="hljs-keyword">is</span> <span class="hljs-string">""</span>
            err = <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Option 'to' is mandatory and cannot be empty."</span>
            logger.error <span class="hljs-string">"Mailer.send"</span>, err, options
            <span class="hljs-keyword">throw</span> err</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Set from to default address if no <code>to</code> was set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        options.<span class="hljs-keyword">from</span> = <span class="hljs-string">"<span class="hljs-subst">#{settings.app.title}</span> &lt;<span class="hljs-subst">#{settings.mailer.<span class="hljs-keyword">from</span>}</span>&gt;"</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.<span class="hljs-keyword">from</span>?</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Set HTML to body, if passed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        html = <span class="hljs-keyword">if</span> options.body? <span class="hljs-keyword">then</span> options.body.toString() <span class="hljs-keyword">else</span> <span class="hljs-string">""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>If to is an array, make it a string separated by commas.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> lodash.isArray options.to
            options.to = options.to.join <span class="hljs-string">", "</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Get the name of recipient based on the <code>to</code> option.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> options.to.indexOf(<span class="hljs-string">"&lt;"</span>) &lt; <span class="hljs-number">3</span>
            toName = options.to
        <span class="hljs-keyword">else</span>
            toName = options.to.substring <span class="hljs-number">0</span>, options.to.indexOf(<span class="hljs-string">"&lt;"</span>) - <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Load template if a <code>template</code> was passed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> options.template? <span class="hljs-keyword">and</span> options.template <span class="hljs-keyword">isnt</span> <span class="hljs-string">""</span>
            template = @getTemplate options.template
            html = @parseTemplate template, {contents: html}</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Parse template keywords if a <code>keywords</code> was passed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> lodash.isObject options.keywords
                html = @parseTemplate html, options.keywords</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Parse final template and set it on the <code>options</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        html = @parseTemplate html, {to: toName, appTitle: settings.app.title, appUrl: settings.app.url}
        options.html = html</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Check if <code>doNotSend</code> flag is set, and if so, do not send anything.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> settings.mailer.doNotSend
            <span class="hljs-keyword">return</span> callback <span class="hljs-literal">null</span>, <span class="hljs-string">"The 'doNotSend' setting is true, will not send anything!"</span> <span class="hljs-keyword">if</span> callback?</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Send using the main SMTP. If failed and a secondary is also set, try using the secondary.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        smtpSend smtp, options, <span class="hljs-function"><span class="hljs-params">(err, result)</span> =&gt;</span>
            <span class="hljs-keyword">if</span> err?
                <span class="hljs-keyword">if</span> smtp2?
                    smtpSend smtp2, options, <span class="hljs-function"><span class="hljs-params">(err2, result2)</span> -&gt;</span> callback err2, result2
                <span class="hljs-keyword">else</span>
                    callback err, result <span class="hljs-keyword">if</span> callback?
            <span class="hljs-keyword">else</span>
                callback err, result <span class="hljs-keyword">if</span> callback?</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h2 id="templates">TEMPLATES</h2>

            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Load and return the specified template. Get from the cache or from the disk
if it wasn’t loaded yet. Templates are stored inside the <code>/emailtemplates</code>
folder by default and should have a .html extension. The base template,
which is always loaded first, should be called base.html by default.
The contents will be inserted on the {contents} tag.
@param {String} name The template name, without .html.
@return {String} The template HTML.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    getTemplate: <span class="hljs-function"><span class="hljs-params">(name)</span> =&gt;</span>
        name = name.toString()
        name = name.replace(<span class="hljs-string">".html"</span>, <span class="hljs-string">""</span>) <span class="hljs-keyword">if</span> name.indexOf(<span class="hljs-string">".html"</span>)

        cached = templateCache[name]</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Is it already cached? If so do not hit the disk.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> cached? <span class="hljs-keyword">and</span> cached.expires &gt; moment()
            logger.debug <span class="hljs-string">"Mailer.getTemplate"</span>, name, <span class="hljs-string">"Loaded from cache."</span>
            <span class="hljs-keyword">return</span> templateCache[name].template
        <span class="hljs-keyword">else</span>
            logger.debug <span class="hljs-string">"Mailer.getTemplate"</span>, name</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Set file system reading options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        readOptions = {encoding: settings.general.encoding}
        baseFile = utils.getFilePath path.join(settings.mailer.templatesPath, settings.mailer.baseTemplateFile)
        templateFile = utils.getFilePath path.join(settings.mailer.templatesPath, <span class="hljs-string">"<span class="hljs-subst">#{name}</span>.html"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Read base and <code>name</code> template and merge them together.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        base = fs.readFileSync baseFile, readOptions
        template = fs.readFileSync templateFile, readOptions
        result = @parseTemplate base, {contents: template}</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Save to cache.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        templateCache[name] = {}
        templateCache[name].template = result
        templateCache[name].expires = moment().add settings.general.ioCacheTimeout, <span class="hljs-string">"s"</span>

        <span class="hljs-keyword">return</span> result</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Parse the specified template to replace keywords. The <code>keywords</code> is a set of key-values
to be replaced. For example if keywords is <code>{id: 1, friendlyUrl: &quot;abc&quot;}</code> then the tags
<code>{id}</code> and <code>{friendlyUrl}</code> will be replaced with the values 1 and abc.
@param {String} template The template (its value, not its name!) to be parsed.
@param {Object} keywords Object with keys to be replaced with its values.
@return {String} The parsed template, keywords replaced with values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    parseTemplate: <span class="hljs-function"><span class="hljs-params">(template, keywords)</span> =&gt;</span>
        logger.debug <span class="hljs-string">"Mailer.parseTemplate"</span>, template, keywords

        template = template.toString()

        <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> keywords
            template = template.replace <span class="hljs-keyword">new</span> RegExp(<span class="hljs-string">"\\{<span class="hljs-subst">#{key}</span>\\}"</span>, <span class="hljs-string">"gi"</span>), value

        <span class="hljs-keyword">return</span> template</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <h2 id="smtp-helper-methods">SMTP HELPER METHODS</h2>

            </div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Helper to send emails using the specified transport and options.
This is NOT exposed to external modules.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">    <span class="hljs-title">smtpSend</span> = <span class="hljs-params">(transport, options, callback)</span> -&gt;</span>
        <span class="hljs-keyword">try</span>
            transport.sendMail options, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
                logger.debug <span class="hljs-string">"Mailer.smtpSend"</span>, <span class="hljs-string">"OK"</span>, transport.host, options.subject, <span class="hljs-string">"to <span class="hljs-subst">#{options.to}</span>"</span>, <span class="hljs-string">"from <span class="hljs-subst">#{options.<span class="hljs-keyword">from</span>}</span>."</span>
                callback err, result
        <span class="hljs-keyword">catch</span> ex
            callback ex</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Helper to create a SMTP object.
@param {Object} options Options like service, host and port, username, password etc.
@return {Object} A Nodemailer SMTP transport object, or null if a problem was found.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    createSmtp: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
        logger.debug <span class="hljs-string">"Mailer.createSmtp"</span>, options

        options.debug = settings.general.debug <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.debug?
        options.secureConnection = options.secure <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.secureConnection?
        dkim = options.dkim <span class="hljs-keyword">or</span> settings.mailer.dkim</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Make sure auth is properly set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.auth? <span class="hljs-keyword">and</span> options.user? <span class="hljs-keyword">and</span> options.password?
            options.auth = {user: options.user, pass: options.password}
            <span class="hljs-keyword">delete</span> options[<span class="hljs-string">"user"</span>]
            <span class="hljs-keyword">delete</span> options[<span class="hljs-string">"password"</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Set the correct SMTP details based on the options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        result = nodemailer.createTransport options</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Sign using DKIM?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> dkim.domainName? <span class="hljs-keyword">and</span> dkim.privateKey?
            result.useDKIM dkim

        <span class="hljs-keyword">return</span> result</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Use the specified options and create a new SMTP server.
@param {Object} options Options to be passed to SMTP creator.
@param {Boolean} secondary If false set as the main SMTP server, if true set as secondary.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setSmtp: <span class="hljs-function"><span class="hljs-params">(options, secondary)</span> =&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> secondary <span class="hljs-keyword">or</span> secondary &lt; <span class="hljs-number">1</span>
            @smtp = @createSmtp options
        <span class="hljs-keyword">else</span>
            @smtp2 = @createSmtp options</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <h2 id="cache-methods">CACHE METHODS</h2>

            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Force clear the templates cache.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    clearCache: <span class="hljs-function">=&gt;</span>
        count = Object.keys(templateCache).length
        templateCache = {}
        logger.info <span class="hljs-string">"Mailer.clearCache"</span>, <span class="hljs-string">"Cleared <span class="hljs-subst">#{count}</span> templates."</span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h2 id="singleton-implementation">Singleton implementation</h2>

            </div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>Mailer.getInstance = <span class="hljs-function">-&gt;</span>
    @instance = <span class="hljs-keyword">new</span> Mailer() <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @instance?
    <span class="hljs-keyword">return</span> @instance

<span class="hljs-built_in">module</span>.exports = exports = Mailer.getInstance()</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
